[#components-longhorn]
= Longhorn
:experimental:

ifdef::env-github[]
:imagesdir: ../images/
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

Longhorn is a lightweight, reliable and user-friendly distributed block storage system designed for Kubernetes.
As an open source project, Longhorn was initially developed by Rancher Labs and is currently incubated under the CNCF.

== Prerequisites

If you are following this guide, it assumes that you have the following already available:

* At least one host with SLE Micro 5.5 installed; this can be physical or virtual
* A Kubernetes cluster installed; either K3s or RKE2
* Helm

== Manual installation of Longhorn

=== Installing Open-iSCSI

A core requirement of deploying and using Longhorn is the installation of the `open-iscsi` package and the `iscsid` daemon running on all Kubernetes nodes.
This is necessary, since Longhorn relies on `iscsiadm` on the host to provide persistent volumes to Kubernetes.

Let's install it:

[,shell]
----
transactional-update pkg install open-iscsi
----

It is important to note that once the operation is completed, the package is only installed into a new snapshot as SLE Micro is an immutable operating system.
In order to load it and for the `iscsid` daemon to start running, we must reboot into that new snapshot that we just created.
Issue the reboot command when you are ready:

[,shell]
----
reboot
----

[TIP]
====
For additional help installing open-iscsi, refer to the https://longhorn.io/docs/1.6.0/deploy/install/#installing-open-iscsi[official Longhorn documentation].
====

=== Installing Longhorn

There are several ways to install Longhorn on your Kubernetes clusters.
This guide will follow through the Helm installation, however feel free to follow the https://longhorn.io/docs/1.6.0/deploy/install/[official documentation] if another approach is desired.

. Add the Longhorn Helm repository:
+
[,shell]
----
helm repo add longhorn https://charts.longhorn.io
----
+
. Fetch the latest charts from the repository:
+
[,shell]
----
helm repo update
----
+
. Install Longhorn in the longhorn-system namespace:
+
[,shell]
----
helm install longhorn longhorn/longhorn --namespace longhorn-system --create-namespace --version 1.6.0
----
+
. Confirm that the deployment succeeded:
+
[,shell]
----
kubectl -n longhorn-system get pods
----
+
[,console]
----
localhost:~ # kubectl -n longhorn-system get pod
NAMESPACE         NAME                                                READY   STATUS      RESTARTS        AGE
longhorn-system   longhorn-ui-5fc9fb76db-z5dc9                        1/1     Running     0               90s
longhorn-system   longhorn-ui-5fc9fb76db-dcb65                        1/1     Running     0               90s
longhorn-system   longhorn-manager-wts2v                              1/1     Running     1 (77s ago)     90s
longhorn-system   longhorn-driver-deployer-5d4f79ddd-fxgcs            1/1     Running     0               90s
longhorn-system   instance-manager-a9bf65a7808a1acd6616bcd4c03d925b   1/1     Running     0               70s
longhorn-system   engine-image-ei-acb7590c-htqmp                      1/1     Running     0               70s
longhorn-system   csi-attacher-5c4bfdcf59-j8xww                       1/1     Running     0               50s
longhorn-system   csi-provisioner-667796df57-l69vh                    1/1     Running     0               50s
longhorn-system   csi-attacher-5c4bfdcf59-xgd5z                       1/1     Running     0               50s
longhorn-system   csi-provisioner-667796df57-dqkfr                    1/1     Running     0               50s
longhorn-system   csi-attacher-5c4bfdcf59-wckt8                       1/1     Running     0               50s
longhorn-system   csi-resizer-694f8f5f64-7n2kq                        1/1     Running     0               50s
longhorn-system   csi-snapshotter-959b69d4b-rp4gk                     1/1     Running     0               50s
longhorn-system   csi-resizer-694f8f5f64-r6ljc                        1/1     Running     0               50s
longhorn-system   csi-resizer-694f8f5f64-k7429                        1/1     Running     0               50s
longhorn-system   csi-snapshotter-959b69d4b-5k8pg                     1/1     Running     0               50s
longhorn-system   csi-provisioner-667796df57-n5w9s                    1/1     Running     0               50s
longhorn-system   csi-snapshotter-959b69d4b-x7b7t                     1/1     Running     0               50s
longhorn-system   longhorn-csi-plugin-bsc8c                           3/3     Running     0               50s
----

== Creating Longhorn volumes

Longhorn utilizes Kubernetes resources called `StorageClass` in order to automatically provision `PersistentVolume` objects for pods.
Think of `StorageClass` as a way for administrators to describe the _classes_ or _profiles_ of storage they offer.

Let's create a `StorageClass` with some default options:

[,shell]
----
kubectl apply -f - <<EOF
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: longhorn
provisioner: driver.longhorn.io
allowVolumeExpansion: true
parameters:
  numberOfReplicas: "3"
  staleReplicaTimeout: "2880" # 48 hours in minutes
  fromBackup: ""
  fsType: "ext4"
EOF
----

Now that we have our `StorageClass` in place, we need a `PersistentVolumeClaim` referencing it.
A `PersistentVolumeClaim` (PVC) is a request for storage by a user. PVCs consume `PersistentVolume` resources.
Claims can request specific sizes and access modes (e.g., they can be mounted once read/write or many times read-only).

Let's create a `PersistentVolumeClaim`:

[,shell]
----
kubectl apply -f - <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: longhorn-volv-pvc
  namespace: longhorn-system
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn
  resources:
    requests:
      storage: 2Gi
EOF
----

That's it! Once we have the `PersistentVolumeClaim` created, we can proceed with attaching it to a `Pod`.
When the `Pod` is deployed, Kubernetes creates the Longhorn volume and binds it to the `Pod` if storage is available.

[,shell]
----
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: volume-test
  namespace: longhorn-system
spec:
  containers:
  - name: volume-test
    image: nginx:stable-alpine
    imagePullPolicy: IfNotPresent
    volumeMounts:
    - name: volv
      mountPath: /data
    ports:
    - containerPort: 80
  volumes:
  - name: volv
    persistentVolumeClaim:
      claimName: longhorn-volv-pvc
EOF
----

[TIP]
====
The concept of storage in Kubernetes is a complex, but important topic. We briefly mentioned some of the most common Kubernetes resources,
however, we suggest to familiarize yourself with the https://longhorn.io/docs/1.6.0/terminology/[terminology documentation] that Longhorn offers.
====

In this example, the result should look something like this:

[,console]
----
localhost:~ # kubectl get storageclass
NAME                   PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
local-path (default)   rancher.io/local-path   Delete          WaitForFirstConsumer   false                  25h
longhorn (default)     driver.longhorn.io      Delete          Immediate              true                   24h

localhost:~ # kubectl get pvc
NAME                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
longhorn-volv-pvc     Bound    pvc-ad598c98-4cb7-4216-aff6-a52f7e4ea6ac   2Gi        RWO            longhorn       22h

localhost:~ # kubectl get pods -A
NAMESPACE         NAME                                                READY   STATUS      RESTARTS        AGE
longhorn-system   longhorn-ui-5fc9fb76db-z5dc9                        1/1     Running     0               24h
longhorn-system   longhorn-ui-5fc9fb76db-dcb65                        1/1     Running     0               24h
longhorn-system   longhorn-manager-wts2v                              1/1     Running     1 (24h ago)     24h
longhorn-system   longhorn-driver-deployer-5d4f79ddd-fxgcs            1/1     Running     0               24h
longhorn-system   instance-manager-a9bf65a7808a1acd6616bcd4c03d925b   1/1     Running     0               24h
longhorn-system   engine-image-ei-acb7590c-htqmp                      1/1     Running     0               24h
longhorn-system   csi-attacher-5c4bfdcf59-j8xww                       1/1     Running     0               24h
longhorn-system   csi-provisioner-667796df57-l69vh                    1/1     Running     0               24h
longhorn-system   csi-attacher-5c4bfdcf59-xgd5z                       1/1     Running     0               24h
longhorn-system   csi-resizer-694f8f5f64-7n2kq                        1/1     Running     0               24h
longhorn-system   csi-snapshotter-959b69d4b-rp4gk                     1/1     Running     0               24h
longhorn-system   csi-resizer-694f8f5f64-r6ljc                        1/1     Running     0               24h
longhorn-system   csi-resizer-694f8f5f64-k7429                        1/1     Running     0               24h
longhorn-system   csi-snapshotter-959b69d4b-5k8pg                     1/1     Running     0               24h
longhorn-system   csi-provisioner-667796df57-n5w9s                    1/1     Running     0               24h
longhorn-system   csi-snapshotter-959b69d4b-x7b7t                     1/1     Running     0               24h
longhorn-system   longhorn-csi-plugin-bsc8c                           3/3     Running     0               24h
longhorn-system   csi-provisioner-667796df57-dqkfr                    1/1     Running     2 (8m45s ago)   24h
longhorn-system   csi-attacher-5c4bfdcf59-wckt8                       1/1     Running     2 (3m59s ago)   24h
longhorn-system   volume-test                                         1/1     Running     0               22h
----

== Accessing the UI

If you installed Longhorn with kubectl or Helm, you need to set up an Ingress controller to
allow external traffic into the cluster. Authentication is not enabled by
default. If the Rancher catalog app was used, Rancher automatically created an Ingress controller with
access control (the rancher-proxy).

. Get the Longhornâ€™s external service IP address:
+
[,console]
----
kubectl -n longhorn-system get svc
----
+
. Once you have retrieved the `longhorn-frontend` IP address, you can start using the UI by navigating to it in your browser.

== Using Edge Image Builder to deploy Longhorn

The configuration file from below can be used to create an image via
<<components-eib,the Edge Image Builder>> with
Longhorn being set up as well.

* This command attaches the directory and runs EIB. The $DEFINITION_FILE.yaml must contain the values from the YAML file below. It is customizable, but for our purpose this is enough to deploy Longhorn.

[,console]
----
podman run --rm -it -v $IMAGE_DIR:/eib eib:dev build --definition-file $DEFINITION_FILE.yaml
----

[,yaml]
----
apiVersion: 1.0
image:
  imageType: iso
  baseImage: SLE-Micro.x86_64-5.5.0-Default-SelfInstall-GM.install.iso
  arch: x86_64
  outputImageName: eib-image.iso
kubernetes:
  version: v1.28.7+rke2r1
  helm:
    charts:
      - name: longhorn
        version: 1.6.0
        repositoryName: longhorn
        targetNamespace: longhorn-system
        createNamespace: true
        installationNamespace: kube-system
        valuesFile: longhorn.yaml # optional! if we want to edit some of the default settings
    repositories:
      - name: longhorn
        url: https://charts.longhorn.io
operatingSystem:
  packages:
    sccRegistrationCode: <reg-code>
    packageList:
      - open-iscsi
  users:
  - username: root
    encryptedPassword: <password>
----

* If you want to customize the default values of the chart, do so by creating `./kubernetes/helm/values/longhorn.yaml`.

** Retrieve a copy of the Longhorn `values.yaml` https://raw.githubusercontent.com/longhorn/charts/master/charts/longhorn/values.yaml[here].

*** Now you can edit the defaultSettings in the file we created earlier under `./kubernetes/helm/values/longhorn.yaml`.

** Example YAML file that you can use to add the changes to the ConfigMap: `longhorn-default-setting`.

[,yaml]
----
defaultSettings:
  defaultLonghornStaticStorageClass: longhorn-static-example
  backupstorePollInterval: 500
  priorityClass: high-priority
----

* After the image is built, you can use it to install your OS, and Longhorn will be deployed on top of RKE2.

== Using Edge Image Builder to deploy Longhorn in an air-gapped environment

* We can install air-gapped Longhorn using Edge Image Builder by providing the images to the configuration file like this:

[,yaml]
----
embeddedArtifactRegistry:
  images:
    - name: longhornio/csi-attacher:v4.4.2
    - name: longhornio/csi-provisioner:v3.6.2
    - name: longhornio/csi-resizer:v1.9.2
    - name: longhornio/csi-snapshotter:v6.3.2
    - name: longhornio/csi-node-driver-registrar:v2.9.2
    - name: longhornio/livenessprobe:v2.12.0
    - name: longhornio/backing-image-manager:v1.6.1
    - name: longhornio/longhorn-engine:v1.6.1
    - name: longhornio/longhorn-instance-manager:v1.6.1
    - name: longhornio/longhorn-manager:v1.6.1
    - name: longhornio/longhorn-share-manager:v1.6.1
    - name: longhornio/longhorn-ui:v1.6.1
    - name: longhornio/support-bundle-kit:v0.0.36
----

The images from above are for Longhorn 1.6.1, which is the latest version at the time of writing. If you would like to do an air-gap installation with older images or if newer ones exist, they can be located in the official Longhorn documentation under the specific version and Air Gap Installation. In this case, the documentation is available https://longhorn.io/docs/1.6.1/deploy/install/airgap/[here], and the images can be found in `longhorn-images.txt`.

* See the full working example:

[,yaml]
----
apiVersion: 1.0
image:
    imageType: raw
    arch: x86_64
    baseImage: SLE-Micro.x86_64-5.5.0-Default-GM.raw
    outputImageName: longhorn.raw
kubernetes:
  version: v1.28.7+rke2r1
  helm:
    charts:
      - name: longhorn
        repositoryName: longhorn
        targetNamespace: longhorn-system
        createNamespace: true
        version: 1.6.1
    repositories:
      - name: longhorn
        url: https://charts.longhorn.io
operatingSystem:
  rawConfiguration:
    diskSize: 64G
  packages:
    sccRegistrationCode: <reg-code>
    packageList:
      - open-iscsi
  users:
  - username: root
    encryptedPassword: <password>
embeddedArtifactRegistry:
  images:
    - name: longhornio/csi-attacher:v4.4.2
    - name: longhornio/csi-provisioner:v3.6.2
    - name: longhornio/csi-resizer:v1.9.2
    - name: longhornio/csi-snapshotter:v6.3.2
    - name: longhornio/csi-node-driver-registrar:v2.9.2
    - name: longhornio/livenessprobe:v2.12.0
    - name: longhornio/backing-image-manager:v1.6.1
    - name: longhornio/longhorn-engine:v1.6.1
    - name: longhornio/longhorn-instance-manager:v1.6.1
    - name: longhornio/longhorn-manager:v1.6.1
    - name: longhornio/longhorn-share-manager:v1.6.1
    - name: longhornio/longhorn-ui:v1.6.1
    - name: longhornio/support-bundle-kit:v0.0.36
----

