<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>SUSE Edge Documentation | MetalLB in front of the Kubernetes API server</title><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"/>
<meta name="title" content="MetalLB in front of the Kubernetes API server"/>
<meta name="description" content="This guide demonstrates using a MetalLB service to expose the RKE2/K3s API externally on an HA cluster with three control-plane nodes. To achieve thi…"/>
<meta name="book-title" content="SUSE Edge Documentation"/>
<meta name="chapter-title" content="Chapter 27. MetalLB in front of the Kubernetes API server"/>
<meta name="tracker-url" content="https://github.com/suse-edge/suse-edge.github.io/issues/new"/>
<meta name="tracker-type" content="gh"/>
<meta name="publisher" content="SUSE"/><meta property="og:title" content="MetalLB in front of the Kubernetes API server"/>
<meta property="og:description" content="This guide demonstrates using a MetalLB service to expose t…"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MetalLB in front of the Kubernetes API server"/>
<meta name="twitter:description" content="This guide demonstrates using a MetalLB service to expose t…"/>
<script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": ["TechArticle"],
    "image": "https://www.suse.com/assets/img/suse-white-logo-green.svg",
    
     "isPartOf": {
      "@type": "CreativeWorkSeries",
      "name": "Products &amp; Solutions"
    },
    

    "headline": "MetalLB in front of the Kubernetes API server",
  
    "description": "MetalLB in front of the Kubernetes API server",
      
    "author": [
      {
        "@type": "Corporation",
        "name": "SUSE Product &amp; Solution Documentation Team",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    ],
      

    "about": [
      
    ],
  
    "sameAs": [
          "https://www.facebook.com/SUSEWorldwide/about",
          "https://www.youtube.com/channel/UCHTfqIzPKz4f_dri36lAQGA",
          "https://twitter.com/SUSE",
          "https://www.linkedin.com/company/suse"
    ],
    "publisher": {
      "@type": "Corporation",
      "name": "SUSE",
      "url": "https://documentation.suse.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    }
  }</script>
<link rel="prev" href="guides-metallb-k3s-l3.html" title="Chapter 26. MetalLB on K3s (using Layer 3 Mode)"/><link rel="next" href="id-air-gapped-deployments-with-edge-image-builder.html" title="Chapter 28. Air-gapped deployments with Edge Image Builder"/><script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/script-purejs.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="wide offline js-off"><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">SUSE Edge Documentation</a><span> / </span><a class="crumb" href="id-how-to-guides.html">How-To Guides</a><span> / </span><a class="crumb" href="guides-metallb-kubernetes.html">MetalLB in front of the Kubernetes API server</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title">SUSE Edge Documentation</div><ol><li><a href="suse-edge-documentation.html" class=" "><span class="title-number"> </span><span class="title-name">SUSE Edge 3.4 Documentation</span></a></li><li><a href="id-quick-starts.html" class="has-children "><span class="title-number">I </span><span class="title-name">Quick Starts</span></a><ol><li><a href="quickstart-metal3.html" class=" "><span class="title-number">1 </span><span class="title-name">BMC automated deployments with Metal<sup>3</sup></span></a></li><li><a href="quickstart-elemental.html" class=" "><span class="title-number">2 </span><span class="title-name">Remote host onboarding with Elemental</span></a></li><li><a href="quickstart-eib.html" class=" "><span class="title-number">3 </span><span class="title-name">Standalone clusters with Edge Image Builder</span></a></li><li><a href="quickstart-suma.html" class=" "><span class="title-number">4 </span><span class="title-name">SUSE Multi-Linux Manager</span></a></li></ol></li><li><a href="id-components.html" class="has-children "><span class="title-number">II </span><span class="title-name">Components</span></a><ol><li><a href="components-rancher.html" class=" "><span class="title-number">5 </span><span class="title-name">Rancher</span></a></li><li><a href="components-rancher-dashboard-extensions.html" class=" "><span class="title-number">6 </span><span class="title-name">Rancher Dashboard Extensions</span></a></li><li><a href="components-rancher-turtles.html" class=" "><span class="title-number">7 </span><span class="title-name">Rancher Turtles</span></a></li><li><a href="components-fleet.html" class=" "><span class="title-number">8 </span><span class="title-name">Fleet</span></a></li><li><a href="components-slmicro.html" class=" "><span class="title-number">9 </span><span class="title-name">SUSE Linux Micro</span></a></li><li><a href="components-metal3.html" class=" "><span class="title-number">10 </span><span class="title-name">Metal<sup>3</sup></span></a></li><li><a href="components-eib.html" class=" "><span class="title-number">11 </span><span class="title-name">Edge Image Builder</span></a></li><li><a href="components-nmc.html" class=" "><span class="title-number">12 </span><span class="title-name">Edge Networking</span></a></li><li><a href="components-elemental.html" class=" "><span class="title-number">13 </span><span class="title-name">Elemental</span></a></li><li><a href="components-akri.html" class=" "><span class="title-number">14 </span><span class="title-name">Akri</span></a></li><li><a href="components-k3s.html" class=" "><span class="title-number">15 </span><span class="title-name">K3s</span></a></li><li><a href="components-rke2.html" class=" "><span class="title-number">16 </span><span class="title-name">RKE2</span></a></li><li><a href="components-suse-storage.html" class=" "><span class="title-number">17 </span><span class="title-name">SUSE Storage</span></a></li><li><a href="components-suse-security.html" class=" "><span class="title-number">18 </span><span class="title-name">SUSE Security</span></a></li><li><a href="components-metallb.html" class=" "><span class="title-number">19 </span><span class="title-name">MetalLB</span></a></li><li><a href="components-eco.html" class=" "><span class="title-number">20 </span><span class="title-name">Endpoint Copier Operator</span></a></li><li><a href="components-kubevirt.html" class=" "><span class="title-number">21 </span><span class="title-name">Edge Virtualization</span></a></li><li><a href="components-system-upgrade-controller.html" class=" "><span class="title-number">22 </span><span class="title-name">System Upgrade Controller</span></a></li><li><a href="components-upgrade-controller.html" class=" "><span class="title-number">23 </span><span class="title-name">Upgrade Controller</span></a></li><li><a href="components-suma.html" class=" "><span class="title-number">24 </span><span class="title-name">SUSE Multi-Linux Manager</span></a></li></ol></li><li class="active"><a href="id-how-to-guides.html" class="has-children you-are-here"><span class="title-number">III </span><span class="title-name">How-To Guides</span></a><ol><li><a href="guides-metallb-k3s.html" class=" "><span class="title-number">25 </span><span class="title-name">MetalLB on K3s (using Layer 2 Mode)</span></a></li><li><a href="guides-metallb-k3s-l3.html" class=" "><span class="title-number">26 </span><span class="title-name">MetalLB on K3s (using Layer 3 Mode)</span></a></li><li><a href="guides-metallb-kubernetes.html" class=" you-are-here"><span class="title-number">27 </span><span class="title-name">MetalLB in front of the Kubernetes API server</span></a></li><li><a href="id-air-gapped-deployments-with-edge-image-builder.html" class=" "><span class="title-number">28 </span><span class="title-name">Air-gapped deployments with Edge Image Builder</span></a></li><li><a href="guides-kiwi-builder-images.html" class=" "><span class="title-number">29 </span><span class="title-name">Building Updated SUSE Linux Micro Images with Kiwi</span></a></li><li><a href="guides-clusterclass-example.html" class=" "><span class="title-number">30 </span><span class="title-name">Using clusterclass to deploy downstream clusters</span></a></li></ol></li><li><a href="tips-and-tricks.html" class="has-children "><span class="title-number">IV </span><span class="title-name">Tips and Tricks</span></a><ol><li><a href="tips-edge-image-builder.html" class=" "><span class="title-number">31 </span><span class="title-name">Edge Image Builder</span></a></li><li><a href="tips-elemental.html" class=" "><span class="title-number">32 </span><span class="title-name">Elemental</span></a></li></ol></li><li><a href="id-third-party-integration.html" class="has-children "><span class="title-number">V </span><span class="title-name">Third-Party Integration</span></a><ol><li><a href="integrations-nats.html" class=" "><span class="title-number">33 </span><span class="title-name">NATS</span></a></li><li><a href="id-nvidia-gpus-on-suse-linux-micro.html" class=" "><span class="title-number">34 </span><span class="title-name">NVIDIA GPUs on SUSE Linux Micro</span></a></li></ol></li><li><a href="day-2-operations.html" class="has-children "><span class="title-number">VI </span><span class="title-name">Day 2 Operations</span></a><ol><li><a href="day2-migration.html" class=" "><span class="title-number">35 </span><span class="title-name">Edge 3.4 migration</span></a></li><li><a href="day2-mgmt-cluster.html" class=" "><span class="title-number">36 </span><span class="title-name">Management Cluster</span></a></li><li><a href="day2-downstream-clusters.html" class=" "><span class="title-number">37 </span><span class="title-name">Downstream clusters</span></a></li></ol></li><li><a href="id-suse-telco-cloud-documentation.html" class="has-children "><span class="title-number">VII </span><span class="title-name">SUSE Telco Cloud Documentation</span></a><ol><li><a href="atip.html" class=" "><span class="title-number">38 </span><span class="title-name">SUSE Telco Cloud</span></a></li><li><a href="atip-architecture.html" class=" "><span class="title-number">39 </span><span class="title-name">Concept &amp; Architecture</span></a></li><li><a href="atip-requirements.html" class=" "><span class="title-number">40 </span><span class="title-name">Requirements &amp; Assumptions</span></a></li><li><a href="atip-management-cluster.html" class=" "><span class="title-number">41 </span><span class="title-name">Setting up the management cluster</span></a></li><li><a href="atip-features.html" class=" "><span class="title-number">42 </span><span class="title-name">Telco features configuration</span></a></li><li><a href="atip-automated-provisioning.html" class=" "><span class="title-number">43 </span><span class="title-name">Fully automated directed network provisioning</span></a></li><li><a href="atip-lifecycle.html" class=" "><span class="title-number">44 </span><span class="title-name">Lifecycle actions</span></a></li></ol></li><li><a href="id-troubleshooting-3.html" class="has-children "><span class="title-number">VIII </span><span class="title-name">Troubleshooting</span></a><ol><li><a href="general-troubleshooting-principles.html" class=" "><span class="title-number">45 </span><span class="title-name">General Troubleshooting Principles</span></a></li><li><a href="troubleshooting-kiwi.html" class=" "><span class="title-number">46 </span><span class="title-name">Troubleshooting Kiwi</span></a></li><li><a href="troubleshooting-edge-image-builder.html" class=" "><span class="title-number">47 </span><span class="title-name">Troubleshooting Edge Image Builder (EIB)</span></a></li><li><a href="troubleshooting-edge-networking.html" class=" "><span class="title-number">48 </span><span class="title-name">Troubleshooting Edge Networking (NMC)</span></a></li><li><a href="troubleshooting-phone-home-scenarios.html" class=" "><span class="title-number">49 </span><span class="title-name">Troubleshooting Phone-Home scenarios</span></a></li><li><a href="troubleshooting-directed-network-provisioning.html" class=" "><span class="title-number">50 </span><span class="title-name">Troubleshooting Directed-network provisioning</span></a></li><li><a href="troubleshooting-other-components.html" class=" "><span class="title-number">51 </span><span class="title-name">Troubleshooting Other components</span></a></li><li><a href="collecting-diagnostics-for-support.html" class=" "><span class="title-number">52 </span><span class="title-name">Collecting Diagnostics for Support</span></a></li></ol></li><li><a href="id-appendix.html" class="has-children "><span class="title-number">IX </span><span class="title-name">Appendix</span></a><ol><li><a href="id-release-notes.html" class=" "><span class="title-number">53 </span><span class="title-name">Release Notes</span></a></li></ol></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="guides-metallb-kubernetes" data-id-title="MetalLB in front of the Kubernetes API server"><div class="titlepage"><div><div><div class="title-container"><h1 class="title"><span class="title-number-name"><span class="title-number">27 </span><span class="title-name">MetalLB in front of the Kubernetes API server</span></span> <a title="Permalink" class="permalink" href="guides-metallb-kubernetes.html#">#</a></h1><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This guide demonstrates using a MetalLB service to expose the RKE2/K3s API externally on an HA cluster with three control-plane nodes.
To achieve this, a Kubernetes Service of type <code class="literal">LoadBalancer</code> will be manually created. Then an <code class="literal">EndpointSlices</code> object will be automatically created which keeps the IPs of all control plane nodes available in the cluster.
For the EndpointSlices to be continuously synchronized with the events occurring in the cluster (adding/removing a node or a node goes offline), the Endpoint Copier Operator (<a class="xref" href="components-eco.html" title="Chapter 20. Endpoint Copier Operator">Chapter 20, <em>Endpoint Copier Operator</em></a>) will be deployed. The operator monitors the events happening in the default <code class="literal">kubernetes</code> EndpointSlices and updates the managed one automatically to keep them in sync.
Since the managed Service is of type <code class="literal">LoadBalancer</code>, MetalLB assigns it a static <code class="literal">ExternalIP</code>. This <code class="literal">ExternalIP</code> will be used to communicate with the API Server.</p><section class="sect1" id="id-prerequisites-9" data-id-title="Prerequisites"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">27.1 </span><span class="title-name">Prerequisites</span></span> <a title="Permalink" class="permalink" href="guides-metallb-kubernetes.html#id-prerequisites-9">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Three hosts to deploy RKE2/K3s on top.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Ensure the hosts have different host names.</p></li><li class="listitem"><p>For testing, these could be virtual machines</p></li></ul></div></li><li class="listitem"><p>At least 2 available IPs in the network (one for the Traefik/Nginx and one for the managed service).</p></li><li class="listitem"><p>Helm</p></li></ul></div></section><section class="sect1" id="id-installing-rke2k3s" data-id-title="Installing RKE2/K3s"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">27.2 </span><span class="title-name">Installing RKE2/K3s</span></span> <a title="Permalink" class="permalink" href="guides-metallb-kubernetes.html#id-installing-rke2k3s">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.5.5.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>If you do not want to use a fresh cluster but want to use an existing one, skip this step and proceed to the next one.</p></div><p>First, a free IP in the network must be reserved that will be used later for <code class="literal">ExternalIP</code> of the managed Service.</p><p>SSH to the first host and install the wanted distribution in cluster mode.</p><p>For RKE2:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Export the free IP mentioned above
export VIP_SERVICE_IP=&lt;ip&gt;

curl -sfL https://get.rke2.io | INSTALL_RKE2_EXEC="server \
 --write-kubeconfig-mode=644 --tls-san=${VIP_SERVICE_IP} \
 --tls-san=https://${VIP_SERVICE_IP}.sslip.io" sh -

systemctl enable rke2-server.service
systemctl start rke2-server.service

# Fetch the cluster token:
RKE2_TOKEN=$(tr -d '\n' &lt; /var/lib/rancher/rke2/server/node-token)</pre></div><p>For K3s:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Export the free IP mentioned above
export VIP_SERVICE_IP=&lt;ip&gt;
export INSTALL_K3S_SKIP_START=false

curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --cluster-init \
 --disable=servicelb --write-kubeconfig-mode=644 --tls-san=${VIP_SERVICE_IP} \
 --tls-san=https://${VIP_SERVICE_IP}.sslip.io" K3S_TOKEN=foobar sh -</pre></div><div id="id-1.5.5.4.9" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Make sure that <code class="literal">--disable=servicelb</code> flag is provided in the <code class="literal">k3s server</code> command.</p></div><div id="id-1.5.5.4.10" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>From now on, the commands should be run on the local machine.</p></div><p>To access the API server from outside, the IP of the RKE2/K3s VM will be used.</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Replace &lt;node-ip&gt; with the actual IP of the machine
export NODE_IP=&lt;node-ip&gt;
export KUBE_DISTRIBUTION=&lt;k3s/rke2&gt;

scp ${NODE_IP}:/etc/rancher/${KUBE_DISTRIBUTION}/${KUBE_DISTRIBUTION}.yaml ~/.kube/config &amp;&amp; sed \
 -i '' "s/127.0.0.1/${NODE_IP}/g" ~/.kube/config &amp;&amp; chmod 600 ~/.kube/config</pre></div></section><section class="sect1" id="id-configuring-an-existing-cluster" data-id-title="Configuring an existing cluster"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">27.3 </span><span class="title-name">Configuring an existing cluster</span></span> <a title="Permalink" class="permalink" href="guides-metallb-kubernetes.html#id-configuring-an-existing-cluster">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.5.5.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This step is valid only if you intend to use an existing RKE2/K3s cluster.</p></div><p>To use an existing cluster the <code class="literal">tls-san</code> flags should be modified. Additionally, the <code class="literal">servicelb</code> LB should be disabled for K3s.</p><p>To change the flags for RKE2 or K3s servers, you need to modify either the <code class="literal">/etc/systemd/system/rke2.service</code> or <code class="literal">/etc/systemd/system/k3s.service</code> file on all the VMs in the cluster, depending on the distribution.</p><p>The flags should be inserted in the <code class="literal">ExecStart</code>. For example:</p><p>For RKE2:</p><div class="verbatim-wrap"><pre class="screen"># Replace the &lt;vip-service-ip&gt; with the actual ip
ExecStart=/usr/local/bin/rke2 \
    server \
        '--write-kubeconfig-mode=644' \
        '--tls-san=&lt;vip-service-ip&gt;' \
        '--tls-san=https://&lt;vip-service-ip&gt;.sslip.io' \</pre></div><p>For K3s:</p><div class="verbatim-wrap"><pre class="screen"># Replace the &lt;vip-service-ip&gt; with the actual ip
ExecStart=/usr/local/bin/k3s \
    server \
        '--cluster-init' \
        '--write-kubeconfig-mode=644' \
        '--disable=servicelb' \
        '--tls-san=&lt;vip-service-ip&gt;' \
        '--tls-san=https://&lt;vip-service-ip&gt;.sslip.io' \</pre></div><p>Then the following commands should be executed to load the new configurations:</p><div class="verbatim-wrap highlight bash"><pre class="screen">systemctl daemon-reload
systemctl restart ${KUBE_DISTRIBUTION}</pre></div></section><section class="sect1" id="id-installing-metallb" data-id-title="Installing MetalLB"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">27.4 </span><span class="title-name">Installing MetalLB</span></span> <a title="Permalink" class="permalink" href="guides-metallb-kubernetes.html#id-installing-metallb">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>To deploy <code class="literal">MetalLB</code>, the MetalLB on K3s (<a class="xref" href="guides-metallb-k3s.html" title="Chapter 25. MetalLB on K3s (using Layer 2 Mode)">Chapter 25, <em>MetalLB on K3s (using Layer 2 Mode)</em></a>) guide can be used.</p><p><span class="strong"><strong>NOTE:</strong></span> Ensure that the <code class="literal">VIP_SERVICE_IP</code> IP address does not overlap with the existing <code class="literal">IPAddressPools</code> in the cluster.</p><p>Create a separate <code class="literal">IpAddressPool</code> and <code class="literal">L2Advertisement</code> that will be used only for the managed Service.</p><p><span class="strong"><strong>NOTE:</strong></span> The IPAddressPool below will be assigned to a Service of type <code class="literal">LoadBalancer</code> in the <code class="literal">default</code> Namespace. If multiple <code class="literal">LoadBalancer</code> services exist there, additional <a class="link" href="https://metallb.universe.tf/configuration/_advanced_ipaddresspool_configuration/#reduce-scope-of-address-allocation-to-specific-namespace-and-service" target="_blank">ServiceSelectors</a> may be configured to match this VIP service explicitly.</p><div class="verbatim-wrap highlight yaml"><pre class="screen"># Export the VIP_SERVICE_IP on the local machine
# Replace with the actual IP
export VIP_SERVICE_IP=&lt;ip&gt;

cat &lt;&lt;-EOF | kubectl apply -f -
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: kubernetes-vip-ip-pool
  namespace: metallb-system
spec:
  addresses:
  - ${VIP_SERVICE_IP}/32
  serviceAllocation:
    priority: 100
    namespaces:
      - default
EOF</pre></div><div class="verbatim-wrap highlight yaml"><pre class="screen">cat &lt;&lt;-EOF | kubectl apply -f -
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: kubernetes-vip-l2-adv
  namespace: metallb-system
spec:
  ipAddressPools:
  - kubernetes-vip-ip-pool
EOF</pre></div></section><section class="sect1" id="id-installing-the-endpoint-copier-operator" data-id-title="Installing the Endpoint Copier Operator"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">27.5 </span><span class="title-name">Installing the Endpoint Copier Operator</span></span> <a title="Permalink" class="permalink" href="guides-metallb-kubernetes.html#id-installing-the-endpoint-copier-operator">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="verbatim-wrap highlight bash"><pre class="screen">helm install \
endpoint-copier-operator oci://registry.suse.com/edge/charts/endpoint-copier-operator \
--namespace endpoint-copier-operator \
--create-namespace</pre></div><p>The command above will deploy the <code class="literal">endpoint-copier-operator</code> operator Deployment with two replicas. One will be the leader and the other will take over the leader role if needed.</p><p>Now, the <code class="literal">kubernetes-vip</code> Service should be deployed, which will be reconciled by the operator and an EndpointSlices with the configured ports and IP will be created.</p><p>For RKE2:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;&lt;-EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: kubernetes-vip
  namespace: default
spec:
  ports:
  - name: rke2-api
    port: 9345
    protocol: TCP
    targetPort: 9345
  - name: k8s-api
    port: 6443
    protocol: TCP
    targetPort: 6443
  type: LoadBalancer
EOF</pre></div><p>For K3s:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &lt;&lt;-EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: kubernetes-vip
  namespace: default
spec:
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: https
    port: 6443
    protocol: TCP
    targetPort: 6443
  sessionAffinity: None
  type: LoadBalancer
EOF</pre></div><p>Verify that the <code class="literal">kubernetes-vip</code> Service has the correct IP address:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get service kubernetes-vip -n default \
 -o=jsonpath='{.status.loadBalancer.ingress[0].ip}'</pre></div><p>Ensure that the <code class="literal">kubernetes-vip-*</code> and <code class="literal">kubernetes</code> EndpointSlices resources in the <code class="literal">default</code> namespace point to the same IPs.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get endpointslices | grep kubernetes</pre></div><p>If everything is correct, the last thing left is to use the <code class="literal">VIP_SERVICE_IP</code> in our <code class="literal">Kubeconfig</code>.</p><div class="verbatim-wrap highlight bash"><pre class="screen">sed -i '' "s/${NODE_IP}/${VIP_SERVICE_IP}/g" ~/.kube/config</pre></div><p>From now on, all the <code class="literal">kubectl</code> will go through the <code class="literal">kubernetes-vip</code> service.</p></section><section class="sect1" id="id-adding-control-plane-nodes" data-id-title="Adding control-plane nodes"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">27.6 </span><span class="title-name">Adding control-plane nodes</span></span> <a title="Permalink" class="permalink" href="guides-metallb-kubernetes.html#id-adding-control-plane-nodes">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>To monitor the entire process, two more terminal tabs can be opened.</p><p>First terminal:</p><div class="verbatim-wrap highlight bash"><pre class="screen">watch kubectl get nodes</pre></div><p>Second terminal:</p><div class="verbatim-wrap highlight bash"><pre class="screen">watch kubectl get endpointslices</pre></div><p>Now execute the commands below on the second and third nodes.</p><p>For RKE2:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Export the VIP_SERVICE_IP in the VM
# Replace with the actual IP
export VIP_SERVICE_IP=&lt;ip&gt;

curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="server" sh -
systemctl enable rke2-server.service


mkdir -p /etc/rancher/rke2/
cat &lt;&lt;EOF &gt; /etc/rancher/rke2/config.yaml
server: https://${VIP_SERVICE_IP}:9345
token: ${RKE2_TOKEN}
EOF

systemctl start rke2-server.service</pre></div><p>For K3s:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Export the VIP_SERVICE_IP in the VM
# Replace with the actual IP
export VIP_SERVICE_IP=&lt;ip&gt;
export INSTALL_K3S_SKIP_START=false

curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server \
 --server https://${VIP_SERVICE_IP}:6443 --disable=servicelb \
 --write-kubeconfig-mode=644" K3S_TOKEN=foobar sh -</pre></div></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="guides-metallb-k3s-l3.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Chapter 26 </span>MetalLB on K3s (using Layer 3 Mode)</span></a> </div><div><a class="pagination-link next" href="id-air-gapped-deployments-with-edge-image-builder.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Chapter 28 </span>Air-gapped deployments with Edge Image Builder</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="section"><a href="guides-metallb-kubernetes.html#id-prerequisites-9"><span class="title-number">27.1 </span><span class="title-name">Prerequisites</span></a></span></li><li><span class="section"><a href="guides-metallb-kubernetes.html#id-installing-rke2k3s"><span class="title-number">27.2 </span><span class="title-name">Installing RKE2/K3s</span></a></span></li><li><span class="section"><a href="guides-metallb-kubernetes.html#id-configuring-an-existing-cluster"><span class="title-number">27.3 </span><span class="title-name">Configuring an existing cluster</span></a></span></li><li><span class="section"><a href="guides-metallb-kubernetes.html#id-installing-metallb"><span class="title-number">27.4 </span><span class="title-name">Installing MetalLB</span></a></span></li><li><span class="section"><a href="guides-metallb-kubernetes.html#id-installing-the-endpoint-copier-operator"><span class="title-number">27.5 </span><span class="title-name">Installing the Endpoint Copier Operator</span></a></span></li><li><span class="section"><a href="guides-metallb-kubernetes.html#id-adding-control-plane-nodes"><span class="title-number">27.6 </span><span class="title-name">Adding control-plane nodes</span></a></span></li></ul></div><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter/X"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2025</span></div></div></footer></body></html>