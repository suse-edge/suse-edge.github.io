<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>SUSE Edge Documentation | Management Cluster</title><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"/>
<meta name="title" content="Management Cluster"/>
<meta name="description" content="Currently, there are two ways to perform &quot;Day 2&quot; operations on your management cluster:"/>
<meta name="book-title" content="SUSE Edge Documentation"/>
<meta name="chapter-title" content="Chapter 36. Management Cluster"/>
<meta name="tracker-url" content="https://github.com/suse-edge/suse-edge.github.io/issues/new"/>
<meta name="tracker-type" content="gh"/>
<meta name="publisher" content="SUSE"/><meta property="og:title" content="Management Cluster"/>
<meta property="og:description" content="Currently, there are two ways to perform &quot;Day 2&quot; operations…"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Management Cluster"/>
<meta name="twitter:description" content="Currently, there are two ways to perform &quot;Day 2&quot; operations…"/>
<script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": ["TechArticle"],
    "image": "https://www.suse.com/assets/img/suse-white-logo-green.svg",
    
     "isPartOf": {
      "@type": "CreativeWorkSeries",
      "name": "Products &amp; Solutions"
    },
    

    "headline": "Management Cluster",
  
    "description": "Management Cluster",
      
    "author": [
      {
        "@type": "Corporation",
        "name": "SUSE Product &amp; Solution Documentation Team",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    ],
      

    "about": [
      
    ],
  
    "sameAs": [
          "https://www.facebook.com/SUSEWorldwide/about",
          "https://www.youtube.com/channel/UCHTfqIzPKz4f_dri36lAQGA",
          "https://twitter.com/SUSE",
          "https://www.linkedin.com/company/suse"
    ],
    "publisher": {
      "@type": "Corporation",
      "name": "SUSE",
      "url": "https://documentation.suse.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    }
  }</script>
<link rel="prev" href="day2-migration.html" title="Chapter 35. Edge 3.4 migration"/><link rel="next" href="day2-downstream-clusters.html" title="Chapter 37. Downstream clusters"/><script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/script-purejs.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="wide offline js-off"><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">SUSE Edge Documentation</a><span> / </span><a class="crumb" href="day-2-operations.html">Day 2 Operations</a><span> / </span><a class="crumb" href="day2-mgmt-cluster.html">Management Cluster</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title">SUSE Edge Documentation</div><ol><li><a href="suse-edge-documentation.html" class=" "><span class="title-number"> </span><span class="title-name">SUSE Edge 3.4 Documentation</span></a></li><li><a href="id-quick-starts.html" class="has-children "><span class="title-number">I </span><span class="title-name">Quick Starts</span></a><ol><li><a href="quickstart-metal3.html" class=" "><span class="title-number">1 </span><span class="title-name">BMC automated deployments with Metal<sup>3</sup></span></a></li><li><a href="quickstart-elemental.html" class=" "><span class="title-number">2 </span><span class="title-name">Remote host onboarding with Elemental</span></a></li><li><a href="quickstart-eib.html" class=" "><span class="title-number">3 </span><span class="title-name">Standalone clusters with Edge Image Builder</span></a></li><li><a href="quickstart-suma.html" class=" "><span class="title-number">4 </span><span class="title-name">SUSE Multi-Linux Manager</span></a></li></ol></li><li><a href="id-components.html" class="has-children "><span class="title-number">II </span><span class="title-name">Components</span></a><ol><li><a href="components-rancher.html" class=" "><span class="title-number">5 </span><span class="title-name">Rancher</span></a></li><li><a href="components-rancher-dashboard-extensions.html" class=" "><span class="title-number">6 </span><span class="title-name">Rancher Dashboard Extensions</span></a></li><li><a href="components-rancher-turtles.html" class=" "><span class="title-number">7 </span><span class="title-name">Rancher Turtles</span></a></li><li><a href="components-fleet.html" class=" "><span class="title-number">8 </span><span class="title-name">Fleet</span></a></li><li><a href="components-slmicro.html" class=" "><span class="title-number">9 </span><span class="title-name">SUSE Linux Micro</span></a></li><li><a href="components-metal3.html" class=" "><span class="title-number">10 </span><span class="title-name">Metal<sup>3</sup></span></a></li><li><a href="components-eib.html" class=" "><span class="title-number">11 </span><span class="title-name">Edge Image Builder</span></a></li><li><a href="components-nmc.html" class=" "><span class="title-number">12 </span><span class="title-name">Edge Networking</span></a></li><li><a href="components-elemental.html" class=" "><span class="title-number">13 </span><span class="title-name">Elemental</span></a></li><li><a href="components-akri.html" class=" "><span class="title-number">14 </span><span class="title-name">Akri</span></a></li><li><a href="components-k3s.html" class=" "><span class="title-number">15 </span><span class="title-name">K3s</span></a></li><li><a href="components-rke2.html" class=" "><span class="title-number">16 </span><span class="title-name">RKE2</span></a></li><li><a href="components-suse-storage.html" class=" "><span class="title-number">17 </span><span class="title-name">SUSE Storage</span></a></li><li><a href="components-suse-security.html" class=" "><span class="title-number">18 </span><span class="title-name">SUSE Security</span></a></li><li><a href="components-metallb.html" class=" "><span class="title-number">19 </span><span class="title-name">MetalLB</span></a></li><li><a href="components-eco.html" class=" "><span class="title-number">20 </span><span class="title-name">Endpoint Copier Operator</span></a></li><li><a href="components-kubevirt.html" class=" "><span class="title-number">21 </span><span class="title-name">Edge Virtualization</span></a></li><li><a href="components-system-upgrade-controller.html" class=" "><span class="title-number">22 </span><span class="title-name">System Upgrade Controller</span></a></li><li><a href="components-upgrade-controller.html" class=" "><span class="title-number">23 </span><span class="title-name">Upgrade Controller</span></a></li><li><a href="components-suma.html" class=" "><span class="title-number">24 </span><span class="title-name">SUSE Multi-Linux Manager</span></a></li></ol></li><li><a href="id-how-to-guides.html" class="has-children "><span class="title-number">III </span><span class="title-name">How-To Guides</span></a><ol><li><a href="guides-metallb-k3s.html" class=" "><span class="title-number">25 </span><span class="title-name">MetalLB on K3s (using Layer 2 Mode)</span></a></li><li><a href="guides-metallb-k3s-l3.html" class=" "><span class="title-number">26 </span><span class="title-name">MetalLB on K3s (using Layer 3 Mode)</span></a></li><li><a href="guides-metallb-kubernetes.html" class=" "><span class="title-number">27 </span><span class="title-name">MetalLB in front of the Kubernetes API server</span></a></li><li><a href="id-air-gapped-deployments-with-edge-image-builder.html" class=" "><span class="title-number">28 </span><span class="title-name">Air-gapped deployments with Edge Image Builder</span></a></li><li><a href="guides-kiwi-builder-images.html" class=" "><span class="title-number">29 </span><span class="title-name">Building Updated SUSE Linux Micro Images with Kiwi</span></a></li><li><a href="guides-clusterclass-example.html" class=" "><span class="title-number">30 </span><span class="title-name">Using clusterclass to deploy downstream clusters</span></a></li></ol></li><li><a href="tips-and-tricks.html" class="has-children "><span class="title-number">IV </span><span class="title-name">Tips and Tricks</span></a><ol><li><a href="tips-edge-image-builder.html" class=" "><span class="title-number">31 </span><span class="title-name">Edge Image Builder</span></a></li><li><a href="tips-elemental.html" class=" "><span class="title-number">32 </span><span class="title-name">Elemental</span></a></li></ol></li><li><a href="id-third-party-integration.html" class="has-children "><span class="title-number">V </span><span class="title-name">Third-Party Integration</span></a><ol><li><a href="integrations-nats.html" class=" "><span class="title-number">33 </span><span class="title-name">NATS</span></a></li><li><a href="id-nvidia-gpus-on-suse-linux-micro.html" class=" "><span class="title-number">34 </span><span class="title-name">NVIDIA GPUs on SUSE Linux Micro</span></a></li></ol></li><li class="active"><a href="day-2-operations.html" class="has-children you-are-here"><span class="title-number">VI </span><span class="title-name">Day 2 Operations</span></a><ol><li><a href="day2-migration.html" class=" "><span class="title-number">35 </span><span class="title-name">Edge 3.4 migration</span></a></li><li><a href="day2-mgmt-cluster.html" class=" you-are-here"><span class="title-number">36 </span><span class="title-name">Management Cluster</span></a></li><li><a href="day2-downstream-clusters.html" class=" "><span class="title-number">37 </span><span class="title-name">Downstream clusters</span></a></li></ol></li><li><a href="id-suse-telco-cloud-documentation.html" class="has-children "><span class="title-number">VII </span><span class="title-name">SUSE Telco Cloud Documentation</span></a><ol><li><a href="atip.html" class=" "><span class="title-number">38 </span><span class="title-name">SUSE Telco Cloud</span></a></li><li><a href="atip-architecture.html" class=" "><span class="title-number">39 </span><span class="title-name">Concept &amp; Architecture</span></a></li><li><a href="atip-requirements.html" class=" "><span class="title-number">40 </span><span class="title-name">Requirements &amp; Assumptions</span></a></li><li><a href="atip-management-cluster.html" class=" "><span class="title-number">41 </span><span class="title-name">Setting up the management cluster</span></a></li><li><a href="atip-features.html" class=" "><span class="title-number">42 </span><span class="title-name">Telco features configuration</span></a></li><li><a href="atip-automated-provisioning.html" class=" "><span class="title-number">43 </span><span class="title-name">Fully automated directed network provisioning</span></a></li><li><a href="atip-lifecycle.html" class=" "><span class="title-number">44 </span><span class="title-name">Lifecycle actions</span></a></li></ol></li><li><a href="id-troubleshooting-3.html" class="has-children "><span class="title-number">VIII </span><span class="title-name">Troubleshooting</span></a><ol><li><a href="general-troubleshooting-principles.html" class=" "><span class="title-number">45 </span><span class="title-name">General Troubleshooting Principles</span></a></li><li><a href="troubleshooting-kiwi.html" class=" "><span class="title-number">46 </span><span class="title-name">Troubleshooting Kiwi</span></a></li><li><a href="troubleshooting-edge-image-builder.html" class=" "><span class="title-number">47 </span><span class="title-name">Troubleshooting Edge Image Builder (EIB)</span></a></li><li><a href="troubleshooting-edge-networking.html" class=" "><span class="title-number">48 </span><span class="title-name">Troubleshooting Edge Networking (NMC)</span></a></li><li><a href="troubleshooting-phone-home-scenarios.html" class=" "><span class="title-number">49 </span><span class="title-name">Troubleshooting Phone-Home scenarios</span></a></li><li><a href="troubleshooting-directed-network-provisioning.html" class=" "><span class="title-number">50 </span><span class="title-name">Troubleshooting Directed-network provisioning</span></a></li><li><a href="troubleshooting-other-components.html" class=" "><span class="title-number">51 </span><span class="title-name">Troubleshooting Other components</span></a></li><li><a href="collecting-diagnostics-for-support.html" class=" "><span class="title-number">52 </span><span class="title-name">Collecting Diagnostics for Support</span></a></li></ol></li><li><a href="id-appendix.html" class="has-children "><span class="title-number">IX </span><span class="title-name">Appendix</span></a><ol><li><a href="id-release-notes.html" class=" "><span class="title-number">53 </span><span class="title-name">Release Notes</span></a></li></ol></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="day2-mgmt-cluster" data-id-title="Management Cluster"><div class="titlepage"><div><div><div class="title-container"><h1 class="title"><span class="title-number-name"><span class="title-number">36 </span><span class="title-name">Management Cluster</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#">#</a></h1><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Currently, there are two ways to perform "Day 2" operations on your <code class="literal">management</code> cluster:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through <a class="xref" href="components-upgrade-controller.html" title="Chapter 23. Upgrade Controller">Chapter 23, <em>Upgrade Controller</em></a> - <a class="xref" href="day2-mgmt-cluster.html#management-day2-upgrade-controller" title="36.1. Upgrade Controller">Section 36.1, “Upgrade Controller”</a></p></li><li class="listitem"><p>Through <a class="xref" href="components-fleet.html" title="Chapter 8. Fleet">Chapter 8, <em>Fleet</em></a> - <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet" title="36.2. Fleet">Section 36.2, “Fleet”</a></p></li></ol></div><section class="sect1" id="management-day2-upgrade-controller" data-id-title="Upgrade Controller"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">36.1 </span><span class="title-name">Upgrade Controller</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-upgrade-controller">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.8.4.4.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>The <code class="literal">Upgrade Controller</code> currently only supports <code class="literal">Day 2</code> operations for <span class="strong"><strong>non air-gapped management</strong></span> clusters.</p></div><p>This section covers how to perform the various <code class="literal">Day 2</code> operations related to upgrading your <code class="literal">management</code> cluster from one Edge platform version to another.</p><p>The <code class="literal">Day 2</code> operations are automated by the Upgrade Controller (<a class="xref" href="components-upgrade-controller.html" title="Chapter 23. Upgrade Controller">Chapter 23, <em>Upgrade Controller</em></a>) and include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>SUSE Linux Micro (<a class="xref" href="components-slmicro.html" title="Chapter 9. SUSE Linux Micro">Chapter 9, <em>SUSE Linux Micro</em></a>) OS upgrade</p></li><li class="listitem"><p><a class="xref" href="components-rke2.html" title="Chapter 16. RKE2">Chapter 16, <em>RKE2</em></a> or <a class="xref" href="components-k3s.html" title="Chapter 15. K3s">Chapter 15, <em>K3s</em></a> Kubernetes upgrade</p></li><li class="listitem"><p>SUSE additional components (SUSE Rancher Prime, SUSE Security, etc.) upgrade</p></li></ul></div><section class="sect2" id="id-prerequisites-13" data-id-title="Prerequisites"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">36.1.1 </span><span class="title-name">Prerequisites</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-prerequisites-13">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Before upgrading your <code class="literal">management</code> cluster, the following prerequisites must be met:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><code class="literal">SCC registered nodes</code> - ensure your cluster nodes' OS are registered with a subscription key that supports the OS version specified in the Edge release (<a class="xref" href="id-release-notes.html#release-notes" title="53.1. Abstract">Section 53.1, “Abstract”</a>) you intend to upgrade to.</p></li><li class="listitem"><p><code class="literal">Upgrade Controller</code> - make sure that the <code class="literal">Upgrade Controller</code> has been deployed on your <code class="literal">management</code> cluster. For installation steps, refer to <a class="xref" href="components-upgrade-controller.html#components-upgrade-controller-installation" title="23.3. Installing the Upgrade Controller">Section 23.3, “Installing the Upgrade Controller”</a>.</p></li></ol></div></section><section class="sect2" id="id-upgrade" data-id-title="Upgrade"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">36.1.2 </span><span class="title-name">Upgrade</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-upgrade">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Determine the Edge release (<a class="xref" href="id-release-notes.html#release-notes" title="53.1. Abstract">Section 53.1, “Abstract”</a>) version that you wish to upgrade your <code class="literal">management</code> cluster to.</p></li><li class="listitem"><p>In the <code class="literal">management</code> cluster, deploy an <code class="literal">UpgradePlan</code> that specifies the desired <code class="literal">release version</code>. The <code class="literal">UpgradePlan</code> must be deployed in the namespace of the <code class="literal">Upgrade Controller</code>.</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -n &lt;upgrade_controller_namespace&gt; -f - &lt;&lt;EOF
apiVersion: lifecycle.suse.com/v1alpha1
kind: UpgradePlan
metadata:
  name: upgrade-plan-mgmt
spec:
  # Version retrieved from release notes
  releaseVersion: 3.X.Y
EOF</pre></div><div id="id-1.8.4.4.7.2.2.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There may be use-cases where you would want to make additional configurations over the <code class="literal">UpgradePlan</code>. For all possible configurations, refer to <a class="xref" href="components-upgrade-controller.html#components-upgrade-controller-extensions-upgrade-plan" title="23.5.1. UpgradePlan">Section 23.5.1, “UpgradePlan”</a>.</p></div></li><li class="listitem"><p>Deploying the <code class="literal">UpgradePlan</code> to the <code class="literal">Upgrade Controller’s</code> namespace will begin the <code class="literal">upgrade process</code>.</p><div id="id-1.8.4.4.7.2.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>For more information on the actual <code class="literal">upgrade process</code>, refer to <a class="xref" href="components-upgrade-controller.html#components-upgrade-controller-how" title="23.4. How does the Upgrade Controller work?">Section 23.4, “How does the Upgrade Controller work?”</a>.</p><p>For information on how to track the <code class="literal">upgrade process</code>, refer to <a class="xref" href="components-upgrade-controller.html#components-upgrade-controller-how-track" title="23.6. Tracking the upgrade process">Section 23.6, “Tracking the upgrade process”</a>.</p></div></li></ol></div></section></section><section class="sect1" id="management-day2-fleet" data-id-title="Fleet"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">36.2 </span><span class="title-name">Fleet</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section offers information on how to perform "Day 2" operations using the Fleet (<a class="xref" href="components-fleet.html" title="Chapter 8. Fleet">Chapter 8, <em>Fleet</em></a>) component.</p><p>The following topics are covered as part of this section:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-components" title="36.2.1. Components">Section 36.2.1, “Components”</a> - default components used for all "Day 2" operations.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-determine-use-case" title="36.2.2. Determine your use-case">Section 36.2.2, “Determine your use-case”</a> - provides an overview of the Fleet custom resources that will be used and their suitability for different "Day 2" operations use-cases.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-upgrade-workflow" title="36.2.3. Day 2 workflow">Section 36.2.3, “Day 2 workflow”</a> - provides a workflow guide for executing "Day 2" operations with Fleet.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade" title="36.2.4. OS upgrade">Section 36.2.4, “OS upgrade”</a> - describes how to do OS upgrades using Fleet.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade" title="36.2.5. Kubernetes version upgrade">Section 36.2.5, “Kubernetes version upgrade”</a> - describes how to do Kubernetes version upgrades using Fleet.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade" title="36.2.6. Helm chart upgrade">Section 36.2.6, “Helm chart upgrade”</a> - describes how to do Helm chart upgrades using Fleet.</p></li></ol></div><section class="sect2" id="management-day2-fleet-components" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">36.2.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-components">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Below you can find a description of the default components that should be set up on your <code class="literal">management</code> cluster so that you can successfully perform "Day 2" operations using Fleet.</p><section class="sect3" id="id-rancher" data-id-title="Rancher"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.1.1 </span><span class="title-name">Rancher</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-rancher">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="strong"><strong>Optional</strong></span>; Responsible for managing <code class="literal">downstream clusters</code> and deploying the <code class="literal">System Upgrade Controller</code> on your <code class="literal">management cluster</code>.</p><p>For more information, see <a class="xref" href="components-rancher.html" title="Chapter 5. Rancher">Chapter 5, <em>Rancher</em></a>.</p></section><section class="sect3" id="id-system-upgrade-controller-suc" data-id-title="System Upgrade Controller (SUC)"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.1.2 </span><span class="title-name">System Upgrade Controller (SUC)</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-system-upgrade-controller-suc">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="strong"><strong>System Upgrade Controller</strong></span> is responsible for executing tasks on specified nodes based on configuration data provided through a custom resource, called a <code class="literal">Plan</code>.</p><p><span class="strong"><strong>SUC</strong></span> is actively utilized to upgrade the operating system and Kubernetes distribution.</p><p>For more information about the <span class="strong"><strong>SUC</strong></span> component and how it fits in the Edge stack, see <a class="xref" href="components-system-upgrade-controller.html" title="Chapter 22. System Upgrade Controller">Chapter 22, <em>System Upgrade Controller</em></a>.</p></section></section><section class="sect2" id="management-day2-fleet-determine-use-case" data-id-title="Determine your use-case"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">36.2.2 </span><span class="title-name">Determine your use-case</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-determine-use-case">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Fleet uses two types of <a class="link" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank">custom resources</a> to enable the management of Kubernetes and Helm resources.</p><p>Below you can find information about the purpose of these resources and the use-cases they are best suited for in the context of "Day 2" operations.</p><section class="sect3" id="id-gitrepo" data-id-title="GitRepo"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.2.1 </span><span class="title-name">GitRepo</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-gitrepo">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <code class="literal">GitRepo</code> is a Fleet (<a class="xref" href="components-fleet.html" title="Chapter 8. Fleet">Chapter 8, <em>Fleet</em></a>) resource that represents a Git repository from which <code class="literal">Fleet</code> can create <code class="literal">Bundles</code>. Each <code class="literal">Bundle</code> is created based on configuration paths defined inside of the <code class="literal">GitRepo</code> resource. For more information, see the <a class="link" href="https://fleet.rancher.io/gitrepo-add" target="_blank">GitRepo</a> documentation.</p><p>In the context of "Day 2" operations, <code class="literal">GitRepo</code> resources are normally used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> in <span class="strong"><strong>non air-gapped</strong></span> environments that utilize a <span class="emphasis"><em>Fleet GitOps</em></span> approach.</p><p>Alternatively, <code class="literal">GitRepo</code> resources can also be used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> on <span class="strong"><strong>air-gapped</strong></span> environments, <span class="strong"><strong>provided you mirror your repository setup through a local git server</strong></span>.</p></section><section class="sect3" id="id-bundle" data-id-title="Bundle"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.2.2 </span><span class="title-name">Bundle</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-bundle">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><code class="literal">Bundles</code> hold <span class="strong"><strong>raw</strong></span> Kubernetes resources that will be deployed on the targeted cluster. Usually they are created from a <code class="literal">GitRepo</code> resource, but there are use-cases where they can be deployed manually. For more information refer to the <a class="link" href="https://fleet.rancher.io/bundle-add" target="_blank">Bundle</a> documentation.</p><p>In the context of "Day 2" operations, <code class="literal">Bundle</code> resources are normally used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> in <span class="strong"><strong>air-gapped</strong></span> environments that do not use some form of <span class="emphasis"><em>local GitOps</em></span> procedure (e.g. a <span class="strong"><strong>local git server</strong></span>).</p><p>Alternatively, if your use-case does not allow for a <span class="emphasis"><em>GitOps</em></span> workflow (e.g. using a Git repository), <code class="literal">Bundle</code> resources could also be used to deploy <code class="literal">SUC</code> or <code class="literal">SUC Plans</code> in <span class="strong"><strong>non air-gapped</strong></span> environments.</p></section></section><section class="sect2" id="management-day2-upgrade-workflow" data-id-title="Day 2 workflow"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">36.2.3 </span><span class="title-name">Day 2 workflow</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-upgrade-workflow">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The following is a "Day 2" workflow that should be followed when upgrading a management cluster to a specific Edge release.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>OS upgrade (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade" title="36.2.4. OS upgrade">Section 36.2.4, “OS upgrade”</a>)</p></li><li class="listitem"><p>Kubernetes version upgrade (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade" title="36.2.5. Kubernetes version upgrade">Section 36.2.5, “Kubernetes version upgrade”</a>)</p></li><li class="listitem"><p>Helm chart upgrade (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade" title="36.2.6. Helm chart upgrade">Section 36.2.6, “Helm chart upgrade”</a>)</p></li></ol></div></section><section class="sect2" id="management-day2-fleet-os-upgrade" data-id-title="OS upgrade"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">36.2.4 </span><span class="title-name">OS upgrade</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section describes how to perform an operating system upgrade using <a class="xref" href="components-fleet.html" title="Chapter 8. Fleet">Chapter 8, <em>Fleet</em></a> and the <a class="xref" href="components-system-upgrade-controller.html" title="Chapter 22. System Upgrade Controller">Chapter 22, <em>System Upgrade Controller</em></a>.</p><p>The following topics are covered as part of this section:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-components" title="36.2.4.1. Components">Section 36.2.4.1, “Components”</a> - additional components used by the upgrade process.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-overview" title="36.2.4.2. Overview">Section 36.2.4.2, “Overview”</a> - overview of the upgrade process.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-requirements" title="36.2.4.3. Requirements">Section 36.2.4.3, “Requirements”</a> - requirements of the upgrade process.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment" title="36.2.4.4. OS upgrade - SUC plan deployment">Section 36.2.4.4, “OS upgrade - SUC plan deployment”</a> - information on how to deploy <code class="literal">SUC plans</code>, responsible for triggering the upgrade process.</p></li></ol></div><section class="sect3" id="management-day2-fleet-os-upgrade-components" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.4.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-components">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers the custom components that the <code class="literal">OS upgrade</code> process uses over the default "Day 2" components (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-components" title="36.2.1. Components">Section 36.2.1, “Components”</a>).</p><section class="sect4" id="management-day2-fleet-os-upgrade-components-systemd-service" data-id-title="systemd.service"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.4.1.1 </span><span class="title-name">systemd.service</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-components-systemd-service">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The OS upgrade on a specific node is handled by a <a class="link" href="https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html" target="_blank">systemd.service</a>.</p><p>A different service is created depending on what type of upgrade the OS requires from one Edge version to another:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For Edge versions that require the same OS version (e.g. <code class="literal">6.0</code>), the <code class="literal">os-pkg-update.service</code> will be created. It uses <a class="link" href="https://kubic.opensuse.org/documentation/man-pages/transactional-update.8.html" target="_blank">transactional-update</a> to perform a <a class="link" href="https://en.opensuse.org/SDB:Zypper_usage#Updating_packages" target="_blank">normal package upgrade</a>.</p></li><li class="listitem"><p>For Edge versions that require an OS version migration (e.g <code class="literal">6.0</code> → <code class="literal">6.1</code>), the <code class="literal">os-migration.service</code> will be created. It uses <a class="link" href="https://kubic.opensuse.org/documentation/man-pages/transactional-update.8.html" target="_blank">transactional-update</a> to perform:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>A <a class="link" href="https://en.opensuse.org/SDB:Zypper_usage#Updating_packages" target="_blank">normal package upgrade</a> which ensures that all packages are at up-to-date in order to mitigate any failures in the migration related to old package versions.</p></li><li class="listitem"><p>An OS migration by utilizing the <code class="literal">zypper migration</code> command.</p></li></ol></div></li></ul></div><p>The services mentioned above are shipped on each node through a <code class="literal">SUC plan</code> which must be located on the management cluster that is in need of an OS upgrade.</p></section></section><section class="sect3" id="management-day2-fleet-os-upgrade-overview" data-id-title="Overview"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.4.2 </span><span class="title-name">Overview</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-overview">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The upgrade of the operating system for management cluster nodes is done by utilizing <code class="literal">Fleet</code> and the <code class="literal">System Upgrade Controller (SUC)</code>.</p><p><span class="strong"><strong>Fleet</strong></span> is used to deploy and manage <code class="literal">SUC plans</code> onto the desired cluster.</p><div id="id-1.8.4.5.8.6.4" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p><code class="literal">SUC plans</code> are <a class="link" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank">custom resources</a> that describe the steps that <code class="literal">SUC</code> needs to follow in order for a specific task to be executed on a set of nodes. For an example of how an <code class="literal">SUC plan</code> looks like, refer to the <a class="link" href="https://github.com/rancher/system-upgrade-controller?tab=readme-ov-file#example-plans" target="_blank">upstream repository</a>.</p></div><p>The <code class="literal">OS SUC plans</code> are shipped to each cluster by deploying a <a class="link" href="https://fleet.rancher.io/gitrepo-add" target="_blank">GitRepo</a> or <a class="link" href="https://fleet.rancher.io/bundle-add" target="_blank">Bundle</a> resource to a specific Fleet <a class="link" href="https://fleet.rancher.io/namespaces#gitrepos-bundles-clusters-clustergroups" target="_blank">workspace</a>. Fleet retrieves the deployed <code class="literal">GitRepo/Bundle</code> and deploys its contents (the <code class="literal">OS SUC plans</code>) to the desired cluster(s).</p><div id="id-1.8.4.5.8.6.6" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p><code class="literal">GitRepo/Bundle</code> resources are always deployed on the <code class="literal">management cluster</code>. Whether to use a <code class="literal">GitRepo</code> or <code class="literal">Bundle</code> resource depends on your use-case, check <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-determine-use-case" title="36.2.2. Determine your use-case">Section 36.2.2, “Determine your use-case”</a> for more information.</p></div><p><code class="literal">OS SUC plans</code> describe the following workflow:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Always <a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cordon/" target="_blank">cordon</a> the nodes before OS upgrades.</p></li><li class="listitem"><p>Always upgrade <code class="literal">control-plane</code> nodes before <code class="literal">worker</code> nodes.</p></li><li class="listitem"><p>Always upgrade the cluster on a <span class="strong"><strong>one</strong></span> node at a time basis.</p></li></ol></div><p>Once the <code class="literal">OS SUC plans</code> are deployed, the workflow looks like this:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>SUC reconciles the deployed <code class="literal">OS SUC plans</code> and creates a <code class="literal">Kubernetes Job</code> on <span class="strong"><strong>each node</strong></span>.</p></li><li class="listitem"><p>The <code class="literal">Kubernetes Job</code> creates a systemd.service (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-components-systemd-service" title="36.2.4.1.1. systemd.service">Section 36.2.4.1.1, “systemd.service”</a>) for either package upgrade, or OS migration.</p></li><li class="listitem"><p>The created <code class="literal">systemd.service</code> triggers the OS upgrade process on the specific node.</p><div id="id-1.8.4.5.8.6.10.3.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Once the OS upgrade process finishes, the corresponding node will be <code class="literal">rebooted</code> to apply the updates on the system.</p></div></li></ol></div><p>Below you can find a diagram of the above description:</p><div class="informalfigure"><div class="mediaobject"><a href="images/fleet-day2-management-os-upgrade.png"><img src="images/fleet-day2-management-os-upgrade.png" width="100%" alt="fleet day2 management os upgrade" title="fleet day2 management os upgrade"/></a></div></div></section><section class="sect3" id="management-day2-fleet-os-upgrade-requirements" data-id-title="Requirements"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.4.3 </span><span class="title-name">Requirements</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-requirements">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>General:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>SCC registered machine</strong></span> - All management cluster nodes should be registered to <code class="literal"><a class="link" href="https://scc.suse.com/" target="_blank">https://scc.suse.com/</a></code> which is needed so that the respective <code class="literal">systemd.service</code> can successfully connect to the desired RPM repository.</p><div id="id-1.8.4.5.8.7.3.1.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>For Edge releases that require an OS version migration (e.g. <code class="literal">6.0</code> → <code class="literal">6.1</code>), make sure that your SCC key supports the migration to the new version.</p></div></li><li class="listitem"><p><span class="strong"><strong>Make sure that SUC Plan tolerations match node tolerations</strong></span> - If your Kubernetes cluster nodes have custom <span class="strong"><strong>taints</strong></span>, make sure to add <a class="link" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank">tolerations</a> for those taints in the <span class="strong"><strong>SUC Plans</strong></span>. By default, <span class="strong"><strong>SUC Plans</strong></span> have tolerations only for <span class="strong"><strong>control-plane</strong></span> nodes. Default tolerations include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>CriticalAddonsOnly=true:NoExecute</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/control-plane:NoSchedule</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/etcd:NoExecute</em></span></p><div id="id-1.8.4.5.8.7.3.2.2.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Any additional tolerations must be added under the <code class="literal">.spec.tolerations</code> section of each Plan. <span class="strong"><strong>SUC Plans</strong></span> related to the OS upgrade can be found in the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> repository under <code class="literal">fleets/day2/system-upgrade-controller-plans/os-upgrade</code>. <span class="strong"><strong>Make sure you use the Plans from a valid repository <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</strong></span></p><p>An example of defining custom tolerations for the <span class="strong"><strong>control-plane</strong></span> SUC Plan would look like this:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: os-upgrade-control-plane
spec:
  ...
  tolerations:
  # default tolerations
  - key: "CriticalAddonsOnly"
    operator: "Equal"
    value: "true"
    effect: "NoExecute"
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Equal"
    effect: "NoSchedule"
  - key: "node-role.kubernetes.io/etcd"
    operator: "Equal"
    effect: "NoExecute"
  # custom toleration
  - key: "foo"
    operator: "Equal"
    value: "bar"
    effect: "NoSchedule"
...</pre></div></div></li></ul></div></li></ol></div><p><span class="emphasis"><em>Air-gapped:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>Mirror SUSE RPM repositories</strong></span> - OS RPM repositories should be locally mirrored so that the <code class="literal">systemd.service</code> can have access to them. This can be achieved by using either <a class="link" href="https://documentation.suse.com/sles/15-SP6/html/SLES-all/book-rmt.html" target="_blank">RMT</a> or <a class="link" href="https://documentation.suse.com/suma/5.0/en/suse-manager/index.html" target="_blank">SUMA</a>.</p></li></ol></div></section><section class="sect3" id="management-day2-fleet-os-upgrade-plan-deployment" data-id-title="OS upgrade - SUC plan deployment"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.4.4 </span><span class="title-name">OS upgrade - SUC plan deployment</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.8.4.5.8.8.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>For environments previously upgraded using this procedure, users should ensure that <span class="strong"><strong>one</strong></span> of the following steps is completed:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">Remove any previously deployed SUC Plans related to older Edge release versions from the management cluster</code> - can be done by removing the desired cluster from the existing <code class="literal">GitRepo/Bundle</code> <a class="link" href="https://fleet.rancher.io/gitrepo-targets#target-matching" target="_blank">target configuration</a>, or removing the <code class="literal">GitRepo/Bundle</code> resource altogether.</p></li><li class="listitem"><p><code class="literal">Reuse the existing GitRepo/Bundle resource</code> - can be done by pointing the resource’s revision to a new tag that holds the correct fleets for the desired <code class="literal">suse-edge/fleet-examples</code> <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a>.</p></li></ul></div><p>This is done in order to avoid clashes between <code class="literal">SUC Plans</code> for older Edge release versions.</p><p>If users attempt to upgrade, while there are existing <code class="literal">SUC Plans</code> on the management cluster, they will see the following fleet error:</p><div class="verbatim-wrap highlight bash"><pre class="screen">Not installed: Unable to continue with install: Plan &lt;plan_name&gt; in namespace &lt;plan_namespace&gt; exists and cannot be imported into the current release: invalid ownership metadata; annotation validation error..</pre></div></div><p>As mentioned in <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-overview" title="36.2.4.2. Overview">Section 36.2.4.2, “Overview”</a>, OS upgrades are done by shipping <code class="literal">SUC plans</code> to the desired cluster through one of the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Fleet <code class="literal">GitRepo</code> resource - <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-gitrepo" title="36.2.4.4.1. SUC plan deployment - GitRepo resource">Section 36.2.4.4.1, “SUC plan deployment - GitRepo resource”</a>.</p></li><li class="listitem"><p>Fleet <code class="literal">Bundle</code> resource - <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-bundle" title="36.2.4.4.2. SUC plan deployment - Bundle resource">Section 36.2.4.4.2, “SUC plan deployment - Bundle resource”</a>.</p></li></ul></div><p>To determine which resource you should use, refer to <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-determine-use-case" title="36.2.2. Determine your use-case">Section 36.2.2, “Determine your use-case”</a>.</p><p>For use-cases where you wish to deploy the <code class="literal">OS SUC plans</code> from a third-party GitOps tool, refer to <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-third-party" title="36.2.4.4.3. SUC Plan deployment - third-party GitOps workflow">Section 36.2.4.4.3, “SUC Plan deployment - third-party GitOps workflow”</a></p><section class="sect4" id="management-day2-fleet-os-upgrade-plan-deployment-gitrepo" data-id-title="SUC plan deployment - GitRepo resource"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.4.4.1 </span><span class="title-name">SUC plan deployment - GitRepo resource</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-gitrepo">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>GitRepo</strong></span> resource, that ships the needed <code class="literal">OS SUC plans</code>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-gitrepo-rancher" title="36.2.4.4.1.1. GitRepo creation - Rancher UI">Section 36.2.4.4.1.1, “GitRepo creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-gitrepo-manual" title="36.2.4.4.1.2. GitRepo creation - manual">Section 36.2.4.4.1.2, “GitRepo creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the OS upgrade process of the nodes of your targeted cluster, refer to <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="22.3. Monitoring System Upgrade Controller Plans">Section 22.3, “Monitoring System Upgrade Controller Plans”</a>.</p><section class="sect5" id="management-day2-fleet-os-upgrade-plan-deployment-gitrepo-rancher" data-id-title="GitRepo creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.4.4.1.1 </span><span class="title-name">GitRepo creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-gitrepo-rancher">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>To create a <code class="literal">GitRepo</code> resource through the Rancher UI, follow their official <a class="link" href="https://ranchermanager.docs.rancher.com/v2.12/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">documentation</a>.</p><p>The Edge team maintains a ready to use <a class="link" href="https://github.com/suse-edge/fleet-examples/tree/release-3.4.0/fleets/day2/system-upgrade-controller-plans/os-upgrade" target="_blank">fleet</a>. Depending on your environment this fleet could be used directly or as a template.</p><div id="id-1.8.4.5.8.8.7.5.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Always use this fleet from a valid Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p>For use-cases where no custom changes need to be included to the <code class="literal">SUC plans</code> that the fleet ships, users can directly refer the <code class="literal">os-upgrade</code> fleet from the <code class="literal">suse-edge/fleet-examples</code> repository.</p><p>In cases where custom changes are needed (e.g. to add custom tolerations), users should refer the <code class="literal">os-upgrade</code> fleet from a separate repository, allowing them to add the changes to the SUC plans as required.</p><p>An example of how a <code class="literal">GitRepo</code> can be configured to use the fleet from the <code class="literal">suse-edge/fleet-examples</code> repository, can be viewed <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/gitrepos/day2/os-upgrade-gitrepo.yaml" target="_blank">here</a>.</p></section><section class="sect5" id="management-day2-fleet-os-upgrade-plan-deployment-gitrepo-manual" data-id-title="GitRepo creation - manual"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.4.4.1.2 </span><span class="title-name">GitRepo creation - manual</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-gitrepo-manual">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Pull the <span class="strong"><strong>GitRepo</strong></span> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o os-upgrade-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.4.0/gitrepos/day2/os-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>Edit the <span class="strong"><strong>GitRepo</strong></span> configuration:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Remove the <code class="literal">spec.targets</code> section - only needed for downstream clusters.</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Example using sed
sed -i.bak '/^  targets:/,$d' os-upgrade-gitrepo.yaml &amp;&amp; rm -f os-upgrade-gitrepo.yaml.bak

# Example using yq (v4+)
yq eval 'del(.spec.targets)' -i os-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>Point the namespace of the <code class="literal">GitRepo</code> to the <code class="literal">fleet-local</code> namespace - done in order to deploy the resource on the management cluster.</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Example using sed
sed -i.bak 's/namespace: fleet-default/namespace: fleet-local/' os-upgrade-gitrepo.yaml &amp;&amp; rm -f os-upgrade-gitrepo.yaml.bak

# Example using yq (v4+)
yq eval '.metadata.namespace = "fleet-local"' -i os-upgrade-gitrepo.yaml</pre></div></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>GitRepo</strong></span> resource your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f os-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>GitRepo</strong></span> resource under the <code class="literal">fleet-local</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get gitrepo os-upgrade -n fleet-local

# Example output
NAME            REPO                                              COMMIT         BUNDLEDEPLOYMENTS-READY   STATUS
os-upgrade      https://github.com/suse-edge/fleet-examples.git   release-3.4.0  0/0</pre></div></li></ol></div></section></section><section class="sect4" id="management-day2-fleet-os-upgrade-plan-deployment-bundle" data-id-title="SUC plan deployment - Bundle resource"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.4.4.2 </span><span class="title-name">SUC plan deployment - Bundle resource</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-bundle">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>Bundle</strong></span> resource, that ships the needed <code class="literal">OS SUC Plans</code>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-bundle-rancher" title="36.2.4.4.2.1. Bundle creation - Rancher UI">Section 36.2.4.4.2.1, “Bundle creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-bundle-manual" title="36.2.4.4.2.2. Bundle creation - manual">Section 36.2.4.4.2.2, “Bundle creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the OS upgrade process of the nodes of your targeted cluster, refer to <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="22.3. Monitoring System Upgrade Controller Plans">Section 22.3, “Monitoring System Upgrade Controller Plans”</a>.</p><section class="sect5" id="management-day2-fleet-os-upgrade-plan-deployment-bundle-rancher" data-id-title="Bundle creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.4.4.2.1 </span><span class="title-name">Bundle creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-bundle-rancher">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The Edge team maintains a ready to use <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/bundles/day2/system-upgrade-controller-plans/os-upgrade/os-upgrade-bundle.yaml" target="_blank">bundle</a> that can be used in the below steps.</p><div id="id-1.8.4.5.8.8.8.5.3" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Always use this bundle from a valid Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p>To create a bundle through Rancher’s UI:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, click <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Advanced</strong></span> &gt; <span class="strong"><strong>Bundles</strong></span></p></li><li class="listitem"><p>Select <span class="strong"><strong>Create from YAML</strong></span></p></li><li class="listitem"><p>From here you can create the Bundle in one of the following ways:</p><div id="id-1.8.4.5.8.8.8.5.5.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There might be use-cases where you would need to include custom changes to the <code class="literal">SUC plans</code> that the bundle ships (e.g. to add custom tolerations). Make sure to include those changes in the bundle that will be generated by the below steps.</p></div><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>By manually copying the <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.4.0/bundles/day2/system-upgrade-controller-plans/os-upgrade/os-upgrade-bundle.yaml" target="_blank">bundle content</a> from <code class="literal">suse-edge/fleet-examples</code> to the <span class="strong"><strong>Create from YAML</strong></span> page.</p></li><li class="listitem"><p>By cloning the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> repository from the desired <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag and selecting the <span class="strong"><strong>Read from File</strong></span> option in the <span class="strong"><strong>Create from YAML</strong></span> page. From there, navigate to the bundle location (<code class="literal">bundles/day2/system-upgrade-controller-plans/os-upgrade</code>) and select the bundle file. This will auto-populate the <span class="strong"><strong>Create from YAML</strong></span> page with the bundle content.</p></li></ol></div></li><li class="listitem"><p>Edit the Bundle in the Rancher UI:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Change the <span class="strong"><strong>namespace</strong></span> of the <code class="literal">Bundle</code> to point to the <code class="literal">fleet-local</code> namespace.</p><div class="verbatim-wrap highlight yaml"><pre class="screen"># Example
kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: os-upgrade
  namespace: fleet-local
...</pre></div></li><li class="listitem"><p>Change the <span class="strong"><strong>target</strong></span> clusters for the <code class="literal">Bundle</code> to point to your <code class="literal">local</code>(management) cluster:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterName: local</pre></div><div id="id-1.8.4.5.8.8.8.5.5.5.2.2.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There are some use-cases where your <code class="literal">local</code> cluster could have a different name.</p><p>To retrieve your <code class="literal">local</code> cluster name, execute the command below:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get clusters.fleet.cattle.io -n fleet-local</pre></div></div></li></ul></div></li><li class="listitem"><p>Select <span class="strong"><strong>Create</strong></span></p></li></ol></div></section><section class="sect5" id="management-day2-fleet-os-upgrade-plan-deployment-bundle-manual" data-id-title="Bundle creation - manual"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.4.4.2.2 </span><span class="title-name">Bundle creation - manual</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-bundle-manual">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Pull the <span class="strong"><strong>Bundle</strong></span> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o os-upgrade-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.4.0/bundles/day2/system-upgrade-controller-plans/os-upgrade/os-upgrade-bundle.yaml</pre></div></li><li class="listitem"><p>Edit the <code class="literal">Bundle</code> configuration:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Change the <span class="strong"><strong>target</strong></span> clusters for the <code class="literal">Bundle</code> to point to your <code class="literal">local</code>(management) cluster:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterName: local</pre></div><div id="id-1.8.4.5.8.8.8.6.2.2.2.1.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There are some use-cases where your <code class="literal">local</code> cluster could have a different name.</p><p>To retrieve your <code class="literal">local</code> cluster name, execute the command below:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get clusters.fleet.cattle.io -n fleet-local</pre></div></div></li><li class="listitem"><p>Change the <span class="strong"><strong>namespace</strong></span> of the <code class="literal">Bundle</code> to point to the <code class="literal">fleet-local</code> namespace.</p><div class="verbatim-wrap highlight yaml"><pre class="screen"># Example
kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: os-upgrade
  namespace: fleet-local
...</pre></div></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>Bundle</strong></span> resource to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f os-upgrade-bundle.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>Bundle</strong></span> resource under the <code class="literal">fleet-local</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get bundles -n fleet-local</pre></div></li></ol></div></section></section><section class="sect4" id="management-day2-fleet-os-upgrade-plan-deployment-third-party" data-id-title="SUC Plan deployment - third-party GitOps workflow"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.4.4.3 </span><span class="title-name">SUC Plan deployment - third-party GitOps workflow</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-plan-deployment-third-party">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>There might be use-cases where users would like to incorporate the <code class="literal">OS SUC plans</code> to their own third-party GitOps workflow (e.g. <code class="literal">Flux</code>).</p><p>To get the OS upgrade resources that you need, first determine the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag of the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> repository that you would like to use.</p><p>After that, resources can be found at <code class="literal">fleets/day2/system-upgrade-controller-plans/os-upgrade</code>, where:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">plan-control-plane.yaml</code> is a SUC plan resource for <span class="strong"><strong>control-plane</strong></span> nodes.</p></li><li class="listitem"><p><code class="literal">plan-worker.yaml</code> is a SUC plan resource for <span class="strong"><strong>worker</strong></span> nodes.</p></li><li class="listitem"><p><code class="literal">secret.yaml</code> is a Secret that contains the <code class="literal">upgrade.sh</code> script, which is responsible for creating the systemd.service (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-components-systemd-service" title="36.2.4.1.1. systemd.service">Section 36.2.4.1.1, “systemd.service”</a>).</p></li><li class="listitem"><p><code class="literal">config-map.yaml</code> is a ConfigMap that holds configurations that are consumed by the <code class="literal">upgrade.sh</code> script.</p></li></ul></div><div id="id-1.8.4.5.8.8.9.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>These <code class="literal">Plan</code> resources are interpreted by the <code class="literal">System Upgrade Controller</code> and should be deployed on each downstream cluster that you wish to upgrade. For SUC deployment information, see <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-install" title="22.2. Installing the System Upgrade Controller">Section 22.2, “Installing the System Upgrade Controller”</a>.</p></div><p>To better understand how your GitOps workflow can be used to deploy the <span class="strong"><strong>SUC Plans</strong></span> for OS upgrade, it can be beneficial to take a look at overview (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-os-upgrade-overview" title="36.2.4.2. Overview">Section 36.2.4.2, “Overview”</a>).</p></section></section></section><section class="sect2" id="management-day2-fleet-k8s-upgrade" data-id-title="Kubernetes version upgrade"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">36.2.5 </span><span class="title-name">Kubernetes version upgrade</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section describes how to perform a Kubernetes upgrade using <a class="xref" href="components-fleet.html" title="Chapter 8. Fleet">Chapter 8, <em>Fleet</em></a> and the <a class="xref" href="components-system-upgrade-controller.html" title="Chapter 22. System Upgrade Controller">Chapter 22, <em>System Upgrade Controller</em></a>.</p><p>The following topics are covered as part of this section:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-components" title="36.2.5.1. Components">Section 36.2.5.1, “Components”</a> - additional components used by the upgrade process.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-overview" title="36.2.5.2. Overview">Section 36.2.5.2, “Overview”</a> - overview of the upgrade process.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-requirements" title="36.2.5.3. Requirements">Section 36.2.5.3, “Requirements”</a> - requirements of the upgrade process.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment" title="36.2.5.4. K8s upgrade - SUC plan deployment">Section 36.2.5.4, “K8s upgrade - SUC plan deployment”</a> - information on how to deploy <code class="literal">SUC plans</code>, responsible for triggering the upgrade process.</p></li></ol></div><section class="sect3" id="management-day2-fleet-k8s-upgrade-components" data-id-title="Components"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.5.1 </span><span class="title-name">Components</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-components">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers the custom components that the <code class="literal">K8s upgrade</code> process uses over the default "Day 2" components (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-components" title="36.2.1. Components">Section 36.2.1, “Components”</a>).</p><section class="sect4" id="management-day2-fleet-k8s-upgrade-components-rke2-upgrade" data-id-title="rke2-upgrade"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.5.1.1 </span><span class="title-name">rke2-upgrade</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-components-rke2-upgrade">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Container image responsible for upgrading the RKE2 version of a specific node.</p><p>Shipped through a Pod created by <span class="strong"><strong>SUC</strong></span> based on a <span class="strong"><strong>SUC Plan</strong></span>. The Plan should be located on each <span class="strong"><strong>cluster</strong></span> that is in need of a RKE2 upgrade.</p><p>For more information regarding how the <code class="literal">rke2-upgrade</code> image performs the upgrade, see the <a class="link" href="https://github.com/rancher/rke2-upgrade/tree/master" target="_blank">upstream</a> documentation.</p></section><section class="sect4" id="management-day2-fleet-k8s-upgrade-components-k3s-upgrade" data-id-title="k3s-upgrade"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.5.1.2 </span><span class="title-name">k3s-upgrade</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-components-k3s-upgrade">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Container image responsible for upgrading the K3s version of a specific node.</p><p>Shipped through a Pod created by <span class="strong"><strong>SUC</strong></span> based on a <span class="strong"><strong>SUC Plan</strong></span>. The Plan should be located on each <span class="strong"><strong>cluster</strong></span> that is in need of a K3s upgrade.</p><p>For more information regarding how the <code class="literal">k3s-upgrade</code> image performs the upgrade, see the <a class="link" href="https://github.com/k3s-io/k3s-upgrade" target="_blank">upstream</a> documentation.</p></section></section><section class="sect3" id="management-day2-fleet-k8s-upgrade-overview" data-id-title="Overview"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.5.2 </span><span class="title-name">Overview</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-overview">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The Kubernetes distribution upgrade for management cluster nodes is done by utilizing <code class="literal">Fleet</code> and the <code class="literal">System Upgrade Controller (SUC)</code>.</p><p><code class="literal">Fleet</code> is used to deploy and manage <code class="literal">SUC plans</code> onto the desired cluster.</p><div id="id-1.8.4.5.9.6.4" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p><code class="literal">SUC plans</code> are <a class="link" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank">custom resources</a> that describe the steps that <span class="strong"><strong>SUC</strong></span> needs to follow in order for a specific task to be executed on a set of nodes. For an example of how an <code class="literal">SUC plan</code> looks like, refer to the <a class="link" href="https://github.com/rancher/system-upgrade-controller?tab=readme-ov-file#example-plans" target="_blank">upstream repository</a>.</p></div><p>The <code class="literal">K8s SUC plans</code> are shipped on each cluster by deploying a <a class="link" href="https://fleet.rancher.io/gitrepo-add" target="_blank">GitRepo</a> or <a class="link" href="https://fleet.rancher.io/bundle-add" target="_blank">Bundle</a> resource to a specific Fleet <a class="link" href="https://fleet.rancher.io/namespaces#gitrepos-bundles-clusters-clustergroups" target="_blank">workspace</a>. Fleet retrieves the deployed <code class="literal">GitRepo/Bundle</code> and deploys its contents (the <code class="literal">K8s SUC plans</code>) to the desired cluster(s).</p><div id="id-1.8.4.5.9.6.6" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p><code class="literal">GitRepo/Bundle</code> resources are always deployed on the <code class="literal">management cluster</code>. Whether to use a <code class="literal">GitRepo</code> or <code class="literal">Bundle</code> resource depends on your use-case, check <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-determine-use-case" title="36.2.2. Determine your use-case">Section 36.2.2, “Determine your use-case”</a> for more information.</p></div><p><code class="literal">K8s SUC plans</code> describe the following workflow:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Always <a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cordon/" target="_blank">cordon</a> the nodes before K8s upgrades.</p></li><li class="listitem"><p>Always upgrade <code class="literal">control-plane</code> nodes before <code class="literal">worker</code> nodes.</p></li><li class="listitem"><p>Always upgrade the <code class="literal">control-plane</code> nodes <span class="strong"><strong>one</strong></span> node at a time and the <code class="literal">worker</code> nodes <span class="strong"><strong>two</strong></span> nodes at a time.</p></li></ol></div><p>Once the <code class="literal">K8s SUC plans</code> are deployed, the workflow looks like this:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>SUC reconciles the deployed <code class="literal">K8s SUC plans</code> and creates a <code class="literal">Kubernetes Job</code> on <span class="strong"><strong>each node</strong></span>.</p></li><li class="listitem"><p>Depending on the Kubernetes distribution, the Job will create a Pod that runs either the rke2-upgrade (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-components-rke2-upgrade" title="36.2.5.1.1. rke2-upgrade">Section 36.2.5.1.1, “rke2-upgrade”</a>) or the k3s-upgrade (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-components-k3s-upgrade" title="36.2.5.1.2. k3s-upgrade">Section 36.2.5.1.2, “k3s-upgrade”</a>) container image.</p></li><li class="listitem"><p>The created Pod will go through the following workflow:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Replace the existing <code class="literal">rke2/k3s</code> binary on the node with the one from the <code class="literal">rke2-upgrade/k3s-upgrade</code> image.</p></li><li class="listitem"><p>Kill the running <code class="literal">rke2/k3s</code> process.</p></li></ol></div></li><li class="listitem"><p>Killing the <code class="literal">rke2/k3s</code> process triggers a restart, launching a new process that runs the updated binary, resulting in an upgraded Kubernetes distribution version.</p></li></ol></div><p>Below you can find a diagram of the above description:</p><div class="informalfigure"><div class="mediaobject"><a href="images/fleet-day2-management-k8s-upgrade.png"><img src="images/fleet-day2-management-k8s-upgrade.png" width="100%" alt="fleet day2 management k8s upgrade" title="fleet day2 management k8s upgrade"/></a></div></div></section><section class="sect3" id="management-day2-fleet-k8s-upgrade-requirements" data-id-title="Requirements"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.5.3 </span><span class="title-name">Requirements</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-requirements">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="strong"><strong>Backup your Kubernetes distribution:</strong></span></p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>For <span class="strong"><strong>RKE2 clusters</strong></span>, see the <a class="link" href="https://docs.rke2.io/datastore/backup_restore" target="_blank">RKE2 Backup and Restore</a> documentation.</p></li><li class="listitem"><p>For <span class="strong"><strong>K3s clusters</strong></span>, see the <a class="link" href="https://docs.k3s.io/datastore/backup-restore" target="_blank">K3s Backup and Restore</a> documentation.</p></li></ol></div></li><li class="listitem"><p><span class="strong"><strong>Make sure that SUC Plan tolerations match node tolerations</strong></span> - If your Kubernetes cluster nodes have custom <span class="strong"><strong>taints</strong></span>, make sure to add <a class="link" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank">tolerations</a> for those taints in the <span class="strong"><strong>SUC Plans</strong></span>. By default <span class="strong"><strong>SUC Plans</strong></span> have tolerations only for <span class="strong"><strong>control-plane</strong></span> nodes. Default tolerations include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>CriticalAddonsOnly=true:NoExecute</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/control-plane:NoSchedule</em></span></p></li><li class="listitem"><p><span class="emphasis"><em>node-role.kubernetes.io/etcd:NoExecute</em></span></p><div id="id-1.8.4.5.9.7.2.2.2.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Any additional tolerations must be added under the <code class="literal">.spec.tolerations</code> section of each Plan. <span class="strong"><strong>SUC Plans</strong></span> related to the Kubernetes version upgrade can be found in the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> repository under:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <span class="strong"><strong>RKE2</strong></span> - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade</code></p></li><li class="listitem"><p>For <span class="strong"><strong>K3s</strong></span>  - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade</code></p></li></ul></div><p><span class="strong"><strong>Make sure you use the Plans from a valid repository <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</strong></span></p><p>An example of defining custom tolerations for the RKE2 <span class="strong"><strong>control-plane</strong></span> SUC Plan, would look like this:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: rke2-upgrade-control-plane
spec:
  ...
  tolerations:
  # default tolerations
  - key: "CriticalAddonsOnly"
    operator: "Equal"
    value: "true"
    effect: "NoExecute"
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Equal"
    effect: "NoSchedule"
  - key: "node-role.kubernetes.io/etcd"
    operator: "Equal"
    effect: "NoExecute"
  # custom toleration
  - key: "foo"
    operator: "Equal"
    value: "bar"
    effect: "NoSchedule"
...</pre></div></div></li></ul></div></li></ol></div></section><section class="sect3" id="management-day2-fleet-k8s-upgrade-plan-deployment" data-id-title="K8s upgrade - SUC plan deployment"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.5.4 </span><span class="title-name">K8s upgrade - SUC plan deployment</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.8.4.5.9.8.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>For environments previously upgraded using this procedure, users should ensure that <span class="strong"><strong>one</strong></span> of the following steps is completed:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">Remove any previously deployed SUC Plans related to older Edge release versions from the management cluster</code> - can be done by removing the desired cluster from the existing <code class="literal">GitRepo/Bundle</code> <a class="link" href="https://fleet.rancher.io/gitrepo-targets#target-matching" target="_blank">target configuration</a>, or removing the <code class="literal">GitRepo/Bundle</code> resource altogether.</p></li><li class="listitem"><p><code class="literal">Reuse the existing GitRepo/Bundle resource</code> - can be done by pointing the resource’s revision to a new tag that holds the correct fleets for the desired <code class="literal">suse-edge/fleet-examples</code> <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a>.</p></li></ul></div><p>This is done in order to avoid clashes between <code class="literal">SUC Plans</code> for older Edge release versions.</p><p>If users attempt to upgrade, while there are existing <code class="literal">SUC Plans</code> on the management cluster, they will see the following fleet error:</p><div class="verbatim-wrap highlight bash"><pre class="screen">Not installed: Unable to continue with install: Plan &lt;plan_name&gt; in namespace &lt;plan_namespace&gt; exists and cannot be imported into the current release: invalid ownership metadata; annotation validation error..</pre></div></div><p>As mentioned in <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-overview" title="36.2.5.2. Overview">Section 36.2.5.2, “Overview”</a>, Kubernetes upgrades are done by shipping <code class="literal">SUC plans</code> to the desired cluster through one of the following ways:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Fleet GitRepo resource (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-gitrepo" title="36.2.5.4.1. SUC plan deployment - GitRepo resource">Section 36.2.5.4.1, “SUC plan deployment - GitRepo resource”</a>)</p></li><li class="listitem"><p>Fleet Bundle resource (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-bundle" title="36.2.5.4.2. SUC plan deployment - Bundle resource">Section 36.2.5.4.2, “SUC plan deployment - Bundle resource”</a>)</p></li></ul></div><p>To determine which resource you should use, refer to <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-determine-use-case" title="36.2.2. Determine your use-case">Section 36.2.2, “Determine your use-case”</a>.</p><p>For use-cases where you wish to deploy the <code class="literal">K8s SUC plans</code> from a third-party GitOps tool, refer to <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-third-party" title="36.2.5.4.3. SUC Plan deployment - third-party GitOps workflow">Section 36.2.5.4.3, “SUC Plan deployment - third-party GitOps workflow”</a></p><section class="sect4" id="management-day2-fleet-k8s-upgrade-plan-deployment-gitrepo" data-id-title="SUC plan deployment - GitRepo resource"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.5.4.1 </span><span class="title-name">SUC plan deployment - GitRepo resource</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-gitrepo">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>GitRepo</strong></span> resource, that ships the needed <code class="literal">K8s SUC plans</code>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-gitrepo-rancher" title="36.2.5.4.1.1. GitRepo creation - Rancher UI">Section 36.2.5.4.1.1, “GitRepo creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-gitrepo-manual" title="36.2.5.4.1.2. GitRepo creation - manual">Section 36.2.5.4.1.2, “GitRepo creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the Kubernetes upgrade process of the nodes of your targeted cluster, refer to <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="22.3. Monitoring System Upgrade Controller Plans">Section 22.3, “Monitoring System Upgrade Controller Plans”</a>.</p><section class="sect5" id="management-day2-fleet-k8s-upgrade-plan-deployment-gitrepo-rancher" data-id-title="GitRepo creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.5.4.1.1 </span><span class="title-name">GitRepo creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-gitrepo-rancher">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>To create a <code class="literal">GitRepo</code> resource through the Rancher UI, follow their official <a class="link" href="https://ranchermanager.docs.rancher.com/v2.12/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">documentation</a>.</p><p>The Edge team maintains ready to use fleets for both <a class="link" href="https://github.com/suse-edge/fleet-examples/tree/release-3.4.0/fleets/day2/system-upgrade-controller-plans/rke2-upgrade" target="_blank">rke2</a> and <a class="link" href="https://github.com/suse-edge/fleet-examples/tree/release-3.4.0/fleets/day2/system-upgrade-controller-plans/k3s-upgrade" target="_blank">k3s</a> Kubernetes distributions. Depending on your environment, this fleet could be used directly or as a template.</p><div id="id-1.8.4.5.9.8.7.5.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Always use these fleets from a valid Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p>For use-cases where no custom changes need to be included to the <code class="literal">SUC plans</code> that these fleets ship, users can directly refer the fleets from the <code class="literal">suse-edge/fleet-examples</code> repository.</p><p>In cases where custom changes are needed (e.g. to add custom tolerations), users should refer the fleets from a separate repository, allowing them to add the changes to the SUC plans as required.</p><p>Configuration examples for a <code class="literal">GitRepo</code> resource using the fleets from <code class="literal">suse-edge/fleet-examples</code> repository:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/gitrepos/day2/rke2-upgrade-gitrepo.yaml" target="_blank">RKE2</a></p></li><li class="listitem"><p><a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/gitrepos/day2/k3s-upgrade-gitrepo.yaml" target="_blank">K3s</a></p></li></ul></div></section><section class="sect5" id="management-day2-fleet-k8s-upgrade-plan-deployment-gitrepo-manual" data-id-title="GitRepo creation - manual"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.5.4.1.2 </span><span class="title-name">GitRepo creation - manual</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-gitrepo-manual">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Pull the <span class="strong"><strong>GitRepo</strong></span> resource:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <span class="strong"><strong>RKE2</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o rke2-upgrade-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.4.0/gitrepos/day2/rke2-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>For <span class="strong"><strong>K3s</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o k3s-upgrade-gitrepo.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.4.0/gitrepos/day2/k3s-upgrade-gitrepo.yaml</pre></div></li></ul></div></li><li class="listitem"><p>Edit the <span class="strong"><strong>GitRepo</strong></span> configuration:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Remove the <code class="literal">spec.targets</code> section - only needed for downstream clusters.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For RKE2:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Example using sed
sed -i.bak '/^  targets:/,$d' rke2-upgrade-gitrepo.yaml &amp;&amp; rm -f rke2-upgrade-gitrepo.yaml.bak

# Example using yq (v4+)
yq eval 'del(.spec.targets)' -i rke2-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>For K3s:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Example using sed
sed -i.bak '/^  targets:/,$d' k3s-upgrade-gitrepo.yaml &amp;&amp; rm -f k3s-upgrade-gitrepo.yaml.bak

# Example using yq (v4+)
yq eval 'del(.spec.targets)' -i k3s-upgrade-gitrepo.yaml</pre></div></li></ul></div></li><li class="listitem"><p>Point the namespace of the <code class="literal">GitRepo</code> to the <code class="literal">fleet-local</code> namespace - done in order to deploy the resource on the management cluster.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For RKE2:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Example using sed
sed -i.bak 's/namespace: fleet-default/namespace: fleet-local/' rke2-upgrade-gitrepo.yaml &amp;&amp; rm -f rke2-upgrade-gitrepo.yaml.bak

# Example using yq (v4+)
yq eval '.metadata.namespace = "fleet-local"' -i rke2-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>For K3s:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># Example using sed
sed -i.bak 's/namespace: fleet-default/namespace: fleet-local/' k3s-upgrade-gitrepo.yaml &amp;&amp; rm -f k3s-upgrade-gitrepo.yaml.bak

# Example using yq (v4+)
yq eval '.metadata.namespace = "fleet-local"' -i k3s-upgrade-gitrepo.yaml</pre></div></li></ul></div></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>GitRepo</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># RKE2
kubectl apply -f rke2-upgrade-gitrepo.yaml

# K3s
kubectl apply -f k3s-upgrade-gitrepo.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>GitRepo</strong></span> resource under the <code class="literal">fleet-local</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># RKE2
kubectl get gitrepo rke2-upgrade -n fleet-local

# K3s
kubectl get gitrepo k3s-upgrade -n fleet-local

# Example output
NAME           REPO                                              COMMIT          BUNDLEDEPLOYMENTS-READY   STATUS
k3s-upgrade    https://github.com/suse-edge/fleet-examples.git   fleet-local   0/0
rke2-upgrade   https://github.com/suse-edge/fleet-examples.git   fleet-local   0/0</pre></div></li></ol></div></section></section><section class="sect4" id="management-day2-fleet-k8s-upgrade-plan-deployment-bundle" data-id-title="SUC plan deployment - Bundle resource"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.5.4.2 </span><span class="title-name">SUC plan deployment - Bundle resource</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-bundle">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>A <span class="strong"><strong>Bundle</strong></span> resource, that ships the needed <code class="literal">Kubernetes upgrade SUC Plans</code>, can be deployed in one of the following ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Through the <code class="literal">Rancher UI</code> - <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-bundle-rancher" title="36.2.5.4.2.1. Bundle creation - Rancher UI">Section 36.2.5.4.2.1, “Bundle creation - Rancher UI”</a> (when <code class="literal">Rancher</code> is available).</p></li><li class="listitem"><p>By manually deploying (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-bundle-manual" title="36.2.5.4.2.2. Bundle creation - manual">Section 36.2.5.4.2.2, “Bundle creation - manual”</a>) the resource to your <code class="literal">management cluster</code>.</p></li></ol></div><p>Once deployed, to monitor the Kubernetes upgrade process of the nodes of your targeted cluster, refer to <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-monitor-plans" title="22.3. Monitoring System Upgrade Controller Plans">Section 22.3, “Monitoring System Upgrade Controller Plans”</a>.</p><section class="sect5" id="management-day2-fleet-k8s-upgrade-plan-deployment-bundle-rancher" data-id-title="Bundle creation - Rancher UI"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.5.4.2.1 </span><span class="title-name">Bundle creation - Rancher UI</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-bundle-rancher">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>The Edge team maintains ready to use bundles for both <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml" target="_blank">rke2</a> and <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml" target="_blank">k3s</a> Kubernetes distributions. Depending on your environment these bundles could be used directly or as a template.</p><div id="id-1.8.4.5.9.8.8.5.3" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Always use this bundle from a valid Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag.</p></div><p>To create a bundle through Rancher’s UI:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>In the upper left corner, click <span class="strong"><strong>☰ → Continuous Delivery</strong></span></p></li><li class="listitem"><p>Go to <span class="strong"><strong>Advanced</strong></span> &gt; <span class="strong"><strong>Bundles</strong></span></p></li><li class="listitem"><p>Select <span class="strong"><strong>Create from YAML</strong></span></p></li><li class="listitem"><p>From here you can create the Bundle in one of the following ways:</p><div id="id-1.8.4.5.9.8.8.5.5.4.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There might be use-cases where you would need to include custom changes to the <code class="literal">SUC plans</code> that the bundle ships (e.g. to add custom tolerations). Make sure to include those changes in the bundle that will be generated by the below steps.</p></div><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>By manually copying the bundle content for <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.4.0/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml" target="_blank">RKE2</a> or <a class="link" href="https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.4.0/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml" target="_blank">K3s</a> from <code class="literal">suse-edge/fleet-examples</code> to the <span class="strong"><strong>Create from YAML</strong></span> page.</p></li><li class="listitem"><p>By cloning the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository from the desired <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag and selecting the <span class="strong"><strong>Read from File</strong></span> option in the <span class="strong"><strong>Create from YAML</strong></span> page. From there, navigate to the bundle that you need (<code class="literal">bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml</code> for RKE2 and <code class="literal">bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml</code> for K3s). This will auto-populate the <span class="strong"><strong>Create from YAML</strong></span> page with the bundle content.</p></li></ol></div></li><li class="listitem"><p>Edit the Bundle in the Rancher UI:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Change the <span class="strong"><strong>namespace</strong></span> of the <code class="literal">Bundle</code> to point to the <code class="literal">fleet-local</code> namespace.</p><div class="verbatim-wrap highlight yaml"><pre class="screen"># Example
kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: rke2-upgrade
  namespace: fleet-local
...</pre></div></li><li class="listitem"><p>Change the <span class="strong"><strong>target</strong></span> clusters for the <code class="literal">Bundle</code> to point to your <code class="literal">local</code>(management) cluster:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterName: local</pre></div><div id="id-1.8.4.5.9.8.8.5.5.5.2.2.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There are some use-cases where your <code class="literal">local</code> cluster could have a different name.</p><p>To retrieve your <code class="literal">local</code> cluster name, execute the command below:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get clusters.fleet.cattle.io -n fleet-local</pre></div></div></li></ul></div></li><li class="listitem"><p>Select <span class="strong"><strong>Create</strong></span></p></li></ol></div></section><section class="sect5" id="management-day2-fleet-k8s-upgrade-plan-deployment-bundle-manual" data-id-title="Bundle creation - manual"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.5.4.2.2 </span><span class="title-name">Bundle creation - manual</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-bundle-manual">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Pull the <span class="strong"><strong>Bundle</strong></span> resources:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <span class="strong"><strong>RKE2</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o rke2-plan-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.4.0/bundles/day2/system-upgrade-controller-plans/rke2-upgrade/plan-bundle.yaml</pre></div></li><li class="listitem"><p>For <span class="strong"><strong>K3s</strong></span> clusters:</p><div class="verbatim-wrap highlight bash"><pre class="screen">curl -o k3s-plan-bundle.yaml https://raw.githubusercontent.com/suse-edge/fleet-examples/refs/tags/release-3.4.0/bundles/day2/system-upgrade-controller-plans/k3s-upgrade/plan-bundle.yaml</pre></div></li></ul></div></li><li class="listitem"><p>Edit the <code class="literal">Bundle</code> configuration:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Change the <span class="strong"><strong>target</strong></span> clusters for the <code class="literal">Bundle</code> to point to your <code class="literal">local</code>(management) cluster:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">spec:
  targets:
  - clusterName: local</pre></div><div id="id-1.8.4.5.9.8.8.6.2.2.2.1.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There are some use-cases where your <code class="literal">local</code> cluster could have a different name.</p><p>To retrieve your <code class="literal">local</code> cluster name, execute the command below:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get clusters.fleet.cattle.io -n fleet-local</pre></div></div></li><li class="listitem"><p>Change the <span class="strong"><strong>namespace</strong></span> of the <code class="literal">Bundle</code> to point to the <code class="literal">fleet-local</code> namespace.</p><div class="verbatim-wrap highlight yaml"><pre class="screen"># Example
kind: Bundle
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: rke2-upgrade
  namespace: fleet-local
...</pre></div></li></ul></div></li><li class="listitem"><p>Apply the <span class="strong"><strong>Bundle</strong></span> resources to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For RKE2
kubectl apply -f rke2-plan-bundle.yaml

# For K3s
kubectl apply -f k3s-plan-bundle.yaml</pre></div></li><li class="listitem"><p>View the created <span class="strong"><strong>Bundle</strong></span> resource under the <code class="literal">fleet-local</code> namespace:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># For RKE2
kubectl get bundles rke2-upgrade -n fleet-local

# For K3s
kubectl get bundles k3s-upgrade -n fleet-local

# Example output
NAME           BUNDLEDEPLOYMENTS-READY   STATUS
k3s-upgrade    0/0
rke2-upgrade   0/0</pre></div></li></ol></div></section></section><section class="sect4" id="management-day2-fleet-k8s-upgrade-plan-deployment-third-party" data-id-title="SUC Plan deployment - third-party GitOps workflow"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.5.4.3 </span><span class="title-name">SUC Plan deployment - third-party GitOps workflow</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-plan-deployment-third-party">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>There might be use-cases where users would like to incorporate the <code class="literal">Kubernetes upgrade SUC plans</code> to their own third-party GitOps workflow (e.g. <code class="literal">Flux</code>).</p><p>To get the K8s upgrade resources that you need, first determine the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag of the <a class="link" href="https://github.com/suse-edge/fleet-examples.git" target="_blank">suse-edge/fleet-examples</a> repository that you would like to use.</p><p>After that, the resources can be found at:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For a RKE2 cluster upgrade:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">control-plane</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade/plan-control-plane.yaml</code></p></li><li class="listitem"><p>For <code class="literal">worker</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/rke2-upgrade/plan-worker.yaml</code></p></li></ul></div></li><li class="listitem"><p>For a K3s cluster upgrade:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>For <code class="literal">control-plane</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade/plan-control-plane.yaml</code></p></li><li class="listitem"><p>For <code class="literal">worker</code> nodes - <code class="literal">fleets/day2/system-upgrade-controller-plans/k3s-upgrade/plan-worker.yaml</code></p></li></ul></div></li></ul></div><div id="id-1.8.4.5.9.8.9.6" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>These <code class="literal">Plan</code> resources are interpreted by the <code class="literal">System Upgrade Controller</code> and should be deployed on each downstream cluster that you wish to upgrade. For SUC deployment information, see <a class="xref" href="components-system-upgrade-controller.html#components-system-upgrade-controller-install" title="22.2. Installing the System Upgrade Controller">Section 22.2, “Installing the System Upgrade Controller”</a>.</p></div><p>To better understand how your GitOps workflow can be used to deploy the <span class="strong"><strong>SUC Plans</strong></span> for Kubernetes version upgrade, it can be beneficial to take a look at the overview (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-k8s-upgrade-overview" title="36.2.5.2. Overview">Section 36.2.5.2, “Overview”</a>) of the update procedure using <code class="literal">Fleet</code>.</p></section></section></section><section class="sect2" id="management-day2-fleet-helm-upgrade" data-id-title="Helm chart upgrade"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">36.2.6 </span><span class="title-name">Helm chart upgrade</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers the following parts:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-air-gap" title="36.2.6.1. Preparation for air-gapped environments">Section 36.2.6.1, “Preparation for air-gapped environments”</a> - holds information on how to ship Edge related OCI charts and images to your private registry.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure" title="36.2.6.2. Upgrade procedure">Section 36.2.6.2, “Upgrade procedure”</a> - holds information on different Helm chart upgrade use-cases and their upgrade procedure.</p></li></ol></div><section class="sect3" id="management-day2-fleet-helm-upgrade-air-gap" data-id-title="Preparation for air-gapped environments"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.6.1 </span><span class="title-name">Preparation for air-gapped environments</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-air-gap">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><section class="sect4" id="id-ensure-you-have-access-to-your-helm-chart-fleet" data-id-title="Ensure you have access to your Helm chart Fleet"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.1.1 </span><span class="title-name">Ensure you have access to your Helm chart Fleet</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-ensure-you-have-access-to-your-helm-chart-fleet">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Depending on what your environment supports, you can take one of the following options:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Host your chart’s Fleet resources on a local Git server that is accessible by your <code class="literal">management cluster</code>.</p></li><li class="listitem"><p>Use Fleet’s CLI to <a class="link" href="https://fleet.rancher.io/bundle-add#convert-a-helm-chart-into-a-bundle" target="_blank">convert a Helm chart into a Bundle</a> that you can directly use and will not need to be hosted somewhere. Fleet’s CLI can be retrieved from their <a class="link" href="https://github.com/rancher/fleet/releases/tag/v0.13.1" target="_blank">release</a> page, for Mac users there is a <a class="link" href="https://formulae.brew.sh/formula/fleet-cli" target="_blank">fleet-cli</a> Homebrew Formulae.</p></li></ol></div></section><section class="sect4" id="id-find-the-required-assets-for-your-edge-release-version" data-id-title="Find the required assets for your Edge release version"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.1.2 </span><span class="title-name">Find the required assets for your Edge release version</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-find-the-required-assets-for-your-edge-release-version">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Go to the "Day 2" <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> page and find the Edge release that you want to upgrade your chart to and click <span class="strong"><strong>Assets</strong></span>.</p></li><li class="listitem"><p>From the <span class="strong"><strong>"Assets"</strong></span> section, download the following files:</p><div class="informaltable"><table style="border-collapse: collapse; border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><colgroup><col class="col_1"/><col class="col_2"/></colgroup><tbody><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="strong"><strong>Release File</strong></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p><span class="strong"><strong>Description</strong></span></p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-save-images.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Pulls the images specified in the <code class="literal">edge-release-images.txt</code> file and packages them inside of a '.tar.gz' archive.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-save-oci-artefacts.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Pulls the OCI chart images related to the specific Edge release and packages them inside of a '.tar.gz' archive.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-load-images.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Loads images from a '.tar.gz' archive, retags and pushes them to a private registry.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-load-oci-artefacts.sh</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Takes a directory containing Edge OCI '.tgz' chart packages and loads them to a private registry.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; border-bottom: 1px solid ; "><p><span class="emphasis"><em>edge-release-helm-oci-artefacts.txt</em></span></p></td><td style="text-align: left; vertical-align: top; border-bottom: 1px solid ; "><p>Contains a list of OCI chart images related to a specific Edge release.</p></td></tr><tr><td style="text-align: left; vertical-align: top; border-right: 1px solid ; "><p><span class="emphasis"><em>edge-release-images.txt</em></span></p></td><td style="text-align: left; vertical-align: top; "><p>Contains a list of images related to a specific Edge release.</p></td></tr></tbody></table></div></li></ol></div></section><section class="sect4" id="id-create-the-edge-release-images-archive" data-id-title="Create the Edge release images archive"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.1.3 </span><span class="title-name">Create the Edge release images archive</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-create-the-edge-release-images-archive">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On a machine with internet access:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Make <code class="literal">edge-save-images.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-save-images.sh</pre></div></li><li class="listitem"><p>Generate the image archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-save-images.sh --source-registry registry.suse.com</pre></div></li><li class="listitem"><p>This will create a ready to load archive named <code class="literal">edge-images.tar.gz</code>.</p><div id="id-1.8.4.5.10.4.4.3.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>If the <code class="literal">-i|--images</code> option is specified, the name of the archive may differ.</p></div></li><li class="listitem"><p>Copy this archive to your <span class="strong"><strong>air-gapped</strong></span> machine:</p><div class="verbatim-wrap highlight bash"><pre class="screen">scp edge-images.tar.gz &lt;user&gt;@&lt;machine_ip&gt;:/path</pre></div></li></ol></div></section><section class="sect4" id="id-create-the-edge-oci-chart-images-archive" data-id-title="Create the Edge OCI chart images archive"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.1.4 </span><span class="title-name">Create the Edge OCI chart images archive</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-create-the-edge-oci-chart-images-archive">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On a machine with internet access:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Make <code class="literal">edge-save-oci-artefacts.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-save-oci-artefacts.sh</pre></div></li><li class="listitem"><p>Generate the OCI chart image archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-save-oci-artefacts.sh --source-registry registry.suse.com</pre></div></li><li class="listitem"><p>This will create an archive named <code class="literal">oci-artefacts.tar.gz</code>.</p><div id="id-1.8.4.5.10.4.5.3.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>If the <code class="literal">-a|--archive</code> option is specified, the name of the archive may differ.</p></div></li><li class="listitem"><p>Copy this archive to your <span class="strong"><strong>air-gapped</strong></span> machine:</p><div class="verbatim-wrap highlight bash"><pre class="screen">scp oci-artefacts.tar.gz &lt;user&gt;@&lt;machine_ip&gt;:/path</pre></div></li></ol></div></section><section class="sect4" id="id-load-edge-release-images-to-your-air-gapped-machine" data-id-title="Load Edge release images to your air-gapped machine"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.1.5 </span><span class="title-name">Load Edge release images to your air-gapped machine</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-load-edge-release-images-to-your-air-gapped-machine">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On your air-gapped machine:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log into your private registry (if required):</p><div class="verbatim-wrap highlight bash"><pre class="screen">podman login &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt;</pre></div></li><li class="listitem"><p>Make <code class="literal">edge-load-images.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-load-images.sh</pre></div></li><li class="listitem"><p>Execute the script, passing the previously <span class="strong"><strong>copied</strong></span> <code class="literal">edge-images.tar.gz</code> archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-load-images.sh --source-registry registry.suse.com --registry &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt; --images edge-images.tar.gz</pre></div><div id="id-1.8.4.5.10.4.6.3.3.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This will load all images from the <code class="literal">edge-images.tar.gz</code>, retag and push them to the registry specified under the <code class="literal">--registry</code> option.</p></div></li></ol></div></section><section class="sect4" id="id-load-the-edge-oci-chart-images-to-your-air-gapped-machine" data-id-title="Load the Edge OCI chart images to your air-gapped machine"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.1.6 </span><span class="title-name">Load the Edge OCI chart images to your air-gapped machine</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-load-the-edge-oci-chart-images-to-your-air-gapped-machine">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><span class="emphasis"><em>On your air-gapped machine:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Log into your private registry (if required):</p><div class="verbatim-wrap highlight bash"><pre class="screen">podman login &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt;</pre></div></li><li class="listitem"><p>Make <code class="literal">edge-load-oci-artefacts.sh</code> executable:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x edge-load-oci-artefacts.sh</pre></div></li><li class="listitem"><p>Untar the copied <code class="literal">oci-artefacts.tar.gz</code> archive:</p><div class="verbatim-wrap highlight bash"><pre class="screen">tar -xvf oci-artefacts.tar.gz</pre></div></li><li class="listitem"><p>This will produce a directory with the naming template <code class="literal">edge-release-oci-tgz-&lt;date&gt;</code></p></li><li class="listitem"><p>Pass this directory to the <code class="literal">edge-load-oci-artefacts.sh</code> script to load the Edge OCI chart images to your private registry:</p><div id="id-1.8.4.5.10.4.7.3.5.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>This script assumes the <code class="literal">helm</code> CLI has been pre-installed on your environment. For Helm installation instructions, see <a class="link" href="https://helm.sh/docs/intro/install/" target="_blank">Installing Helm</a>.</p></div><div class="verbatim-wrap highlight bash"><pre class="screen">./edge-load-oci-artefacts.sh --archive-directory edge-release-oci-tgz-&lt;date&gt; --registry &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt; --source-registry registry.suse.com</pre></div></li></ol></div></section><section class="sect4" id="id-configure-your-private-registry-in-your-kubernetes-distribution" data-id-title="Configure your private registry in your Kubernetes distribution"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.1.7 </span><span class="title-name">Configure your private registry in your Kubernetes distribution</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-configure-your-private-registry-in-your-kubernetes-distribution">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>For RKE2, see <a class="link" href="https://docs.rke2.io/install/private_registry" target="_blank">Private Registry Configuration</a></p><p>For K3s, see <a class="link" href="https://docs.k3s.io/installation/private-registry" target="_blank">Private Registry Configuration</a></p></section></section><section class="sect3" id="management-day2-fleet-helm-upgrade-procedure" data-id-title="Upgrade procedure"><div class="titlepage"><div><div><div class="title-container"><h4 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2 </span><span class="title-name">Upgrade procedure</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure">#</a></h4><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section focuses on the following Helm upgrade procedure use-cases:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster" title="36.2.6.2.1. I have a new cluster and would like to deploy and manage an Edge Helm chart">Section 36.2.6.2.1, “I have a new cluster and would like to deploy and manage an Edge Helm chart”</a></p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-fleet-managed-chart" title="36.2.6.2.2. I would like to upgrade a Fleet managed Helm chart">Section 36.2.6.2.2, “I would like to upgrade a Fleet managed Helm chart”</a></p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart" title="36.2.6.2.3. I would like to upgrade a Helm chart deployed via EIB">Section 36.2.6.2.3, “I would like to upgrade a Helm chart deployed via EIB”</a></p></li></ol></div><div id="id-1.8.4.5.10.5.4" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Manually deployed Helm charts cannot be reliably upgraded. We suggest to redeploy the Helm chart using the <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster" title="36.2.6.2.1. I have a new cluster and would like to deploy and manage an Edge Helm chart">Section 36.2.6.2.1, “I have a new cluster and would like to deploy and manage an Edge Helm chart”</a> method.</p></div><section class="sect4" id="management-day2-fleet-helm-upgrade-procedure-new-cluster" data-id-title="I have a new cluster and would like to deploy and manage an Edge Helm chart"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.1 </span><span class="title-name">I have a new cluster and would like to deploy and manage an Edge Helm chart</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers how to:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-prepare" title="36.2.6.2.1.1. Prepare the fleet resources for your chart">Section 36.2.6.2.1.1, “Prepare the fleet resources for your chart”</a>.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-deploy" title="36.2.6.2.1.2. Deploy the fleet for your chart">Section 36.2.6.2.1.2, “Deploy the fleet for your chart”</a>.</p></li><li class="listitem"><p><a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-manage" title="36.2.6.2.1.3. Manage the deployed Helm chart">Section 36.2.6.2.1.3, “Manage the deployed Helm chart”</a>.</p></li></ol></div><section class="sect5" id="management-day2-fleet-helm-upgrade-procedure-new-cluster-prepare" data-id-title="Prepare the fleet resources for your chart"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.1.1 </span><span class="title-name">Prepare the fleet resources for your chart</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-prepare">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Acquire the chart’s Fleet resources from the Edge <a class="link" href="https://github.com/suse-edge/fleet-examples/releases" target="_blank">release</a> tag that you wish to use.</p></li><li class="listitem"><p>Navigate to the Helm chart fleet (<code class="literal">fleets/day2/chart-templates/&lt;chart&gt;</code>)</p></li><li class="listitem"><p><span class="strong"><strong>If you intend to use a GitOps workflow</strong></span>, copy the chart Fleet directory to the Git repository from where you will do GitOps.</p></li><li class="listitem"><p><span class="strong"><strong>Optionally</strong></span>, if the Helm chart requires configurations to its <span class="strong"><strong>values</strong></span>, edit the <code class="literal">.helm.values</code> configuration inside the <code class="literal">fleet.yaml</code> file of the copied directory.</p></li><li class="listitem"><p><span class="strong"><strong>Optionally</strong></span>, there may be use-cases where you need to add additional resources to your chart’s fleet so that it can better fit your environment. For information on how to enhance your Fleet directory, see <a class="link" href="https://fleet.rancher.io/gitrepo-content" target="_blank">Git Repository Contents</a>.</p></li></ol></div><div id="id-1.8.4.5.10.5.5.4.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>In some cases, the default timeout Fleet uses for Helm operations may be insufficient, resulting in the following error:</p><div class="verbatim-wrap highlight bash"><pre class="screen">failed pre-install: context deadline exceeded</pre></div><p>In such cases, add the <a class="link" href="https://fleet.rancher.io/ref-crds#helmoptions" target="_blank">timeoutSeconds</a> property under the <code class="literal">helm</code> configuration of your <code class="literal">fleet.yaml</code> file.</p></div><p>An <span class="strong"><strong>example</strong></span> for the <code class="literal">longhorn</code> helm chart would look like:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>User Git repository structure:</p><div class="verbatim-wrap highlight bash"><pre class="screen">&lt;user_repository_root&gt;
├── longhorn
│   └── fleet.yaml
└── longhorn-crd
    └── fleet.yaml</pre></div></li><li class="listitem"><p><code class="literal">fleet.yaml</code> content populated with user <code class="literal">Longhorn</code> data:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">defaultNamespace: longhorn-system

helm:
  # timeoutSeconds: 10
  releaseName: "longhorn"
  chart: "longhorn"
  repo: "https://charts.rancher.io/"
  version: "107.0.0+up1.9.1"
  takeOwnership: true
  # custom chart value overrides
  values:
    # Example for user provided custom values content
    defaultSettings:
      deletingConfirmationFlag: true

# https://fleet.rancher.io/bundle-diffs
diff:
  comparePatches:
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: engineimages.longhorn.io
    operations:
    - {"op":"remove", "path":"/status/conditions"}
    - {"op":"remove", "path":"/status/storedVersions"}
    - {"op":"remove", "path":"/status/acceptedNames"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: nodes.longhorn.io
    operations:
    - {"op":"remove", "path":"/status/conditions"}
    - {"op":"remove", "path":"/status/storedVersions"}
    - {"op":"remove", "path":"/status/acceptedNames"}
  - apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: volumes.longhorn.io
    operations:
    - {"op":"remove", "path":"/status/conditions"}
    - {"op":"remove", "path":"/status/storedVersions"}
    - {"op":"remove", "path":"/status/acceptedNames"}</pre></div><div id="id-1.8.4.5.10.5.5.4.5.2.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>These are just example values that are used to illustrate custom configurations over the <code class="literal">longhorn</code> chart. They should <span class="strong"><strong>NOT</strong></span> be treated as deployment guidelines for the <code class="literal">longhorn</code> chart.</p></div></li></ul></div></section><section class="sect5" id="management-day2-fleet-helm-upgrade-procedure-new-cluster-deploy" data-id-title="Deploy the fleet for your chart"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.1.2 </span><span class="title-name">Deploy the fleet for your chart</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-deploy">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>You can deploy the fleet for your chart by either using a GitRepo (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-deploy-gitrepo" title="36.2.6.2.1.2.1. GitRepo">Section 36.2.6.2.1.2.1, “GitRepo”</a>) or Bundle (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-deploy-bundle" title="36.2.6.2.1.2.2. Bundle">Section 36.2.6.2.1.2.2, “Bundle”</a>).</p><div id="id-1.8.4.5.10.5.5.5.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>While deploying your Fleet, if you get a <code class="literal">Modified</code> message, make sure to add a corresponding <code class="literal">comparePatches</code> entry to the Fleet’s <code class="literal">diff</code> section. For more information, see <a class="link" href="https://fleet.rancher.io/bundle-diffs" target="_blank">Generating Diffs to Ignore Modified GitRepos</a>.</p></div><section class="sect6" id="management-day2-fleet-helm-upgrade-procedure-new-cluster-deploy-gitrepo" data-id-title="GitRepo"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.1.2.1 </span><span class="title-name">GitRepo</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-deploy-gitrepo">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Fleet’s <a class="link" href="https://fleet.rancher.io/ref-gitrepo" target="_blank">GitRepo</a> resource holds information on how to access your chart’s Fleet resources and to which clusters it needs to apply those resources.</p><p>The <code class="literal">GitRepo</code> resource can be deployed through the <a class="link" href="https://ranchermanager.docs.rancher.com/v2.12/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">Rancher UI</a>, or manually, by <a class="link" href="https://fleet.rancher.io/tut-deployment" target="_blank">deploying</a> the resource to the <code class="literal">management cluster</code>.</p><p>Example <span class="strong"><strong>Longhorn</strong></span> <code class="literal">GitRepo</code> resource for <span class="strong"><strong>manual</strong></span> deployment:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: fleet.cattle.io/v1alpha1
kind: GitRepo
metadata:
  name: longhorn-git-repo
  namespace: fleet-local
spec:
  # If using a tag
  # revision: user_repository_tag
  #
  # If using a branch
  # branch: user_repository_branch
  paths:
  # As seen in the 'Prepare your Fleet resources' example
  - longhorn
  - longhorn-crd
  repo: user_repository_url</pre></div></section><section class="sect6" id="management-day2-fleet-helm-upgrade-procedure-new-cluster-deploy-bundle" data-id-title="Bundle"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.1.2.2 </span><span class="title-name">Bundle</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-deploy-bundle">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><a class="link" href="https://fleet.rancher.io/bundle-add" target="_blank">Bundle</a> resources hold the raw Kubernetes resources that need to be deployed by Fleet. Normally it is encouraged to use the <code class="literal">GitRepo</code> approach, but for use-cases where the environment is air-gapped and cannot support a local Git server, <code class="literal">Bundles</code> can help you in propagating your Helm chart Fleet to your target clusters.</p><p>A <code class="literal">Bundle</code> can be deployed either through the Rancher UI (<code class="literal">Continuous Delivery → Advanced → Bundles → Create from YAML</code>) or by manually deploying the <code class="literal">Bundle</code> resource in the correct Fleet namespace. For information about Fleet namespaces, see the upstream <a class="link" href="https://fleet.rancher.io/namespaces#gitrepos-bundles-clusters-clustergroups" target="_blank">documentation</a>.</p><p><code class="literal">Bundles</code> for Edge Helm charts can be created by utilizing Fleet’s <a class="link" href="https://fleet.rancher.io/bundle-add#convert-a-helm-chart-into-a-bundle" target="_blank">Convert a Helm Chart into a Bundle</a> approach.</p><p>Below you can find an example on how to create a <code class="literal">Bundle</code> resource from the <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/fleets/day2/chart-templates/longhorn/longhorn/fleet.yaml" target="_blank">longhorn</a> and <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/fleets/day2/chart-templates/longhorn/longhorn-crd/fleet.yaml" target="_blank">longhorn-crd</a> Helm chart fleet templates and manually deploy this bundle to your <code class="literal">management cluster</code>.</p><div id="id-1.8.4.5.10.5.5.5.5.6" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>To illustrate the workflow, the below example uses the <a class="link" href="https://github.com/suse-edge/fleet-examples" target="_blank">suse-edge/fleet-examples</a> directory structure.</p></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Navigate to the <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/fleets/day2/chart-templates/longhorn/longhorn/fleet.yaml" target="_blank">longhorn</a> Chart fleet template:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd fleets/day2/chart-templates/longhorn/longhorn</pre></div></li><li class="listitem"><p>Create a <code class="literal">targets.yaml</code> file that will instruct Fleet to which clusters it should deploy the Helm chart:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; targets.yaml &lt;&lt;EOF
targets:
# Match your local (management) cluster
- clusterName: local
EOF</pre></div><div id="id-1.8.4.5.10.5.5.5.5.7.2.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There are some use-cases where your local cluster could have a different name.</p><p>To retrieve your local cluster name, execute the command below:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get clusters.fleet.cattle.io -n fleet-local</pre></div></div></li><li class="listitem"><p>Convert the <code class="literal">Longhorn</code> Helm chart Fleet to a Bundle resource using the <a class="link" href="https://fleet.rancher.io/cli/fleet-cli/fleet" target="_blank">fleet-cli</a>.</p><div id="id-1.8.4.5.10.5.5.5.5.7.3.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Fleet’s CLI can be retrieved from their <a class="link" href="https://github.com/rancher/fleet/releases/tag/v0.13.1" target="_blank">release</a> <span class="strong"><strong>Assets</strong></span> page (<code class="literal">fleet-linux-amd64</code>).</p><p>For Mac users there is a <a class="link" href="https://formulae.brew.sh/formula/fleet-cli" target="_blank">fleet-cli</a> Homebrew Formulae.</p></div><div class="verbatim-wrap highlight bash"><pre class="screen">fleet apply --compress --targets-file=targets.yaml -n fleet-local -o - longhorn-bundle &gt; longhorn-bundle.yaml</pre></div></li><li class="listitem"><p>Navigate to the <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/fleets/day2/chart-templates/longhorn/longhorn-crd/fleet.yaml" target="_blank">longhorn-crd</a> Chart fleet template:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd fleets/day2/chart-templates/longhorn/longhorn-crd</pre></div></li><li class="listitem"><p>Create a <code class="literal">targets.yaml</code> file that will instruct Fleet to which clusters it should deploy the Helm chart:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; targets.yaml &lt;&lt;EOF
targets:
# Match your local (management) cluster
- clusterName: local
EOF</pre></div></li><li class="listitem"><p>Convert the <code class="literal">Longhorn CRD</code> Helm chart Fleet to a Bundle resource using the <a class="link" href="https://fleet.rancher.io/cli/fleet-cli/fleet" target="_blank">fleet-cli</a>.</p><div class="verbatim-wrap highlight bash"><pre class="screen">fleet apply --compress --targets-file=targets.yaml -n fleet-local -o - longhorn-crd-bundle &gt; longhorn-crd-bundle.yaml</pre></div></li><li class="listitem"><p>Deploy the <code class="literal">longhorn-bundle.yaml</code> and <code class="literal">longhorn-crd-bundle.yaml</code> files to your <code class="literal">management cluster</code>:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl apply -f longhorn-crd-bundle.yaml
kubectl apply -f longhorn-bundle.yaml</pre></div></li></ol></div><p>Following these steps will ensure that <code class="literal">SUSE Storage</code> is deployed on all of the specified management cluster.</p></section></section><section class="sect5" id="management-day2-fleet-helm-upgrade-procedure-new-cluster-manage" data-id-title="Manage the deployed Helm chart"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.1.3 </span><span class="title-name">Manage the deployed Helm chart</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-new-cluster-manage">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Once deployed with Fleet, for Helm chart upgrades, see <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-fleet-managed-chart" title="36.2.6.2.2. I would like to upgrade a Fleet managed Helm chart">Section 36.2.6.2.2, “I would like to upgrade a Fleet managed Helm chart”</a>.</p></section></section><section class="sect4" id="management-day2-fleet-helm-upgrade-procedure-fleet-managed-chart" data-id-title="I would like to upgrade a Fleet managed Helm chart"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.2 </span><span class="title-name">I would like to upgrade a Fleet managed Helm chart</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-fleet-managed-chart">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Determine the version to which you need to upgrade your chart so that it is compatible with the desired Edge release. Helm chart version per Edge release can be viewed from the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="53.1. Abstract">Section 53.1, “Abstract”</a>).</p></li><li class="listitem"><p>In your Fleet monitored Git repository, edit the Helm chart’s <code class="literal">fleet.yaml</code> file with the correct chart <span class="strong"><strong>version</strong></span> and <span class="strong"><strong>repository</strong></span> from the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="53.1. Abstract">Section 53.1, “Abstract”</a>).</p></li><li class="listitem"><p>After committing and pushing the changes to your repository, this will trigger an upgrade of the desired Helm chart</p></li></ol></div></section><section class="sect4" id="management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart" data-id-title="I would like to upgrade a Helm chart deployed via EIB"><div class="titlepage"><div><div><div class="title-container"><h5 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.3 </span><span class="title-name">I would like to upgrade a Helm chart deployed via EIB</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart">#</a></h5><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p><a class="xref" href="components-eib.html" title="Chapter 11. Edge Image Builder">Chapter 11, <em>Edge Image Builder</em></a> deploys Helm charts by creating a <code class="literal">HelmChart</code> resource and utilizing the <code class="literal">helm-controller</code> introduced by the <a class="link" href="https://docs.rke2.io/helm" target="_blank">RKE2</a>/<a class="link" href="https://docs.k3s.io/helm" target="_blank">K3s</a> Helm integration feature.</p><p>To ensure that a Helm chart deployed via <code class="literal">EIB</code> is successfully upgraded, users need to do an upgrade over the respective <code class="literal">HelmChart</code> resources.</p><p>Below you can find information on:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The general overview (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-overview" title="36.2.6.2.3.1. Overview">Section 36.2.6.2.3.1, “Overview”</a>) of the upgrade process.</p></li><li class="listitem"><p>The necessary upgrade steps (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-steps" title="36.2.6.2.3.2. Upgrade Steps">Section 36.2.6.2.3.2, “Upgrade Steps”</a>).</p></li><li class="listitem"><p>An example (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-example" title="36.2.6.2.3.3. Example">Section 36.2.6.2.3.3, “Example”</a>) showcasing a <a class="link" href="https://longhorn.io" target="_blank">Longhorn</a> chart upgrade using the explained method.</p></li><li class="listitem"><p>How to use the upgrade process with a different GitOps tool (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-third-party" title="36.2.6.2.3.4. Helm chart upgrade using a third-party GitOps tool">Section 36.2.6.2.3.4, “Helm chart upgrade using a third-party GitOps tool”</a>).</p></li></ul></div><section class="sect5" id="management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-overview" data-id-title="Overview"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.3.1 </span><span class="title-name">Overview</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-overview">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Helm charts that are deployed via <code class="literal">EIB</code> are upgraded through a <code class="literal">fleet</code> called <a class="link" href="https://github.com/suse-edge/fleet-examples/tree/release-3.4.0/fleets/day2/eib-charts-upgrader" target="_blank">eib-charts-upgrader</a>.</p><p>This <code class="literal">fleet</code> processes <span class="strong"><strong>user-provided</strong></span> data to <span class="strong"><strong>update</strong></span> a specific set of HelmChart resources.</p><p>Updating these resources triggers the <a class="link" href="https://github.com/k3s-io/helm-controller" target="_blank">helm-controller</a>, which <span class="strong"><strong>upgrades</strong></span> the Helm charts associated with the modified <code class="literal">HelmChart</code> resources.</p><p>The user is only expected to:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Locally <a class="link" href="https://helm.sh/docs/helm/helm_pull/" target="_blank">pull</a> the archives for each Helm chart that needs to be upgraded.</p></li><li class="listitem"><p>Pass these archives to the <a class="link" href="https://github.com/suse-edge/fleet-examples/blob/release-3.4.0/scripts/day2/generate-chart-upgrade-data.sh" target="_blank">generate-chart-upgrade-data.sh</a> <code class="literal">generate-chart-upgrade-data.sh</code> script, which will include the data from these archives to the <code class="literal">eib-charts-upgrader</code> fleet.</p></li><li class="listitem"><p>Deploy the <code class="literal">eib-charts-upgrader</code> fleet to their <code class="literal">management cluster</code>. This is done through either a <code class="literal">GitRepo</code> or <code class="literal">Bundle</code> resource.</p></li></ol></div><p>Once deployed, the <code class="literal">eib-charts-upgrader</code>, with the help of Fleet, will ship its resources to the desired management cluster.</p><p>These resources include:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>A set of <code class="literal">Secrets</code> holding the <span class="strong"><strong>user-provided</strong></span> Helm chart data.</p></li><li class="listitem"><p>A <code class="literal">Kubernetes Job</code> which will deploy a <code class="literal">Pod</code> that will mount the previously mentioned <code class="literal">Secrets</code> and based on them <a class="link" href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_patch/" target="_blank">patch</a> the corresponding HelmChart resources.</p></li></ol></div><p>As mentioned previously this will trigger the <code class="literal">helm-controller</code> which will perform the actual Helm chart upgrade.</p><p>Below you can find a diagram of the above description:</p><div class="informalfigure"><div class="mediaobject"><a href="images/fleet-day2-management-helm-eib-upgrade.png"><img src="images/fleet-day2-management-helm-eib-upgrade.png" width="100%" alt="fleet day2 management helm eib upgrade" title="fleet day2 management helm eib upgrade"/></a></div></div></section><section class="sect5" id="management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-steps" data-id-title="Upgrade Steps"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.3.2 </span><span class="title-name">Upgrade Steps</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-steps">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Clone the <code class="literal">suse-edge/fleet-examples</code> repository from the correct release <a class="link" href="https://github.com/suse-edge/fleet-examples/releases/tag/release-3.4.0" target="_blank">tag</a>.</p></li><li class="listitem"><p>Create a directory in which you will store the pulled Helm chart archive(s).</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir archives</pre></div></li><li class="listitem"><p>Inside of the newly created archive directory, <a class="link" href="https://helm.sh/docs/helm/helm_pull/" target="_blank">pull</a> the archive(s) for the Helm chart(s) you wish to upgrade:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd archives
helm pull [chart URL | repo/chartname]

# Alternatively if you want to pull a specific version:
# helm pull [chart URL | repo/chartname] --version 0.0.0</pre></div></li><li class="listitem"><p>From <span class="strong"><strong>Assets</strong></span> of the desired <a class="link" href="https://github.com/suse-edge/fleet-examples/releases/tag/release-3.4.0" target="_blank">release tag</a>, download the <code class="literal">generate-chart-upgrade-data.sh</code> script.</p></li><li class="listitem"><p>Execute the <code class="literal">generate-chart-upgrade-data.sh</code> script:</p><div class="verbatim-wrap highlight bash"><pre class="screen">chmod +x ./generate-chart-upgrade-data.sh

./generate-chart-upgrade-data.sh --archive-dir /foo/bar/archives/ --fleet-path /foo/bar/fleet-examples/fleets/day2/eib-charts-upgrader</pre></div><p>For each chart archive in the <code class="literal">--archive-dir</code> directory, the script generates a <code class="literal">Kubernetes Secret YAML</code> file containing the chart upgrade data and stores it in the <code class="literal">base/secrets</code> directory of the fleet specified by <code class="literal">--fleet-path</code>.</p><p>The <code class="literal">generate-chart-upgrade-data.sh</code> script also applies additional modifications to the fleet to ensure the generated <code class="literal">Kubernetes Secret YAML</code> files are correctly utilized by the workload deployed by the fleet.</p><div id="id-1.8.4.5.10.5.7.7.2.5.5" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Users should not make any changes over what the <code class="literal">generate-chart-upgrade-data.sh</code> script generates.</p></div></li></ol></div><p>The steps below depend on the environment that you are running:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>For an environment that supports GitOps (e.g. is non air-gapped, or is air-gapped, but allows for local Git server support):</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Copy the <code class="literal">fleets/day2/eib-charts-upgrader</code> Fleet to the repository that you will use for GitOps.</p><div id="id-1.8.4.5.10.5.7.7.4.1.2.1.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>Make sure that the Fleet includes the changes that have been made by the <code class="literal">generate-chart-upgrade-data.sh</code> script.</p></div></li><li class="listitem"><p>Configure a <code class="literal">GitRepo</code> resource that will be used to ship all the resources of the <code class="literal">eib-charts-upgrader</code> Fleet.</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>For <code class="literal">GitRepo</code> configuration and deployment through the Rancher UI, see <a class="link" href="https://ranchermanager.docs.rancher.com/v2.12/integrations-in-rancher/fleet/overview#accessing-fleet-in-the-rancher-ui" target="_blank">Accessing Fleet in the Rancher UI</a>.</p></li><li class="listitem"><p>For <code class="literal">GitRepo</code> manual configuration and deployment, see <a class="link" href="https://fleet.rancher.io/tut-deployment" target="_blank">Creating a Deployment</a>.</p></li></ol></div></li></ol></div></li><li class="listitem"><p>For an environment that does not support GitOps (e.g. is air-gapped and does not allow local Git server usage):</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>Download the <code class="literal">fleet-cli</code> binary from the <code class="literal">rancher/fleet</code> <a class="link" href="https://github.com/rancher/fleet/releases/tag/v0.13.1" target="_blank">release</a> page (<code class="literal">fleet-linux-amd64</code> for Linux). For Mac users, there is a Homebrew Formulae that can be used - <a class="link" href="https://formulae.brew.sh/formula/fleet-cli" target="_blank">fleet-cli</a>.</p></li><li class="listitem"><p>Navigate to the <code class="literal">eib-charts-upgrader</code> Fleet:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd /foo/bar/fleet-examples/fleets/day2/eib-charts-upgrader</pre></div></li><li class="listitem"><p>Create a <code class="literal">targets.yaml</code> file that will instruct Fleet where to deploy your resources:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; targets.yaml &lt;&lt;EOF
targets:
# To map the local(management) cluster
- clusterName: local
EOF</pre></div><div id="id-1.8.4.5.10.5.7.7.4.2.2.3.3" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>There are some use-cases where your <code class="literal">local</code> cluster could have a different name.</p><p>To retrieve your <code class="literal">local</code> cluster name, execute the command below:</p><div class="verbatim-wrap highlight bash"><pre class="screen">kubectl get clusters.fleet.cattle.io -n fleet-local</pre></div></div></li><li class="listitem"><p>Use the <code class="literal">fleet-cli</code> to convert the Fleet to a <code class="literal">Bundle</code> resource:</p><div class="verbatim-wrap highlight bash"><pre class="screen">fleet apply --compress --targets-file=targets.yaml -n fleet-local -o - eib-charts-upgrade &gt; bundle.yaml</pre></div><p>This will create a Bundle (<code class="literal">bundle.yaml</code>) that will hold all the templated resource from the <code class="literal">eib-charts-upgrader</code> Fleet.</p><p>For more information regarding the <code class="literal">fleet apply</code> command, see <a class="link" href="https://fleet.rancher.io/cli/fleet-cli/fleet_apply" target="_blank">fleet apply</a>.</p><p>For more information regarding converting Fleets to Bundles, see <a class="link" href="https://fleet.rancher.io/bundle-add#convert-a-helm-chart-into-a-bundle" target="_blank">Convert a Helm Chart into a Bundle</a>.</p></li><li class="listitem"><p>Deploy the <code class="literal">Bundle</code>. This can be done in one of two ways:</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>Through Rancher’s UI - Navigate to <span class="strong"><strong>Continuous Delivery → Advanced → Bundles → Create from YAML</strong></span> and either paste the <code class="literal">bundle.yaml</code> contents, or click the <code class="literal">Read from File</code> option and pass the file itself.</p></li><li class="listitem"><p>Manually - Deploy the <code class="literal">bundle.yaml</code> file manually inside of your <code class="literal">management cluster</code>.</p></li></ol></div></li></ol></div></li></ol></div><p>Executing these steps will result in a successfully deployed <code class="literal">GitRepo/Bundle</code> resource. The resource will be picked up by Fleet and its contents will be deployed onto the target clusters that the user has specified in the previous steps. For an overview of the process, refer to <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-overview" title="36.2.6.2.3.1. Overview">Section 36.2.6.2.3.1, “Overview”</a>.</p><p>For information on how to track the upgrade process, you can refer to <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-example" title="36.2.6.2.3.3. Example">Section 36.2.6.2.3.3, “Example”</a>.</p><div id="id-1.8.4.5.10.5.7.7.7" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>Once the chart upgrade has been successfully verified, remove the <code class="literal">Bundle/GitRepo</code> resource.</p><p>This will remove the no longer necessary upgrade resources from your <code class="literal">management</code> cluster, ensuring that no future version clashes might occur.</p></div></section><section class="sect5" id="management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-example" data-id-title="Example"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.3.3 </span><span class="title-name">Example</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-example">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><div id="id-1.8.4.5.10.5.7.8.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>The example below demonstrates how to upgrade a Helm chart deployed via <code class="literal">EIB</code> from one version to another on a <code class="literal">management</code> cluster. Note that the versions used in this example are <span class="strong"><strong>not</strong></span> recommendations. For version recommendations specific to an Edge release, refer to the release notes (<a class="xref" href="id-release-notes.html#release-notes" title="53.1. Abstract">Section 53.1, “Abstract”</a>).</p></div><p><span class="emphasis"><em>Use-case:</em></span></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A <code class="literal">management</code> cluster is running an older version of <a class="link" href="https://longhorn.io" target="_blank">Longhorn</a>.</p></li><li class="listitem"><p>The cluster has been deployed through EIB, using the following image definition <span class="emphasis"><em>snippet</em></span>:</p><div class="verbatim-wrap highlight yaml"><pre class="screen">kubernetes:
  helm:
    charts:
    - name: longhorn-crd
      repositoryName: rancher-charts
      targetNamespace: longhorn-system
      createNamespace: true
      version: 104.2.0+up1.7.1
      installationNamespace: kube-system
    - name: longhorn
      repositoryName: rancher-charts
      targetNamespace: longhorn-system
      createNamespace: true
      version: 104.2.0+up1.7.1
      installationNamespace: kube-system
    repositories:
    - name: rancher-charts
      url: https://charts.rancher.io/
...</pre></div></li><li class="listitem"><p><code class="literal">SUSE Storage</code> needs to be upgraded to a version that is compatible with the Edge 3.4 release. Meaning it needs to be upgraded to <code class="literal">107.0.0+up1.9.1</code>.</p></li><li class="listitem"><p>It is assumed that the <code class="literal">management cluster</code> is <span class="strong"><strong>air-gapped</strong></span>, without support for a local Git server and has a working Rancher setup.</p></li></ul></div><p>Follow the Upgrade Steps (<a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-steps" title="36.2.6.2.3.2. Upgrade Steps">Section 36.2.6.2.3.2, “Upgrade Steps”</a>):</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Clone the <code class="literal">suse-edge/fleet-example</code> repository from the <code class="literal">release-3.4.0</code> tag.</p><div class="verbatim-wrap highlight bash"><pre class="screen">git clone -b release-3.4.0 https://github.com/suse-edge/fleet-examples.git</pre></div></li><li class="listitem"><p>Create a directory where the <code class="literal">Longhorn</code> upgrade archive will be stored.</p><div class="verbatim-wrap highlight bash"><pre class="screen">mkdir archives</pre></div></li><li class="listitem"><p>Pull the desired <code class="literal">Longhorn</code> chart archive version:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># First add the Rancher Helm chart repository
helm repo add rancher-charts https://charts.rancher.io/

# Pull the Longhorn 1.9.1 CRD archive
helm pull rancher-charts/longhorn-crd --version 107.0.0+up1.9.1

# Pull the Longhorn 1.9.1 chart archive
helm pull rancher-charts/longhorn --version 107.0.0+up1.9.1</pre></div></li><li class="listitem"><p>Outside of the <code class="literal">archives</code> directory, download the <code class="literal">generate-chart-upgrade-data.sh</code> script from the <code class="literal">suse-edge/fleet-examples</code> release <a class="link" href="https://github.com/suse-edge/fleet-examples/releases/tag/release-3.4.0" target="_blank">tag</a>.</p></li><li class="listitem"><p>Directory setup should look similar to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">.
├── archives
|   ├── longhorn-107.0.0+up1.9.1.tgz
│   └── longhorn-crd-107.0.0+up1.9.1.tgz
├── fleet-examples
...
│   ├── fleets
│   │   ├── day2
|   |   |   ├── ...
│   │   │   ├── eib-charts-upgrader
│   │   │   │   ├── base
│   │   │   │   │   ├── job.yaml
│   │   │   │   │   ├── kustomization.yaml
│   │   │   │   │   ├── patches
│   │   │   │   │   │   └── job-patch.yaml
│   │   │   │   │   ├── rbac
│   │   │   │   │   │   ├── cluster-role-binding.yaml
│   │   │   │   │   │   ├── cluster-role.yaml
│   │   │   │   │   │   ├── kustomization.yaml
│   │   │   │   │   │   └── sa.yaml
│   │   │   │   │   └── secrets
│   │   │   │   │       ├── eib-charts-upgrader-script.yaml
│   │   │   │   │       └── kustomization.yaml
│   │   │   │   ├── fleet.yaml
│   │   │   │   └── kustomization.yaml
│   │   │   └── ...
│   └── ...
└── generate-chart-upgrade-data.sh</pre></div></li><li class="listitem"><p>Execute the <code class="literal">generate-chart-upgrade-data.sh</code> script:</p><div class="verbatim-wrap highlight bash"><pre class="screen"># First make the script executable
chmod +x ./generate-chart-upgrade-data.sh

# Then execute the script
./generate-chart-upgrade-data.sh --archive-dir ./archives --fleet-path ./fleet-examples/fleets/day2/eib-charts-upgrader</pre></div><p>The directory structure after the script execution should look similar to:</p><div class="verbatim-wrap highlight bash"><pre class="screen">.
├── archives
|   ├── longhorn-107.0.0+up1.9.1.tgz
│   └── longhorn-crd-107.0.0+up1.9.1.tgz
├── fleet-examples
...
│   ├── fleets
│   │   ├── day2
│   │   │   ├── ...
│   │   │   ├── eib-charts-upgrader
│   │   │   │   ├── base
│   │   │   │   │   ├── job.yaml
│   │   │   │   │   ├── kustomization.yaml
│   │   │   │   │   ├── patches
│   │   │   │   │   │   └── job-patch.yaml
│   │   │   │   │   ├── rbac
│   │   │   │   │   │   ├── cluster-role-binding.yaml
│   │   │   │   │   │   ├── cluster-role.yaml
│   │   │   │   │   │   ├── kustomization.yaml
│   │   │   │   │   │   └── sa.yaml
│   │   │   │   │   └── secrets
│   │   │   │   │       ├── eib-charts-upgrader-script.yaml
│   │   │   │   │       ├── kustomization.yaml
│   │   │   │   │       ├── longhorn-VERSION.yaml - secret created by the generate-chart-upgrade-data.sh script
│   │   │   │   │       └── longhorn-crd-VERSION.yaml - secret created by the generate-chart-upgrade-data.sh script
│   │   │   │   ├── fleet.yaml
│   │   │   │   └── kustomization.yaml
│   │   │   └── ...
│   └── ...
└── generate-chart-upgrade-data.sh</pre></div><p>The files changed in git should look like this:</p><div class="verbatim-wrap highlight bash"><pre class="screen">Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git restore &lt;file&gt;..." to discard changes in working directory)
	modified:   fleets/day2/eib-charts-upgrader/base/patches/job-patch.yaml
	modified:   fleets/day2/eib-charts-upgrader/base/secrets/kustomization.yaml

Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)
	fleets/day2/eib-charts-upgrader/base/secrets/longhorn-VERSION.yaml
	fleets/day2/eib-charts-upgrader/base/secrets/longhorn-crd-VERSION.yaml</pre></div></li><li class="listitem"><p>Create a <code class="literal">Bundle</code> for the <code class="literal">eib-charts-upgrader</code> Fleet:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>First, navigate to the Fleet itself:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd ./fleet-examples/fleets/day2/eib-charts-upgrader</pre></div></li><li class="listitem"><p>Then create a <code class="literal">targets.yaml</code> file:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cat &gt; targets.yaml &lt;&lt;EOF
targets:
- clusterName: local
EOF</pre></div></li><li class="listitem"><p>Then use the <code class="literal">fleet-cli</code> binary to convert the Fleet to a Bundle:</p><div class="verbatim-wrap highlight bash"><pre class="screen">fleet apply --compress --targets-file=targets.yaml -n fleet-local -o - eib-charts-upgrade &gt; bundle.yaml</pre></div></li></ol></div></li><li class="listitem"><p>Deploy the Bundle through the Rancher UI:</p><div class="figure" id="id-1.8.4.5.10.5.7.8.6.8.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_1.png"><img src="images/day2_helm_chart_upgrade_example_1.png" width="100%" alt="day2 helm chart upgrade example 1" title="day2 helm chart upgrade example 1"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 36.1: </span><span class="title-name">Deploy Bundle through Rancher UI </span></span><a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-1.8.4.5.10.5.7.8.6.8.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div><p>From here, select <span class="strong"><strong>Read from File</strong></span> and find the <code class="literal">bundle.yaml</code> file on your system.</p><p>This will auto-populate the <code class="literal">Bundle</code> inside of Rancher’s UI.</p><p>Select <span class="strong"><strong>Create</strong></span>.</p></li><li class="listitem"><p>After a successful deployment, your Bundle would look similar to:</p><div class="figure" id="id-1.8.4.5.10.5.7.8.6.9.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_2.png"><img src="images/day2_helm_chart_upgrade_example_2.png" width="100%" alt="day2 helm chart upgrade example 2" title="day2 helm chart upgrade example 2"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 36.2: </span><span class="title-name">Successfully deployed Bundle </span></span><a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-1.8.4.5.10.5.7.8.6.9.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li></ol></div><p>After the successful deployment of the <code class="literal">Bundle</code>, to monitor the upgrade process:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Verify the logs of the <code class="literal">Upgrade Pod</code>:</p><div class="informalfigure"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_3_management.png"><img src="images/day2_helm_chart_upgrade_example_3_management.png" width="100%" alt="day2 helm chart upgrade example 3 management" title="day2 helm chart upgrade example 3 management"/></a></div></div></li><li class="listitem"><p>Now verify the logs of the Pod created for the upgrade by the helm-controller:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>The Pod name will be with the following template - <code class="literal">helm-install-longhorn-&lt;random-suffix&gt;</code></p></li><li class="listitem"><p>The Pod will be in the namespace where the <code class="literal">HelmChart</code> resource was deployed. In our case this is <code class="literal">kube-system</code>.</p><div class="figure" id="id-1.8.4.5.10.5.7.8.8.2.2.2.2"><div class="figure-contents"><div class="mediaobject"><a href="images/day2_helm_chart_upgrade_example_4_management.png"><img src="images/day2_helm_chart_upgrade_example_4_management.png" width="100%" alt="day2 helm chart upgrade example 4 management" title="day2 helm chart upgrade example 4 management"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 36.3: </span><span class="title-name">Logs for successfully upgraded Longhorn chart </span></span><a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#id-1.8.4.5.10.5.7.8.8.2.2.2.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></li></ol></div></li><li class="listitem"><p>Verify that the <code class="literal">HelmChart</code> version has been updated by navigating to Rancher’s <code class="literal">HelmCharts</code> section (<code class="literal">More Resources → HelmCharts</code>). Select the namespace where the chart was deployed, for this example it would be <code class="literal">kube-system</code>.</p></li><li class="listitem"><p>Finally check that the Longhorn Pods are running.</p></li></ol></div><p>After making the above validations, it is safe to assume that the Longhorn Helm chart has been upgraded to the <code class="literal">107.0.0+up1.9.1</code> version.</p></section><section class="sect5" id="management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-third-party" data-id-title="Helm chart upgrade using a third-party GitOps tool"><div class="titlepage"><div><div><div class="title-container"><h6 class="title"><span class="title-number-name"><span class="title-number">36.2.6.2.3.4 </span><span class="title-name">Helm chart upgrade using a third-party GitOps tool</span></span> <a title="Permalink" class="permalink" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-third-party">#</a></h6><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>There might be use-cases where users would like to use this upgrade procedure with a GitOps workflow other than Fleet (e.g. <code class="literal">Flux</code>).</p><p>To produce the resources needed for the upgrade procedure, you can use the <code class="literal">generate-chart-upgrade-data.sh</code> script to populate the <code class="literal">eib-charts-upgrader</code> Fleet with the user provided data. For more information on how to do this, see <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-steps" title="36.2.6.2.3.2. Upgrade Steps">Section 36.2.6.2.3.2, “Upgrade Steps”</a>.</p><p>After you have the full setup, you can use <a class="link" href="https://kustomize.io" target="_blank">kustomize</a> to generate a full working solution that you can deploy in your cluster:</p><div class="verbatim-wrap highlight bash"><pre class="screen">cd /foo/bar/fleets/day2/eib-charts-upgrader

kustomize build .</pre></div><p>If you want to include the solution to your GitOps workflow, you can remove the <code class="literal">fleet.yaml</code> file and use what is left as a valid <code class="literal">Kustomize</code> setup. Just do not forget to first run the <code class="literal">generate-chart-upgrade-data.sh</code> script, so that it can populate the <code class="literal">Kustomize</code> setup with the data for the Helm charts that you wish to upgrade to.</p><p>To understand how this workflow is intended to be used, it can be beneficial to look at <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-overview" title="36.2.6.2.3.1. Overview">Section 36.2.6.2.3.1, “Overview”</a> and <a class="xref" href="day2-mgmt-cluster.html#management-day2-fleet-helm-upgrade-procedure-eib-deployed-chart-upgrade-steps" title="36.2.6.2.3.2. Upgrade Steps">Section 36.2.6.2.3.2, “Upgrade Steps”</a>.</p></section></section></section></section></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="day2-migration.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Chapter 35 </span>Edge 3.4 migration</span></a> </div><div><a class="pagination-link next" href="day2-downstream-clusters.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Chapter 37 </span>Downstream clusters</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="section"><a href="day2-mgmt-cluster.html#management-day2-upgrade-controller"><span class="title-number">36.1 </span><span class="title-name">Upgrade Controller</span></a></span></li><li><span class="section"><a href="day2-mgmt-cluster.html#management-day2-fleet"><span class="title-number">36.2 </span><span class="title-name">Fleet</span></a></span></li></ul></div><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter/X"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2025</span></div></div></footer></body></html>