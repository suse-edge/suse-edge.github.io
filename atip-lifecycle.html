<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>SUSE Edge Documentation | Lifecycle Actions</title><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"/>
<meta name="title" content="Lifecycle Actions"/>
<meta name="description" content="This section covers the lifecycle management actions of deployed ATIP clusters"/>
<meta name="book-title" content="SUSE Edge Documentation"/>
<meta name="chapter-title" content="Chapter 27. Lifecycle Actions"/>
<meta name="tracker-url" content="https://github.com/suse-edge/suse-edge.github.io/issues/new"/>
<meta name="tracker-type" content="gh"/>
<meta name="publisher" content="SUSE"/><meta property="og:title" content="Lifecycle Actions"/>
<meta property="og:description" content="This section covers the lifecycle management actions of dep…"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Lifecycle Actions"/>
<meta name="twitter:description" content="This section covers the lifecycle management actions of dep…"/>
<script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": ["TechArticle"],
    "image": "https://www.suse.com/assets/img/suse-white-logo-green.svg",
    
    "inLanguage": "en",
    

    "headline": "Lifecycle Actions",
  
    "description": "Lifecycle Actions",
      
    "author": [
      {
        "@type": "Corporation",
        "name": "SUSE Product &amp; Solution Documentation Team",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    ],
      
    "dateModified": "2024-04-05T00:00+02:00",
      

    "about": [
      
    ],
  
    "sameAs": [
          "https://www.facebook.com/SUSEWorldwide/about",
          "https://www.youtube.com/channel/UCHTfqIzPKz4f_dri36lAQGA",
          "https://twitter.com/SUSE",
          "https://www.linkedin.com/company/suse"
    ],
    "publisher": {
      "@type": "Corporation",
      "name": "SUSE",
      "url": "https://documentation.suse.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    }
  }</script>
<link rel="prev" href="atip-automated-provisioning.html" title="Chapter 26. Automated Provisioning with ZTP"/><link rel="next" href="id-appendix.html" title="Appendix A. Appendix"/><script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/script-purejs.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="wide offline js-off"><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">SUSE Edge Documentation</a><span> / </span><a class="crumb" href="id-product-documentation.html">Product Documentation</a><span> / </span><a class="crumb" href="atip-lifecycle.html">Lifecycle Actions</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title">SUSE Edge Documentation</div><ol><li><a href="id-suse-edge-documentation.html" class=" "><span class="title-number"> </span><span class="title-name">SUSE Edge Documentation</span></a></li><li><a href="id-quickstarts.html" class="has-children "><span class="title-number">I </span><span class="title-name">Quickstarts</span></a><ol><li><a href="quickstart-metal3.html" class=" "><span class="title-number">1 </span><span class="title-name">BMC automated deployments with Metal<sup>3</sup></span></a></li><li><a href="quickstart-elemental.html" class=" "><span class="title-number">2 </span><span class="title-name">Remote host onboarding with Elemental</span></a></li><li><a href="quickstart-eib.html" class=" "><span class="title-number">3 </span><span class="title-name">Standalone Clusters with Edge Image Builder</span></a></li></ol></li><li><a href="id-components-used-2.html" class="has-children "><span class="title-number">II </span><span class="title-name">Components Used</span></a><ol><li><a href="components-rancher.html" class=" "><span class="title-number">4 </span><span class="title-name">Rancher</span></a></li><li><a href="components-fleet.html" class=" "><span class="title-number">5 </span><span class="title-name">Fleet</span></a></li><li><a href="components-slmicro.html" class=" "><span class="title-number">6 </span><span class="title-name">SLE Micro</span></a></li><li><a href="components-metal3.html" class=" "><span class="title-number">7 </span><span class="title-name">Metal³</span></a></li><li><a href="components-eib.html" class=" "><span class="title-number">8 </span><span class="title-name">Edge Image Builder</span></a></li><li><a href="components-elemental.html" class=" "><span class="title-number">9 </span><span class="title-name">Elemental</span></a></li><li><a href="components-k3s.html" class=" "><span class="title-number">10 </span><span class="title-name">K3s</span></a></li><li><a href="components-rke2.html" class=" "><span class="title-number">11 </span><span class="title-name">RKE2</span></a></li><li><a href="components-longhorn.html" class=" "><span class="title-number">12 </span><span class="title-name">Longhorn</span></a></li><li><a href="components-neuvector.html" class=" "><span class="title-number">13 </span><span class="title-name">NeuVector</span></a></li><li><a href="components-metallb.html" class=" "><span class="title-number">14 </span><span class="title-name">MetalLB</span></a></li><li><a href="components-kubevirt.html" class=" "><span class="title-number">15 </span><span class="title-name">Edge Virtualization</span></a></li></ol></li><li><a href="id-how-to-guides.html" class="has-children "><span class="title-number">III </span><span class="title-name">How To Guides</span></a><ol><li><a href="guides-metallb-k3s.html" class=" "><span class="title-number">16 </span><span class="title-name">MetalLB on K3s (using L2)</span></a></li><li><a href="guides-metallb-kubernetes.html" class=" "><span class="title-number">17 </span><span class="title-name">MetalLB in front of the Kubernetes API server</span></a></li></ol></li><li><a href="id-third-party-integration.html" class="has-children "><span class="title-number">IV </span><span class="title-name">Third Party Integration</span></a><ol><li><a href="integrations-linkert.html" class=" "><span class="title-number">18 </span><span class="title-name">Using the Linkerd Service Mesh</span></a></li><li><a href="integrations-nats.html" class=" "><span class="title-number">19 </span><span class="title-name">NATS</span></a></li><li><a href="id-nvidia-gpus-on-sle-micro.html" class=" "><span class="title-number">20 </span><span class="title-name">NVIDIA GPU’s on SLE Micro</span></a></li></ol></li><li class="active"><a href="id-product-documentation.html" class="has-children you-are-here"><span class="title-number">V </span><span class="title-name">Product Documentation</span></a><ol><li><a href="atip.html" class=" "><span class="title-number">21 </span><span class="title-name">SUSE Adaptive Telco Infrastructure Platform (ATIP)</span></a></li><li><a href="atip-architecture.html" class=" "><span class="title-number">22 </span><span class="title-name">Concept &amp; Architecture</span></a></li><li><a href="atip-requirements.html" class=" "><span class="title-number">23 </span><span class="title-name">Requirements &amp; Assumptions</span></a></li><li><a href="atip-management-cluster.html" class=" "><span class="title-number">24 </span><span class="title-name">Setting up the Management Cluster</span></a></li><li><a href="atip-features.html" class=" "><span class="title-number">25 </span><span class="title-name">Telco Features Configuration</span></a></li><li><a href="atip-automated-provisioning.html" class=" "><span class="title-number">26 </span><span class="title-name">Automated Provisioning with ZTP</span></a></li><li><a href="atip-lifecycle.html" class=" you-are-here"><span class="title-number">27 </span><span class="title-name">Lifecycle Actions</span></a></li></ol></li><li><a href="id-appendix.html" class="has-children "><span class="title-number">A </span><span class="title-name">Appendix</span></a><ol><li><a href="id-appendix.html#id-terminology" class=" "><span class="title-number"> </span><span class="title-name">Terminology</span></a></li></ol></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="atip-lifecycle" data-id-title="Lifecycle Actions"><div class="titlepage"><div><div><div class="title-container"><h1 class="title"><span class="title-number-name"><span class="title-number">27 </span><span class="title-name">Lifecycle Actions</span></span> <a title="Permalink" class="permalink" href="atip-lifecycle.html#">#</a></h1><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>This section covers the lifecycle management actions of deployed ATIP clusters</p><section class="sect1" id="id-management-cluster-upgrades" data-id-title="Management cluster upgrades"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">27.1 </span><span class="title-name">Management cluster upgrades</span></span> <a title="Permalink" class="permalink" href="atip-lifecycle.html#id-management-cluster-upgrades">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Upgrading the management cluster there are different components that need to be upgraded. The following sections will cover the upgrade process for each of the components.</p><p><span class="strong"><strong>Update the Operating System</strong></span></p><p>SUSE releases new version of <code class="literal">SLE Micro</code> at regular intervals. To make it easy for customers to migrate to a new minor version and minimize downtime, SUSE supports migrating online while the system is running.
SLE Micro uses transactional updates to upgrade from one version to the next. This has the following advantages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The system is always in a defined state until the first RPM is updated.</p></li><li class="listitem"><p>Canceling is possible until the first RPM is updated.</p></li><li class="listitem"><p>Simple recovery if there is an error.</p></li><li class="listitem"><p>It is possible to do a “rollback” via system tools—no backup or restore needed.</p></li><li class="listitem"><p>Use of all active repositories.</p></li></ul></div><div class="verbatim-wrap"><pre class="screen">transactional-update</pre></div><p>In case you want to revert the migration, you can use the following command:</p><div class="verbatim-wrap"><pre class="screen">transactional-update rollback last</pre></div><div id="id-1.7.9.3.9" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>For more information about the update process, please check <a class="link" href="https://documentation.suse.com/sle-micro/5.5/html/SLE-Micro-all/sec-transactional-udate.html#sec-command-list" target="_blank">Transactional Update</a></p></div><p><span class="strong"><strong>Upgrade the RKE2 Cluster</strong></span></p><p>To upgrade <code class="literal">RKE2</code> from an older version you can re-run the installation script using the new version, for example:</p><div class="verbatim-wrap"><pre class="screen">curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION=vX.Y.Z+rke2rN sh -</pre></div><p>After that, just restart the <code class="literal">rke2-server</code> service:</p><div class="verbatim-wrap"><pre class="screen"># server nodes
systemctl restart rke2-server</pre></div><p>or the agent service:</p><div class="verbatim-wrap"><pre class="screen"># agent nodes
systemctl restart rke2-agent</pre></div><div id="id-1.7.9.3.17" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>For more information about the upgrade process, please refer to the <a class="link" href="https://docs.rke2.io/upgrade" target="_blank">RKE2 documentation</a></p></div><p><span class="strong"><strong>Upgrade the Rancher Prime</strong></span></p><p>To upgrade the <code class="literal">Rancher Prime</code> you can use the following command to update the helm repository cache, and fetch the latest chart to install Rancher from the helm chart repository:</p><div class="verbatim-wrap"><pre class="screen">helm repo update
helm fetch rancher-prime/rancher</pre></div><p>After that, the easy way to upgrade is to export your current configurations to a file, and then upgrade the Rancher Prime version using that previous file.
In case any change is required in the new version, the file can be edited before the upgrade.</p><div class="verbatim-wrap"><pre class="screen">helm get values rancher -n cattle-system -o yaml &gt; rancher-values.yaml
helm upgrade rancher rancher-prime/rancher \
  --namespace cattle-system \
  -f values.yaml \
  --version=2.x.y</pre></div><div id="id-1.7.9.3.23" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>For more information about the upgrade process, please refer to the <a class="link" href="https://ranchermanager.docs.rancher.com/getting-started/installation-and-upgrade/install-upgrade-on-a-kubernetes-cluster/upgrades" target="_blank">Upgrade Rancher Prime</a> documentation</p></div><p><span class="strong"><strong>Upgrade Metal<sup>3</sup></strong></span></p><p>To upgrade the <code class="literal">Metal<sup>3</sup></code> you can use the following command to update the helm repository cache, and fetch the latest chart to install <code class="literal">Metal<sup>3</sup></code> from the helm chart repository:</p><div class="verbatim-wrap"><pre class="screen">helm repo update
helm fetch suse-edge/metal3</pre></div><p>After that, the easy way to upgrade is to export your current configurations to a file, and then upgrade the <code class="literal">Metal<sup>3</sup></code> version using that previous file.
In case any change is required in the new version, the file can be edited before the upgrade.</p><div class="verbatim-wrap"><pre class="screen">helm get values metal3 -n metal3-system -o yaml &gt; metal3-values.yaml
helm upgrade metal3 suse-edge/metal3 \
  --namespace metal3-system \
  -f metal3-values.yaml \
  --version=0.7.0</pre></div></section><section class="sect1" id="id-downstream-cluster-upgrades" data-id-title="Downstream cluster upgrades"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">27.2 </span><span class="title-name">Downstream cluster upgrades</span></span> <a title="Permalink" class="permalink" href="atip-lifecycle.html#id-downstream-cluster-upgrades">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a></div></div></div></div></div><p>Upgrading the downstream clusters there are different components that need to be upgraded. The following sections will cover the upgrade process for each of the components.</p><p><span class="strong"><strong>Upgrade the Operating System</strong></span></p><p>For this process, check the following <a class="link" href="atip-automated-provisioning.xml#ztp-eib-edge-image" target="_blank">reference</a> to build the new image with a new operating system version.
With this new image generated by <code class="literal">EIB</code>, the next provision phase will use the new operating version provide.
In the following step, the new image will be used to upgrade the nodes.</p><p><span class="strong"><strong>Upgrade the RKE2 Cluster</strong></span></p><p>The changes required to upgrade the <code class="literal">RKE2</code> cluster using the automated workflow are the folloing:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Change the block <code class="literal">RKE2ControlPlane</code> in the <code class="literal">capi-provisioning-example.yaml</code> showed in the following <a class="link" href="atip-automated-provisioning.xml#ztp-single-node-provision" target="_blank">section</a></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Add the rollout strategy in the spec.</p></li><li class="listitem"><p>Change the version of the <code class="literal">RKE2</code> cluster to the new version replacing <code class="literal">${RKE2_NEW_VERSION}</code>.</p></li></ul></div></li></ul></div><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: controlplane.cluster.x-k8s.io/v1alpha1
kind: RKE2ControlPlane
metadata:
  name: single-node-cluster
  namespace: default
spec:
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: Metal3MachineTemplate
    name: single-node-cluster-controlplane
  replicas: 1
  serverConfig:
    cni: cilium
  rolloutStrategy:
    rollingUpdate:
      maxSurge: 0
  agentConfig:
    format: ignition
    additionalUserData:
      config: |
        variant: fcos
        version: 1.4.0
        systemd:
          units:
            - name: rke2-preinstall.service
              enabled: true
              contents: |
                [Unit]
                Description=rke2-preinstall
                Wants=network-online.target
                Before=rke2-install.service
                ConditionPathExists=!/run/cluster-api/bootstrap-success.complete
                [Service]
                Type=oneshot
                User=root
                ExecStartPre=/bin/sh -c "mount -L config-2 /mnt"
                ExecStart=/bin/sh -c "sed -i \"s/BAREMETALHOST_UUID/$(jq -r .uuid /mnt/openstack/latest/meta_data.json)/\" /etc/rancher/rke2/config.yaml"
                ExecStart=/bin/sh -c "echo \"node-name: $(jq -r .name /mnt/openstack/latest/meta_data.json)\" &gt;&gt; /etc/rancher/rke2/config.yaml"
                ExecStartPost=/bin/sh -c "umount /mnt"
                [Install]
                WantedBy=multi-user.target
    kubelet:
      extraArgs:
        - provider-id=metal3://BAREMETALHOST_UUID
    version: ${RKE2_NEW_VERSION}
    nodeName: "localhost.localdomain"</pre></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Change the block <code class="literal">Metal3MachineTemplate</code> in the <code class="literal">capi-provisioning-example.yaml</code> showed in the following <a class="link" href="atip-automated-provisioning.xml#ztp-single-node-provision" target="_blank">section</a>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Change the image name and checksum to the new version generated on the previous step.</p></li><li class="listitem"><p>Add the directive <code class="literal">nodeReuse</code> to <code class="literal">true</code> to avoid the creation of a new node.</p></li><li class="listitem"><p>Add the directive <code class="literal">automatedCleaningMode</code> to <code class="literal">metadata</code> in order to enable the automated cleaning for the node.</p></li></ul></div></li></ul></div><div class="verbatim-wrap highlight yaml"><pre class="screen">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: Metal3MachineTemplate
metadata:
  name: single-node-cluster-controlplane
  namespace: default
spec:
  nodeReuse: True
  template:
    spec:
      automatedCleaningMode: metadata
      dataTemplate:
        name: single-node-cluster-controlplane-template
      hostSelector:
        matchLabels:
          cluster-role: control-plane
      image:
        checksum: http://imagecache.local:8080/${NEW_IMAGE_GENERATED}.sha256
        checksumType: sha256
        format: raw
        url: http://imagecache.local:8080/${NEW_IMAGE_GENERATED}.raw</pre></div><p>After making these changes, the <code class="literal">capi-provisioning-example.yaml</code> file can be applied to the cluster using the following command:</p><div class="verbatim-wrap"><pre class="screen">kubectl apply -f capi-provisioning-example.yaml</pre></div></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="atip-automated-provisioning.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Chapter 26 </span>Automated Provisioning with ZTP</span></a> </div><div><a class="pagination-link next" href="id-appendix.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Appendix A </span>Appendix</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="section"><a href="atip-lifecycle.html#id-management-cluster-upgrades"><span class="title-number">27.1 </span><span class="title-name">Management cluster upgrades</span></a></span></li><li><span class="section"><a href="atip-lifecycle.html#id-downstream-cluster-upgrades"><span class="title-number">27.2 </span><span class="title-name">Downstream cluster upgrades</span></a></span></li></ul></div><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter/X"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2024</span></div></div></footer></body></html>