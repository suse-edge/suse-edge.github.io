"use strict";(self.webpackChunksuse_edge_docs=self.webpackChunksuse_edge_docs||[]).push([[3681],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=p(n),m=r,h=c["".concat(s,".").concat(m)]||c[m]||u[m]||l;return n?a.createElement(h,i(i({ref:t},d),{},{components:n})):a.createElement(h,i({ref:t},d))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[c]="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5426:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const l={sidebar_position:5,title:"MetalLB Service in front of the Kubernetes API server"},i="Intro",o={unversionedId:"quickstart/metallb-kube-api",id:"quickstart/metallb-kube-api",title:"MetalLB Service in front of the Kubernetes API server",description:"MetalLB in front of the Kubernetes API server",source:"@site/docs/quickstart/metallb-kube-api.md",sourceDirName:"quickstart",slug:"/quickstart/metallb-kube-api",permalink:"/docs/quickstart/metallb-kube-api",draft:!1,editUrl:"https://github.com/suse-edge/suse-edge.github.io/tree/main/docs/quickstart/metallb-kube-api.md",tags:[],version:"current",lastUpdatedBy:"Kristian Zhelyazkov",lastUpdatedAt:1691146626,formattedLastUpdatedAt:"Aug 4, 2023",sidebarPosition:5,frontMatter:{sidebar_position:5,title:"MetalLB Service in front of the Kubernetes API server"},sidebar:"docs",previous:{title:"MetalLB on K3s",permalink:"/docs/quickstart/metallb"},next:{title:"NATS on K3s",permalink:"/docs/quickstart/nats"}},s={},p=[{value:"MetalLB in front of the Kubernetes API server",id:"metallb-in-front-of-the-kubernetes-api-server",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Install K3s",id:"install-k3s",level:3},{value:"Configure existing K3s cluster",id:"configure-existing-k3s-cluster",level:3},{value:"Install MetalLB",id:"install-metallb",level:3},{value:"Install the Endpoint Copier Operator",id:"install-the-endpoint-copier-operator",level:3},{value:"Add control-plane nodes",id:"add-control-plane-nodes",level:3}],d={toc:p},c="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"intro"},"Intro"),(0,r.kt)("h2",{id:"metallb-in-front-of-the-kubernetes-api-server"},"MetalLB in front of the Kubernetes API server"),(0,r.kt)("p",null,"In this guide a MetalLB service will be used to expose the K3s API externally on an HA K3s cluster with 3 control-plane nodes.\nTo achieve this, a Kubernetes Service of type ",(0,r.kt)("inlineCode",{parentName:"p"},"LoadBalancer")," and Endpoints will be manually created. The Endpoints will keep the IPs of all control plane nodes available in the cluster.\nIn order for the Endpoint to be continuously synchronized with the events occurring in the cluster (adding/removing a node or a node goes offline), the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/suse-edge/endpoint-copier-operator"},"Endpoint Copier Operator")," will be deployed. The operator monitors the events happening in the default ",(0,r.kt)("inlineCode",{parentName:"p"},"kubernetes")," Endpoint and updates the managed one automatically to keep them in sync.\nSince the managed Service will be of type ",(0,r.kt)("inlineCode",{parentName:"p"},"LoadBalancer"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"MetalLB")," will assign it a static ",(0,r.kt)("inlineCode",{parentName:"p"},"ExternalIP"),". This ",(0,r.kt)("inlineCode",{parentName:"p"},"ExternalIP")," will be used in order to communicate with the API Server."),(0,r.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"3 hosts to deploy K3s on top. Hint ",(0,r.kt)("a",{parentName:"li",href:"https://suse-edge.github.io/docs/quickstart/slemicro-utm-aarch64"},"SLE Micro on OSX on Apple Silicon (UTM)")," can be used.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Ensure the hosts have different hostnames."))),(0,r.kt)("li",{parentName:"ul"},"At least 2 available IPs in the network (One for the Traefik and one for the managed service)."),(0,r.kt)("li",{parentName:"ul"},"Helm")),(0,r.kt)("h3",{id:"install-k3s"},"Install K3s"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"NOTE:")," In case you don't want a fresh cluster but want to use an already existing one, just skip this step and proceed to the next one."),(0,r.kt)("p",null,"First a free IP in the network must be reserved that will be used later for ",(0,r.kt)("inlineCode",{parentName:"p"},"ExternalIP")," of the managed Service."),(0,r.kt)("p",null,"SSH to the first host and install ",(0,r.kt)("inlineCode",{parentName:"p"},"K3s")," in cluster mode as:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Export the free IP mentioned above\nexport VIP_SERVICE_IP=<ip>\nexport INSTALL_K3S_SKIP_START=false\n\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --cluster-init --disable=servicelb --write-kubeconfig-mode=644 --tls-san=${VIP_SERVICE_IP} --tls-san=https://${VIP_SERVICE_IP}.sslip.io" K3S_TOKEN=foobar sh -\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"NOTE:")," Make sure that ",(0,r.kt)("inlineCode",{parentName:"p"},"--disable=servicelb")," flag is provided in the ",(0,r.kt)("inlineCode",{parentName:"p"},"k3s server")," command."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"NOTE:")," From now on, the commands should be run on the local machine."),(0,r.kt)("p",null,"In order to access the API server from outside, the IP of the K3s VM will be used."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Replace <node-ip> with the actual IP of the machine\nexport NODE_IP=<node-ip>\nscp ${NODE_IP}:/etc/rancher/k3s/k3s.yaml ~/.kube/config && sed -i '' \"s/127.0.0.1/${NODE_IP}/g\" ~/.kube/config && chmod 600 ~/.kube/config\n")),(0,r.kt)("h3",{id:"configure-existing-k3s-cluster"},"Configure existing K3s cluster"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"NOTE:")," This step is valid only if you want to use an existing K3s cluster."),(0,r.kt)("p",null,"To use an existing K3s cluster, the ",(0,r.kt)("inlineCode",{parentName:"p"},"servicelb")," lb should be disabled and also ",(0,r.kt)("inlineCode",{parentName:"p"},"tls-san")," flags modified."),(0,r.kt)("p",null,"In order to change the K3s flags, ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/systemd/system/k3s.service")," should be modified on all of the VMs in the cluster."),(0,r.kt)("p",null,"The flags should be inserted in the ",(0,r.kt)("inlineCode",{parentName:"p"},"ExecStart"),". For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Replace the <vip-service-ip> with the actual ip\nExecStart=/usr/local/bin/k3s \\\n    server \\\n        '--cluster-init' \\\n        '--write-kubeconfig-mode=644' \\\n        '--disable=servicelb' \\\n        '--tls-san=<vip-service-ip>' \\\n        '--tls-san=https://<vip-service-ip>.sslip.io' \\\n")),(0,r.kt)("p",null,"Then the following commands should be executed in order for K3S to load the new configurations:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl daemon-reload\nsystemctl restart k3s\n")),(0,r.kt)("h3",{id:"install-metallb"},"Install MetalLB"),(0,r.kt)("p",null,"To deploy ",(0,r.kt)("inlineCode",{parentName:"p"},"MetalLB"),", the ",(0,r.kt)("a",{parentName:"p",href:"https://suse-edge.github.io/docs/quickstart/metallb"},"MetalLB on K3s")," guide can be used."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"NOTE:")," Ensure that the IP addresses of the ",(0,r.kt)("inlineCode",{parentName:"p"},"ip-pool")," IPAddressPool do not overlap with the IP addresses previously selected for the ",(0,r.kt)("inlineCode",{parentName:"p"},"LoadBalancer")," service."),(0,r.kt)("p",null,"Create a separate ",(0,r.kt)("inlineCode",{parentName:"p"},"IpAddressPool")," that will be used only for the managed Service."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Export the VIP_SERVICE_IP on the local machine\n# Replace with the actual IP\nexport VIP_SERVICE_IP=<ip>\n\ncat <<-EOF | kubectl apply -f -\napiVersion: metallb.io/v1beta1\nkind: IPAddressPool\nmetadata:\n  name: kubernetes-vip-ip-pool\n  namespace: metallb-system\nspec:\n  addresses:\n  - ${VIP_SERVICE_IP}/32\n  serviceAllocation:\n    priority: 100\n    namespaces:\n      - default\nEOF\n\ncat <<-EOF | kubectl apply -f -\napiVersion: metallb.io/v1beta1\nkind: L2Advertisement\nmetadata:\n  name: ip-pool-l2-adv\n  namespace: metallb-system\nspec:\n  ipAddressPools:\n  - ip-pool\n  - kubernetes-vip-ip-pool\nEOF\n")),(0,r.kt)("h3",{id:"install-the-endpoint-copier-operator"},"Install the Endpoint Copier Operator"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo add endpoint-copier-operator https://suse-edge.github.io/endpoint-copier-operator\n\nhelm install --create-namespace -n endpoint-copier-operator endpoint-copier-operator endpoint-copier-operator/endpoint-copier-operator\n")),(0,r.kt)("p",null,"The command above will deploy three different resources in the cluster:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"endpoint-copier-operator")," operator Deployment with 2 replicas. One will be the leader and the other will take over the leader role if needed."),(0,r.kt)("li",{parentName:"ol"},"A Kubernetes service called ",(0,r.kt)("inlineCode",{parentName:"li"},"vip-kubernetes")," in the ",(0,r.kt)("inlineCode",{parentName:"li"},"default")," namespace that will be a copy of the ",(0,r.kt)("inlineCode",{parentName:"li"},"kubernetes")," Service but from type ",(0,r.kt)("inlineCode",{parentName:"li"},"LoadBalancer"),"."),(0,r.kt)("li",{parentName:"ol"},"An Endpoint resource called ",(0,r.kt)("inlineCode",{parentName:"li"},"vip-kubernetes")," in the ",(0,r.kt)("inlineCode",{parentName:"li"},"default")," namespace that will be a copy of the ",(0,r.kt)("inlineCode",{parentName:"li"},"kubernetes")," Endpoint.")),(0,r.kt)("p",null,"Verify that the ",(0,r.kt)("inlineCode",{parentName:"p"},"kubernetes-vip")," Service has the correct IP address:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get service kubernetes-vip -n default -o=jsonpath='{.status.loadBalancer.ingress[0].ip}'\n")),(0,r.kt)("p",null,"Ensure that the ",(0,r.kt)("inlineCode",{parentName:"p"},"kubernetes-vip")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"kubernetes")," Endpoints resources in the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," namespace point to the same IPs."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get endpoints kubernetes kubernetes-vip\n")),(0,r.kt)("p",null,"If everything is correct, the last thing left is to use the ",(0,r.kt)("inlineCode",{parentName:"p"},"VIP_SERVICE_IP")," in our ",(0,r.kt)("inlineCode",{parentName:"p"},"Kubeconfig"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sed -i '' \"s/${NODE_IP}/${VIP_SERVICE_IP}/g\" ~/.kube/config\n")),(0,r.kt)("p",null,"From now on, all the ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl")," will go through the ",(0,r.kt)("inlineCode",{parentName:"p"},"kubernetes-vip")," service."),(0,r.kt)("h3",{id:"add-control-plane-nodes"},"Add control-plane nodes"),(0,r.kt)("p",null,"To monitor the entire process, two more terminal tabs can be opened."),(0,r.kt)("p",null,"First terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"watch kubectl get nodes\n")),(0,r.kt)("p",null,"Second terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"watch kubectl get endpoints\n")),(0,r.kt)("p",null,"Now execute the commands below on the second and third nodes."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Export the VIP_SERVICE_IP in the VM\n# Replace with the actual IP\nexport VIP_SERVICE_IP=<ip>\nexport INSTALL_K3S_SKIP_START=false\n\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --server https://${VIP_SERVICE_IP}:6443 --disable=servicelb --write-kubeconfig-mode=644" K3S_TOKEN=foobar sh -\n')))}u.isMDXComponent=!0}}]);