<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-quickstart/k3s-on-slemicro">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">K3s on SLE Micro | SUSE Edge</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://suse-edge.github.io/img/suse-edge-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://suse-edge.github.io/img/suse-edge-social-card.jpg"><meta data-rh="true" property="og:url" content="https://suse-edge.github.io/quickstart/k3s-on-slemicro"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="K3s on SLE Micro | SUSE Edge"><meta data-rh="true" name="description" content="K3s"><meta data-rh="true" property="og:description" content="K3s"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://suse-edge.github.io/quickstart/k3s-on-slemicro"><link data-rh="true" rel="alternate" href="https://suse-edge.github.io/quickstart/k3s-on-slemicro" hreflang="en"><link data-rh="true" rel="alternate" href="https://suse-edge.github.io/quickstart/k3s-on-slemicro" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.082d3357.css">
<link rel="preload" href="/assets/js/runtime~main.eb702677.js" as="script">
<link rel="preload" href="/assets/js/main.6069bc20.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/edge-logo.svg" alt="SUSE Edge Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/edge-logo.svg" alt="SUSE Edge Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SUSE Edge site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/suse-edge/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/quickstart/slemicro-utm-aarch64">Quickstarts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/quickstart/slemicro-utm-aarch64">SLE Micro on OSX on Apple Silicon (UTM)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/quickstart/slemicro-virt-install-x86_64">SLE Micro on X86_64 on libvirt (virt-install)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/quickstart/k3s-on-slemicro">K3s on SLE Micro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/quickstart/elemental-utm-aarch64">Elemental on OSX on Apple Silicon (UTM)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/misc/slemicro-vs-slemicro-rancher">Miscellaneous</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/misc/slemicro-vs-slemicro-rancher">SLE Micro vs SLE Micro for Rancher</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/misc/rancher-disambiguation">Rancher portfolio disambiguation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/dev_howto/create-package-obs">Developer How-To</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/dev_howto/create-package-obs">Create a package (RPM or Container image) using OBS (openSUSE Build Service)</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Quickstarts</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">K3s on SLE Micro</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Intro</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="k3s">K3s<a href="#k3s" class="hash-link" aria-label="Direct link to K3s" title="Direct link to K3s">​</a></h2><p><a href="https://k3s.io/" target="_blank" rel="noopener noreferrer">K3s</a> is a highly available, certified Kubernetes distribution designed for production workloads in unattended, resource-constrained, remote locations or inside IoT appliances.</p><p>It is packaged as a single and small binary so installations and updates are fast and easy.</p><p>The installation procedure can be as simple as downloading the <code>k3s</code> binary and run it.
However, the prefered way is to use the install script as it creates and configures a service.</p><p>The script supports different installation parameters to customize K3s, including HA support, install control-plane nodes, dedicated etcd nodes, agents, etc.</p><p>Once installed, the parameters and flags can be modified, added or removed just by changing the systemd unit file or the config file and restarting the service. Neat!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="k3s-on-sle-micro">K3s on SLE Micro<a href="#k3s-on-sle-micro" class="hash-link" aria-label="Direct link to K3s on SLE Micro" title="Direct link to K3s on SLE Micro">​</a></h2><p>The installation scripts supports SLE Micro, it recognizes the underlying operating system, installs the <code>k3s-selinux</code> package using <code>transactional-updates</code> and creates the <code>k3s</code> or <code>k3s-agent</code> services.</p><p><strong>NOTE</strong>: On SLE Micro, the install script doesn&#x27;t start the <code>k3s</code> or <code>k3s-agent</code> service (ideally you should reboot the host once you run a transactional-update), but this can be override by using the <code>INSTALL_K3S_SKIP_START=false</code> environment variable.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="k3s-all-in-one">K3s all-in-one<a href="#k3s-all-in-one" class="hash-link" aria-label="Direct link to K3s all-in-one" title="Direct link to K3s all-in-one">​</a></h2><p>The simplest way to run K3s is an all-in-one server (not suited for production environments) is by running:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A few environment variables to tweak our installation can be used as well as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=&quot;server --cluster-init --write-kubeconfig-mode=644&quot; K3S_TOKEN=foobar sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://docs.k3s.io/installation/configuration#configuration-with-install-script" target="_blank" rel="noopener noreferrer">The settings can be specified either as environment variables, command line flags</a>, a <a href="https://docs.k3s.io/installation/configuration#configuration-file" target="_blank" rel="noopener noreferrer">configuration file</a>, or both, it is just a personal choice:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | sh -s - server --token foobar --cluster-init --write-kubeconfig-mode=644</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">write-kubeconfig-mode: &quot;0644&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-init: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token: &quot;foobar&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this example:</p><ul><li><code>write-kubeconfig-mode</code> is self explanatory (the default is 0600)</li><li><code>cluster-init</code> enables clustering by deploying an embedded etcd database</li><li><code>token</code> a random token is generated to be able to add nodes to the cluster, specifying it at installation time makes things easier as it is known upfront</li></ul><p>The <a href="https://docs.k3s.io/cli" target="_blank" rel="noopener noreferrer">official</a> documentation explains all the flags in detail.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-agents">Adding agents<a href="#adding-agents" class="hash-link" aria-label="Direct link to Adding agents" title="Direct link to Adding agents">​</a></h2><p>Adding an agent is as simple as running the install script with a few parameters, including the URL of the cluster as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | K3S_URL=https://myserver:6443 K3S_TOKEN=foobar sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="k3s-ha">K3s HA<a href="#k3s-ha" class="hash-link" aria-label="Direct link to K3s HA" title="Direct link to K3s HA">​</a></h2><p>The easiest way to run a K3s HA cluster is by installing a first node using the <code>--cluster-init</code> flag and then, start adding nodes.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># First node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=&quot;server --cluster-init --write-kubeconfig-mode=644&quot; K3S_TOKEN=foobar sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Rest of the nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=&quot;server --server https://myserver:6443 --write-kubeconfig-mode=644&quot; K3S_TOKEN=foobar sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Agent nodes can be added as well:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=&quot;agent --server https://myserver:6443&quot; K3S_TOKEN=foobar sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is what a cluster with 3 control-plane nodes and 2 agents look like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME   STATUS   ROLES                       AGE     VERSION        INTERNAL-IP       EXTERNAL-IP   OS-IMAGE                          KERNEL-VERSION                 CONTAINER-RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp01   Ready    control-plane,etcd,master   2m26s   v1.26.4+k3s1   192.168.205.99    &lt;none&gt;        SUSE Linux Enterprise Micro 5.4   5.14.21-150400.24.46-default   containerd://1.6.19-k3s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp02   Ready    control-plane,etcd,master   98s     v1.26.4+k3s1   192.168.205.100   &lt;none&gt;        SUSE Linux Enterprise Micro 5.4   5.14.21-150400.24.46-default   containerd://1.6.19-k3s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp03   Ready    control-plane,etcd,master   71s     v1.26.4+k3s1   192.168.205.101   &lt;none&gt;        SUSE Linux Enterprise Micro 5.4   5.14.21-150400.24.46-default   containerd://1.6.19-k3s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">w01    Ready    &lt;none&gt;                      63s     v1.26.4+k3s1   192.168.205.102   &lt;none&gt;        SUSE Linux Enterprise Micro 5.4   5.14.21-150400.24.46-default   containerd://1.6.19-k3s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">w02    Ready    &lt;none&gt;                      39s     v1.26.4+k3s1   192.168.205.103   &lt;none&gt;        SUSE Linux Enterprise Micro 5.4   5.14.21-150400.24.46-default   containerd://1.6.19-k3s1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="k3s-api-ha">K3s API HA<a href="#k3s-api-ha" class="hash-link" aria-label="Direct link to K3s API HA" title="Direct link to K3s API HA">​</a></h2><p>The previous section lacks an important detail, the Kubernetes API is served by the 3 control-plane nodes, but the API certificate is generated just for the first node. If the first node is down, the clients needs their API endpoint to be tweaked to point to another node (i.e.- for <code>kubectl</code>, using the <code>-s</code> flag or modifying the <code>kubeconfig</code> file) and the certificate won&#x27;t be accepted as it doesn&#x27;t contain the IP/hostname of that other node (it can be forced to be ignored using <code>--insecure-skip-tls-verify=true</code> for <code>kubectl</code> but that&#x27;s not a good practice).</p><p>Ideally a mechanism to expose the K3s API in a high availability scenario is required. This usually means running a load balancer outside of the K3s cluster to serve and redirect the requests to the K3s API endpoints, so if one of the servers fail, the load balancer will re-route the requests to the other ones. This solves the HA problem but it adds complexity as it requires an external service, which sometimes is not available (typically in non-cloud environments such as baremetal deployments).</p><p>One approach can be to run a self-contained solution involving <a href="http://kube-vip.io/" target="_blank" rel="noopener noreferrer">kube-vip</a> to expose the <a href="https://kube-vip.io/docs/usage/k3s/" target="_blank" rel="noopener noreferrer">K3s API</a> over a virtual IP (optionally including a load balancer as well). This solves the HA problem but the certificate can still be a problem... but K3s got you covered. By using the <code>--tls-san</code> flag at K3s installation time, a list of IPs and/or hostnames can be provided for the certificate to be included as Subject Alternative Names, meaning the K3s API will be happily served from those IPs/hostnames, and if those are the ones being served by the VIP, the solution is now HA and certificate-proof! Let&#x27;s see it in more detail in the next section.</p><p><strong>NOTE:</strong> kube-vip can be used also to expose Kubernetes services, but this is out of scope of this document.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vip-reservation">VIP reservation<a href="#vip-reservation" class="hash-link" aria-label="Direct link to VIP reservation" title="Direct link to VIP reservation">​</a></h3><p>The VIP needs to be an IP available in the same subnet than the one where the control plane hosts are running (this is technically not true for the VIP itself but for <a href="https://kube-vip.io/docs/about/architecture/#technologies" target="_blank" rel="noopener noreferrer">load-balancing</a>).</p><p><strong>NOTE:</strong> If you are using OSX to virtualize the SLE Micro OS where K3s is going to be installed, you can see the dhcp leases in the <code>/var/db/dhcpd_leases</code> file and the subnet range in the <code>/Library/Preferences/SystemConfiguration/com.apple.vmnet.plist</code> one. You can use a free IP in that range, but if you find a way to reserve an IP in that range, please open a GitHub issue or a pull request with instructions to do it!.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="k3s-installation---first-node">K3s installation - First node<a href="#k3s-installation---first-node" class="hash-link" aria-label="Direct link to K3s installation - First node" title="Direct link to K3s installation - First node">​</a></h3><p>The first step is to install K3s in HA and using the <code>--tls-san</code> flag as well. This flag can be repeated many times, so in this example will be used to add both the IP (<code>192.168.205.10</code> in this example) and the DNS name of the VIP (using <a href="https://sslip.io" target="_blank" rel="noopener noreferrer">sslip.io</a> as a poor&#x27;s man DNS):</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=&quot;server --cluster-init --write-kubeconfig-mode=644 --tls-san=192.168.205.10 --tls-san=https://192.168.205.10.sslip.io&quot; K3S_TOKEN=foobar sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The rest of the nodes will be installed after kube-vip as the server URL for them to join the cluster will be the VIP.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kube-vip-installation">Kube-vip installation<a href="#kube-vip-installation" class="hash-link" aria-label="Direct link to Kube-vip installation" title="Direct link to Kube-vip installation">​</a></h3><p>The official <a href="https://kube-vip.io/docs/usage/k3s/" target="_blank" rel="noopener noreferrer">kube-vip</a> documentation explains the steps in more detail, but essentially it means creating the required resource files for kube-vip to run (RBAC and a DaemonSet) and leveraging <a href="https://docs.k3s.io/installation/packaged-components#auto-deploying-manifests-addons" target="_blank" rel="noopener noreferrer">K3s auto-deploy</a> feature (aka. any manifest stored in a particular folder of the host <code>/var/lib/rancher/k3s/server/manifests</code> will be automatically deployed at the K3s service startup or when the file changes via something similar to <code>kubectl apply -f</code>) kube-vip will be executed.</p><p><strong>NOTE:</strong> In this case, the <code>--services</code> flag for kube-vip won&#x27;t be used.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export VIP=192.168.205.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cat &lt;&lt;- EOF &gt; /var/lib/rancher/k3s/server/manifests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: kube-vip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: system:kube-vip-role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - apiGroups: [&quot;&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources: [&quot;services&quot;, &quot;services/status&quot;, &quot;nodes&quot;, &quot;endpoints&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verbs: [&quot;list&quot;,&quot;get&quot;,&quot;watch&quot;, &quot;update&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - apiGroups: [&quot;coordination.k8s.io&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources: [&quot;leases&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verbs: [&quot;list&quot;, &quot;get&quot;, &quot;watch&quot;, &quot;update&quot;, &quot;create&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: system:kube-vip-binding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: system:kube-vip-role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- kind: ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: kube-vip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: DaemonSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/name: kube-vip-ds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/version: v0.5.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: kube-vip-ds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app.kubernetes.io/name: kube-vip-ds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app.kubernetes.io/name: kube-vip-ds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app.kubernetes.io/version: v0.5.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      affinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nodeAffinity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          requiredDuringSchedulingIgnoredDuringExecution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nodeSelectorTerms:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - key: node-role.kubernetes.io/master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                operator: Exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - key: node-role.kubernetes.io/control-plane</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                operator: Exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: vip_arp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: &quot;6443&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: vip_interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: vip_cidr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: &quot;32&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: cp_enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: cp_namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: vip_ddns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: &quot;false&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: vip_leaderelection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: vip_leaseduration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: &quot;5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: vip_renewdeadline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: &quot;3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: vip_retryperiod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: ${VIP}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: prometheus_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value: :2112</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - name: lb_enable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    value: &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image: ghcr.io/kube-vip/kube-vip:v0.5.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: kube-vip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          capabilities:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            add:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - NET_ADMIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - NET_RAW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hostNetwork: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceAccountName: kube-vip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tolerations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - effect: NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator: Exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - effect: NoExecute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator: Exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="k3s-installation---control-plane-nodes">K3s installation - Control-plane nodes<a href="#k3s-installation---control-plane-nodes" class="hash-link" aria-label="Direct link to K3s installation - Control-plane nodes" title="Direct link to K3s installation - Control-plane nodes">​</a></h3><p>Once kube-vip is in place, the rest of the control-plane nodes can be added to the cluster by pointing them to the VIP as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export VIP=192.168.205.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=&quot;server --server https://${VIP}:6443 --write-kubeconfig-mode=644&quot; K3S_TOKEN=foobar sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>NOTE:</strong> For a real HA scenario, it is required for <code>etcd</code> to have an odd number of nodes, so it would be required to add two more control plae nodes.</p><p>After a while, the nodes will join the cluster successfully and an HA cluster will be ready.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kubeconfig-tweaks">Kubeconfig tweaks<a href="#kubeconfig-tweaks" class="hash-link" aria-label="Direct link to Kubeconfig tweaks" title="Direct link to Kubeconfig tweaks">​</a></h3><p>The kubeconfig file that is generated as part of the installation has localhost as the Kubernetes API endpoint, so in order to use it from outside, it needs to be changed to the VIP as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">scp 192.168.205.10:/etc/rancher/k3s/k3s.yaml ~/.kube/config &amp;&amp; sed -i &#x27;&#x27; &#x27;s/127.0.0.1/192.168.205.10/g&#x27; ~/.kube/config &amp;&amp; chmod 600 ~/.kube/config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="k3s-installation---adding-agents">K3s installation - adding agents<a href="#k3s-installation---adding-agents" class="hash-link" aria-label="Direct link to K3s installation - adding agents" title="Direct link to K3s installation - adding agents">​</a></h3><p>Agents can be added as usual, pointing to the VIP address as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export VIP=192.168.205.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=&quot;agent --server https://${VIP}:6443&quot; K3S_TOKEN=foobar sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="final-picture">Final picture<a href="#final-picture" class="hash-link" aria-label="Direct link to Final picture" title="Direct link to Final picture">​</a></h3><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes -o jsonpath=&quot;{.items[*].status.addresses[?(@.type==&#x27;InternalIP&#x27;)].address}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.168.205.69 192.168.205.70 192.168.205.71 192.168.205.72 192.168.205.73%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cluster-info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kubernetes control plane is running at https://192.168.205.10:6443</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see, the control plane IP is the VIP and the nodes have their own IP. Sweet!</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/suse-edge/suse-edge.github.io/tree/main/docs/quickstart/k3s-on-slemicro.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/quickstart/slemicro-virt-install-x86_64"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">SLE Micro on X86_64 on libvirt (virt-install)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/quickstart/elemental-utm-aarch64"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Elemental on OSX on Apple Silicon (UTM)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#k3s" class="table-of-contents__link toc-highlight">K3s</a></li><li><a href="#k3s-on-sle-micro" class="table-of-contents__link toc-highlight">K3s on SLE Micro</a></li><li><a href="#k3s-all-in-one" class="table-of-contents__link toc-highlight">K3s all-in-one</a></li><li><a href="#adding-agents" class="table-of-contents__link toc-highlight">Adding agents</a></li><li><a href="#k3s-ha" class="table-of-contents__link toc-highlight">K3s HA</a></li><li><a href="#k3s-api-ha" class="table-of-contents__link toc-highlight">K3s API HA</a><ul><li><a href="#vip-reservation" class="table-of-contents__link toc-highlight">VIP reservation</a></li><li><a href="#k3s-installation---first-node" class="table-of-contents__link toc-highlight">K3s installation - First node</a></li><li><a href="#kube-vip-installation" class="table-of-contents__link toc-highlight">Kube-vip installation</a></li><li><a href="#k3s-installation---control-plane-nodes" class="table-of-contents__link toc-highlight">K3s installation - Control-plane nodes</a></li><li><a href="#kubeconfig-tweaks" class="table-of-contents__link toc-highlight">Kubeconfig tweaks</a></li><li><a href="#k3s-installation---adding-agents" class="table-of-contents__link toc-highlight">K3s installation - adding agents</a></li><li><a href="#final-picture" class="table-of-contents__link toc-highlight">Final picture</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">SUSE Edge</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/suse-edge" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 SUSE Edge team. All Rights Reserved. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.eb702677.js"></script>
<script src="/assets/js/main.6069bc20.js"></script>
</body>
</html>